<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../../../">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>neurocaps.analysis.cap &mdash; neurocaps 0.9.8 documentation</title>
      <link rel="stylesheet" type="text/css" href="../../../_static/pygments.css?v=80d5e7a1" />
      <link rel="stylesheet" type="text/css" href="../../../_static/css/theme.css?v=19f00094" />
      <link rel="stylesheet" type="text/css" href="../../../_static/plot_directive.css" />
      <link rel="stylesheet" type="text/css" href="../../../_static/custom.css?v=2c5bc8c0" />

  
  <!--[if lt IE 9]>
    <script src="../../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script src="../../../_static/jquery.js?v=5d32c60e"></script>
        <script src="../../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
        <script src="../../../_static/documentation_options.js?v=1a282f62"></script>
        <script src="../../../_static/doctools.js?v=9a2dae69"></script>
        <script src="../../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../../index.html" class="icon icon-home">
            neurocaps
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../../../installation.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../api.html">API</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">neurocaps</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../../index.html">Module code</a></li>
      <li class="breadcrumb-item active">neurocaps.analysis.cap</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for neurocaps.analysis.cap</h1><div class="highlight"><pre>
<span></span><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span><span class="o">,</span> <span class="nn">re</span><span class="o">,</span> <span class="nn">warnings</span>
<span class="kn">from</span> <span class="nn">kneed</span> <span class="kn">import</span> <span class="n">KneeLocator</span>
<span class="kn">from</span> <span class="nn">joblib</span> <span class="kn">import</span> <span class="n">cpu_count</span><span class="p">,</span> <span class="n">delayed</span><span class="p">,</span> <span class="n">Parallel</span>
<span class="kn">from</span> <span class="nn">sklearn.cluster</span> <span class="kn">import</span> <span class="n">KMeans</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Union</span><span class="p">,</span> <span class="n">Literal</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">Optional</span>
<span class="kn">from</span> <span class="nn">pathlib</span> <span class="kn">import</span> <span class="n">Path</span>
<span class="kn">from</span> <span class="nn">.._utils</span> <span class="kn">import</span> <span class="n">_CAPGetter</span><span class="p">,</span> <span class="n">_cap2statmap</span><span class="p">,</span> <span class="n">_check_kwargs</span><span class="p">,</span> <span class="n">_convert_pickle_to_dict</span><span class="p">,</span> <span class="n">_check_parcel_approach</span><span class="p">,</span> <span class="n">_run_kmeans</span>

<div class="viewcode-block" id="CAP">
<a class="viewcode-back" href="../../../generated/neurocaps.analysis.CAP.html#neurocaps.analysis.CAP">[docs]</a>
<span class="k">class</span> <span class="nc">CAP</span><span class="p">(</span><span class="n">_CAPGetter</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Co-Activation Patterns (CAPs) Class</span>

<span class="sd">    Initializes the CAPs (Co-activation Patterns) class.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">        parcel_approach: Dict[Dict]</span>
<span class="sd">            The approach used to parcellate BOLD images. This should be a nested dictionary with the first key being the atlas name. The subkeys should include:</span>

<span class="sd">            - &quot;nodes&quot;: A list of node names in the order of the label IDs in the parcellation.</span>
<span class="sd">            - &quot;regions&quot;: The regions or networks in the parcellation.</span>
<span class="sd">            - &quot;maps&quot;: Directory path to the location of the parcellation file.</span>

<span class="sd">            If the &quot;Schaefer&quot; or &quot;AAL&quot; option was used in the ``TimeSeriesExtractor`` class, you can initialize the ``TimeSeriesExtractor`` class with the `parcel_approach` </span>
<span class="sd">            that was initially used, then set this parameter to ``TimeSeriesExtractor.parcel_approach``. For this parameter, only &quot;Schaefer&quot;, &quot;AAL&quot;, and &quot;Custom&quot; are supported.</span>
<span class="sd">        n_clusters: Union[int, List[int]], default=5</span>
<span class="sd">            The number of clusters to use. Can be a single integer or a list of integers.</span>
<span class="sd">        cluster_selection_method: str, default=None</span>
<span class="sd">            Method to find the optimal number of clusters. Options are &quot;silhouette&quot; or &quot;elbow&quot;.</span>
<span class="sd">        groups: dict, default=None</span>
<span class="sd">            A mapping of group names to subject IDs. Each group contains subject IDs for separate CAP analysis. If None, CAPs are not separated by group.</span>

<span class="sd">    Notes for ``parcel_approach``</span>
<span class="sd">    -----------------------------</span>
<span class="sd">    If using a &quot;Custom&quot; parcellation approach, ensure each node in your dataset includes both left (lh) and right (rh) hemisphere versions. This function assumes that the background label is &quot;zero&quot;. </span>
<span class="sd">    Do not add a background label in the &quot;nodes&quot; or &quot;networks&quot; key; the zero index should correspond to the first ID that is not zero.</span>

<span class="sd">    Custom Key Structure:</span>
<span class="sd">    ---------------------</span>
<span class="sd">    - &#39;maps&#39;: Directory path containing necessary parcellation files. Ensure files are in a supported format (e.g., .nii for NIfTI files). For plotting purposes, this key is not required.</span>
<span class="sd">    - &#39;nodes&#39;: List of all node labels used in your study, arranged in the exact order they correspond to indices in your parcellation files. </span>
<span class="sd">        Each label should match the parcellation index it represents. For example, if the parcellation label &quot;1&quot; corresponds to the left hemisphere </span>
<span class="sd">        visual cortex area 1, then &quot;LH_Vis1&quot; should occupy the 0th index in this list. This ensures that data extraction and analysis accurately reflect the anatomical regions intended.</span>
<span class="sd">        For timeseries extraction, this key is not required.</span>
<span class="sd">    - &#39;regions&#39;: Dictionary defining major brain regions. Each region should list node indices under &quot;lh&quot; and &quot;rh&quot; to specify left and right hemisphere nodes. </span>
<span class="sd">    </span>
<span class="sd">    Example </span>
<span class="sd">    -------</span>
<span class="sd">    The provided example demonstrates setting up a custom parcellation containing nodes for the visual network (Vis) and hippocampus regions:</span>
<span class="sd">    ::</span>

<span class="sd">        parcel_approach = {&quot;Custom&quot;: {&quot;maps&quot;: &quot;/location/to/parcellation.nii.gz&quot;,</span>
<span class="sd">                                &quot;nodes&quot;: [&quot;LH_Vis1&quot;, &quot;LH_Vis2&quot;, &quot;LH_Hippocampus&quot;, &quot;RH_Vis1&quot;, &quot;RH_Vis2&quot;, &quot;RH_Hippocampus&quot;],</span>
<span class="sd">                                &quot;regions&quot;: {&quot;Vis&quot; : {&quot;lh&quot;: [0,1],</span>
<span class="sd">                                                    &quot;rh&quot;: [3,4]},</span>
<span class="sd">                                            &quot;Hippocampus&quot;: {&quot;lh&quot;: [2],</span>
<span class="sd">                                                            &quot;rh&quot;: [5]}}}}</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">parcel_approach</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Dict</span><span class="p">],</span> <span class="n">n_clusters</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">]]</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">cluster_selection_method</span><span class="p">:</span> <span class="nb">str</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">groups</span><span class="p">:</span> <span class="nb">dict</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="c1"># Ensure all unique values if n_clusters is a list</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_n_clusters</span> <span class="o">=</span> <span class="n">n_clusters</span> <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">n_clusters</span><span class="p">)</span> <span class="o">==</span> <span class="nb">int</span> <span class="k">else</span> <span class="nb">sorted</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">n_clusters</span><span class="p">)))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_cluster_selection_method</span> <span class="o">=</span> <span class="n">cluster_selection_method</span> 

        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">n_clusters</span><span class="p">)</span> <span class="o">==</span> <span class="nb">list</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_n_clusters</span> <span class="o">=</span>  <span class="bp">self</span><span class="o">.</span><span class="n">_n_clusters</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">if</span> <span class="nb">all</span><span class="p">([</span><span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_n_clusters</span><span class="p">)</span> <span class="o">==</span> <span class="nb">list</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_n_clusters</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">])</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">_n_clusters</span>
            <span class="c1"># Raise error if n_clusters is a list and no cluster selection method is specified</span>
            <span class="k">if</span> <span class="nb">all</span><span class="p">([</span><span class="nb">len</span><span class="p">(</span><span class="n">n_clusters</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cluster_selection_method</span><span class="o">==</span> <span class="kc">None</span><span class="p">]):</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;`cluster_selection_method` cannot be None since n_clusters is a list.&quot;</span><span class="p">)</span>

        <span class="c1"># Raise error if silhouette_method is requested when n_clusters is an integer</span>
        <span class="k">if</span> <span class="nb">all</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">_cluster_selection_method</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">,</span> <span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_n_clusters</span><span class="p">)</span> <span class="o">==</span> <span class="nb">int</span><span class="p">]):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;`cluster_selection_method` only valid if n_clusters is a range of unique integers.&quot;</span><span class="p">)</span>
       
        <span class="bp">self</span><span class="o">.</span><span class="n">_groups</span> <span class="o">=</span> <span class="n">groups</span>
        <span class="c1"># Raise error if self groups is not a dictionary </span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_groups</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_groups</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">dict</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;`groups` must be a dictionary where the keys are the group names and the items correspond to subject ids in the groups.&quot;</span><span class="p">)</span>
            
            <span class="k">for</span> <span class="n">group_name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_groups</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_groups</span><span class="p">[</span><span class="n">group_name</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">group_name</span><span class="si">}</span><span class="s2"> has zero subject ids.&quot;</span>
            
            <span class="c1"># Convert ids to strings</span>
            <span class="k">for</span> <span class="n">group</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_groups</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_groups</span><span class="p">[</span><span class="n">group</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">subj_id</span><span class="p">)</span> <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">subj_id</span><span class="p">,</span><span class="nb">str</span><span class="p">)</span> <span class="k">else</span> <span class="n">subj_id</span> <span class="k">for</span> <span class="n">subj_id</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_groups</span><span class="p">[</span><span class="n">group</span><span class="p">]]</span>
        
        <span class="n">valid_parcel_dict</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;Schaefer&quot;</span><span class="p">,</span> <span class="s2">&quot;AAL&quot;</span><span class="p">,</span> <span class="s2">&quot;Custom&quot;</span><span class="p">}</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">parcel_approach</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Only one parcellation approach can be selected from the following valid options: </span><span class="si">{</span><span class="n">valid_parcel_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span><span class="si">}</span><span class="s2">.</span><span class="se">\n</span><span class="s2">Example format of `parcel_approach`: </span><span class="si">{</span><span class="n">valid_parcel_dict</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">_parcel_approach</span> <span class="o">=</span> <span class="n">parcel_approach</span> 

<div class="viewcode-block" id="CAP.get_caps">
<a class="viewcode-back" href="../../../generated/neurocaps.analysis.CAP.html#neurocaps.analysis.CAP.get_caps">[docs]</a>
    <span class="k">def</span> <span class="nf">get_caps</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">subject_timeseries</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]],</span> <span class="nb">str</span><span class="p">],</span> <span class="n">runs</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">]]]</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">random_state</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> 
                 <span class="n">init</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">,</span> <span class="n">Literal</span><span class="p">[</span><span class="s2">&quot;k-means++&quot;</span><span class="p">,</span> <span class="s2">&quot;random&quot;</span><span class="p">]]</span><span class="o">=</span><span class="s2">&quot;k-means++&quot;</span><span class="p">,</span> <span class="n">n_init</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">Literal</span><span class="p">[</span><span class="s2">&quot;auto&quot;</span><span class="p">],</span><span class="nb">int</span><span class="p">]</span><span class="o">=</span><span class="s1">&#39;auto&#39;</span><span class="p">,</span> 
                 <span class="n">max_iter</span><span class="p">:</span> <span class="nb">int</span><span class="o">=</span><span class="mi">300</span><span class="p">,</span> <span class="n">tol</span><span class="p">:</span> <span class="nb">float</span><span class="o">=</span><span class="mf">0.0001</span><span class="p">,</span> <span class="n">algorithm</span><span class="p">:</span> <span class="n">Literal</span><span class="p">[</span><span class="s2">&quot;lloyd&quot;</span><span class="p">,</span> <span class="s2">&quot;elkan&quot;</span><span class="p">]</span><span class="o">=</span><span class="s2">&quot;lloyd&quot;</span><span class="p">,</span> <span class="n">show_figs</span><span class="p">:</span> <span class="nb">bool</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> 
                 <span class="n">output_dir</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Path</span><span class="p">]</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">standardize</span><span class="p">:</span> <span class="nb">bool</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">epsilon</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span><span class="nb">float</span><span class="p">]</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">n_cores</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Generate CAPs</span>

<span class="sd">        Concatenates the timeseries of each subject and performs k-means clustering on the concatenated data.</span>
<span class="sd">        </span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        subject_timeseries: Dict[str, Dict[str, np.ndarray]] or str</span>
<span class="sd">            Path of the pickle file containing the nested subject timeseries dictionary saved by the TimeSeriesExtractor class or</span>
<span class="sd">            the nested subject timeseries dictionary produced by the TimeseriesExtractor class. The first level of the nested dictionary must consist of the subject ID as a string, </span>
<span class="sd">            the second level must consist of the run numbers in the form of &#39;run-#&#39; (where # is the corresponding number of the run), and the last level must consist of the timeseries </span>
<span class="sd">            (as a numpy array) associated with that run.</span>
<span class="sd">        runs: int or list[int], default=None</span>
<span class="sd">            The run numbers to perform the CAPs analysis with. If None, all runs in the subject timeseries will be concatenated into a single dataframe and subjected to k-means clustering.</span>
<span class="sd">        random_state: int, default=None</span>
<span class="sd">            The random state to use for scikit&#39;s KMeans function.</span>
<span class="sd">        init: &quot;k-means++&quot;, &quot;random&quot;, or array, default=&quot;k-means++&quot;</span>
<span class="sd">            Method for choosing initial cluster centroid. Refer to scikit&#39;s KMeans documentation for more information.</span>
<span class="sd">        n_init: &quot;auto&quot; or int, default=&quot;auto&quot;</span>
<span class="sd">            Number of times KMeans is ran with different initial clusters. The model with lowest inertia from these runs will be selected.</span>
<span class="sd">            Refer to scikit&#39;s KMeans documentation for more information.</span>
<span class="sd">        max_iter: int, default=300</span>
<span class="sd">            Maximum number of iterations for a single run of KMeans.</span>
<span class="sd">        tol: float, default=1e-4,</span>
<span class="sd">            Stopping criterion if the change in inertia is below this value, assuming ``max_iter`` has not been reached.</span>
<span class="sd">        algorithm: &quot;lloyd or &quot;elkan&quot;, default=&quot;lloyd&quot;</span>
<span class="sd">            The type of algorithm to use. Refer to scikit&#39;s KMeans documentation for more information.</span>
<span class="sd">        show_figs: bool, default=False</span>
<span class="sd">            Display the plots of inertia scores for all groups if ``cluster_selection_method`` is set to &quot;elbow&quot;.</span>
<span class="sd">        output_dir: str, default=None</span>
<span class="sd">            Directory to save plot to if ``cluster_selection_method`` is set to &quot;elbow&quot;. The directory will be created if it does not exist.</span>
<span class="sd">        standardize: bool, default=True</span>
<span class="sd">            Whether to z-score the features of the concatenated timeseries data.</span>
<span class="sd">        epsilon: int or float, default=0</span>
<span class="sd">            A small number to add to the denominator when z-scoring for numerical stability.</span>
<span class="sd">        n_cores: int, default=None</span>
<span class="sd">            The number of CPU cores to use for multiprocessing, with joblib, to run multiple kmeans models if ``cluster_selection_method`` is not None. </span>
<span class="sd">        kwargs: Dict</span>
<span class="sd">            Dictionary to adjust certain parameters related to ``cluster_selection_method`` when set to &quot;elbow&quot;. Additional parameters include:</span>

<span class="sd">             - &quot;S&quot;: Adjusts the sensitivity of finding the elbow. Larger values are more conservative and less sensitive to small fluctuations. This package uses KneeLocator from the kneed package to identify the elbow. Default is 1.</span>
<span class="sd">             - &quot;dpi&quot;: Adjusts the dpi of the elbow plot. Default is 300.</span>
<span class="sd">             - &quot;figsize&quot;: Adjusts the size of the elbow plots.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        matplotlib.Figure</span>
<span class="sd">            An instance of a matplotlib figure.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">n_cores</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cluster_selection_method</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">n_cores</span> <span class="o">&gt;</span> <span class="n">cpu_count</span><span class="p">():</span> <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;More cores specified than available - Number of cores specified: </span><span class="si">{</span><span class="n">n_cores</span><span class="si">}</span><span class="s2">; Max cores available: </span><span class="si">{</span><span class="n">cpu_count</span><span class="p">()</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">n_cores</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span> <span class="bp">self</span><span class="o">.</span><span class="n">_n_cores</span> <span class="o">=</span> <span class="n">n_cores</span>
            <span class="k">else</span><span class="p">:</span> <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;`n_cores` must be an integer.&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">n_cores</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cluster_selection_method</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span> <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s2">&quot;Multiprocessing will not run since `cluster_selection_method` is None.&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_n_cores</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">if</span> <span class="n">runs</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">runs</span><span class="p">,</span><span class="nb">int</span><span class="p">):</span> <span class="n">runs</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">runs</span><span class="p">)</span>
    
        <span class="bp">self</span><span class="o">.</span><span class="n">_runs</span> <span class="o">=</span> <span class="n">runs</span> <span class="k">if</span> <span class="n">runs</span> <span class="k">else</span> <span class="s2">&quot;all&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_standardize</span> <span class="o">=</span> <span class="n">standardize</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_epsilon</span> <span class="o">=</span> <span class="n">epsilon</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">subject_timeseries</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="ow">and</span> <span class="s2">&quot;pkl&quot;</span> <span class="ow">in</span> <span class="n">subject_timeseries</span><span class="p">:</span> <span class="n">subject_timeseries</span> <span class="o">=</span> <span class="n">_convert_pickle_to_dict</span><span class="p">(</span><span class="n">pickle_file</span><span class="o">=</span><span class="n">subject_timeseries</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_concatenated_timeseries</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_concatenated_timeseries</span><span class="p">(</span><span class="n">subject_timeseries</span><span class="o">=</span><span class="n">subject_timeseries</span><span class="p">,</span> <span class="n">runs</span><span class="o">=</span><span class="n">runs</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cluster_selection_method</span> <span class="o">==</span> <span class="s2">&quot;silhouette&quot;</span><span class="p">:</span> 
            <span class="bp">self</span><span class="o">.</span><span class="n">_perform_silhouette_method</span><span class="p">(</span><span class="n">random_state</span><span class="o">=</span><span class="n">random_state</span><span class="p">,</span> <span class="n">init</span><span class="o">=</span><span class="n">init</span><span class="p">,</span> <span class="n">n_init</span><span class="o">=</span><span class="n">n_init</span><span class="p">,</span> <span class="n">max_iter</span><span class="o">=</span><span class="n">max_iter</span><span class="p">,</span> <span class="n">tol</span><span class="o">=</span><span class="n">tol</span><span class="p">,</span> <span class="n">algorithm</span><span class="o">=</span><span class="n">algorithm</span><span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cluster_selection_method</span> <span class="o">==</span> <span class="s2">&quot;elbow&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_perform_elbow_method</span><span class="p">(</span><span class="n">random_state</span><span class="o">=</span><span class="n">random_state</span><span class="p">,</span> <span class="n">show_figs</span><span class="o">=</span><span class="n">show_figs</span><span class="p">,</span> <span class="n">output_dir</span><span class="o">=</span><span class="n">output_dir</span><span class="p">,</span> <span class="n">init</span><span class="o">=</span><span class="n">init</span><span class="p">,</span> <span class="n">n_init</span><span class="o">=</span><span class="n">n_init</span><span class="p">,</span> 
                                       <span class="n">max_iter</span><span class="o">=</span><span class="n">max_iter</span><span class="p">,</span> <span class="n">tol</span><span class="o">=</span><span class="n">tol</span><span class="p">,</span> <span class="n">algorithm</span><span class="o">=</span><span class="n">algorithm</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_kmeans</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="k">for</span> <span class="n">group</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_groups</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_kmeans</span><span class="p">[</span><span class="n">group</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_kmeans</span><span class="p">[</span><span class="n">group</span><span class="p">]</span> <span class="o">=</span> <span class="n">KMeans</span><span class="p">(</span><span class="n">n_clusters</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_n_clusters</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="n">random_state</span><span class="p">,</span> <span class="n">init</span><span class="o">=</span><span class="n">init</span><span class="p">,</span> <span class="n">n_init</span><span class="o">=</span><span class="n">n_init</span><span class="p">,</span> <span class="n">max_iter</span><span class="o">=</span><span class="n">max_iter</span><span class="p">,</span> <span class="n">tol</span><span class="o">=</span><span class="n">tol</span><span class="p">,</span> <span class="n">algorithm</span><span class="o">=</span><span class="n">algorithm</span><span class="p">)</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_concatenated_timeseries</span><span class="p">[</span><span class="n">group</span><span class="p">])</span> 
            
        <span class="c1"># Create states dict   </span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_create_caps_dict</span><span class="p">()</span></div>

    
    <span class="k">def</span> <span class="nf">_perform_silhouette_method</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">random_state</span><span class="p">,</span> <span class="n">init</span><span class="p">,</span> <span class="n">n_init</span><span class="p">,</span> <span class="n">max_iter</span><span class="p">,</span> <span class="n">tol</span><span class="p">,</span> <span class="n">algorithm</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="c1"># Initialize attribute</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_silhouette_scores</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_optimal_n_clusters</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_kmeans</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="k">for</span> <span class="n">group</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_groups</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_silhouette_scores</span><span class="p">[</span><span class="n">group</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_n_cores</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">n_cluster</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_n_clusters</span><span class="p">:</span>
                    <span class="n">silhouette_dict</span> <span class="o">=</span> <span class="n">_run_kmeans</span><span class="p">(</span><span class="n">n_cluster</span><span class="o">=</span><span class="n">n_cluster</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="n">random_state</span><span class="p">,</span> <span class="n">init</span><span class="o">=</span><span class="n">init</span><span class="p">,</span> <span class="n">n_init</span><span class="o">=</span><span class="n">n_init</span><span class="p">,</span> <span class="n">max_iter</span><span class="o">=</span><span class="n">max_iter</span><span class="p">,</span> 
                                               <span class="n">tol</span><span class="o">=</span><span class="n">tol</span><span class="p">,</span> <span class="n">algorithm</span><span class="o">=</span><span class="n">algorithm</span><span class="p">,</span> <span class="n">concatenated_timeseries</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_concatenated_timeseries</span><span class="p">[</span><span class="n">group</span><span class="p">],</span> <span class="n">method</span><span class="o">=</span><span class="s2">&quot;elbow&quot;</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_silhouette_scores</span><span class="p">[</span><span class="n">group</span><span class="p">]</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">silhouette_dict</span><span class="p">)</span> 
            <span class="k">else</span><span class="p">:</span>
                <span class="k">with</span> <span class="n">Parallel</span><span class="p">(</span><span class="n">n_jobs</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_n_cores</span><span class="p">)</span> <span class="k">as</span> <span class="n">parallel</span><span class="p">:</span>             
                    <span class="n">outputs</span> <span class="o">=</span> <span class="n">parallel</span><span class="p">(</span><span class="n">delayed</span><span class="p">(</span><span class="n">_run_kmeans</span><span class="p">)(</span><span class="n">n_cluster</span><span class="p">,</span> <span class="n">random_state</span><span class="p">,</span> <span class="n">init</span><span class="p">,</span> <span class="n">n_init</span><span class="p">,</span> <span class="n">max_iter</span><span class="p">,</span> <span class="n">tol</span><span class="p">,</span> <span class="n">algorithm</span><span class="p">,</span> 
                                                                                <span class="bp">self</span><span class="o">.</span><span class="n">_concatenated_timeseries</span><span class="p">[</span><span class="n">group</span><span class="p">],</span> <span class="s2">&quot;silhouette&quot;</span><span class="p">)</span> <span class="k">for</span> <span class="n">n_cluster</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_n_clusters</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">output</span> <span class="ow">in</span> <span class="n">outputs</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_silhouette_scores</span><span class="p">[</span><span class="n">group</span><span class="p">]</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">output</span><span class="p">)</span>

            <span class="c1"># Get max score  </span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_optimal_n_clusters</span><span class="p">[</span><span class="n">group</span><span class="p">]</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_silhouette_scores</span><span class="p">[</span><span class="n">group</span><span class="p">],</span> <span class="n">key</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_silhouette_scores</span><span class="p">[</span><span class="n">group</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_kmeans</span><span class="p">[</span><span class="n">group</span><span class="p">]</span> <span class="o">=</span> <span class="n">KMeans</span><span class="p">(</span><span class="n">n_clusters</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_optimal_n_clusters</span><span class="p">[</span><span class="n">group</span><span class="p">],</span> <span class="n">random_state</span><span class="o">=</span><span class="n">random_state</span><span class="p">,</span> <span class="n">init</span><span class="o">=</span><span class="n">init</span><span class="p">,</span> <span class="n">n_init</span><span class="o">=</span><span class="n">n_init</span><span class="p">,</span> <span class="n">max_iter</span><span class="o">=</span><span class="n">max_iter</span><span class="p">,</span> <span class="n">tol</span><span class="o">=</span><span class="n">tol</span><span class="p">,</span> <span class="n">algorithm</span><span class="o">=</span><span class="n">algorithm</span><span class="p">)</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_concatenated_timeseries</span><span class="p">[</span><span class="n">group</span><span class="p">])</span> 
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Optimal cluster size for </span><span class="si">{</span><span class="n">group</span><span class="si">}</span><span class="s2"> is </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_optimal_n_clusters</span><span class="p">[</span><span class="n">group</span><span class="p">]</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>
        
    <span class="k">def</span> <span class="nf">_perform_elbow_method</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">random_state</span><span class="p">,</span> <span class="n">show_figs</span><span class="p">,</span> <span class="n">output_dir</span><span class="p">,</span> <span class="n">init</span><span class="p">,</span> <span class="n">n_init</span><span class="p">,</span> <span class="n">max_iter</span><span class="p">,</span> <span class="n">tol</span><span class="p">,</span> <span class="n">algorithm</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="c1"># Initialize attribute</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_inertia</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_optimal_n_clusters</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_kmeans</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="n">knee_dict</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">S</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;S&quot;</span><span class="p">]</span> <span class="k">if</span> <span class="s2">&quot;S&quot;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="k">else</span> <span class="mi">1</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">group</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_groups</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_inertia</span><span class="p">[</span><span class="n">group</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_n_cores</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">n_cluster</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_n_clusters</span><span class="p">:</span>
                    <span class="n">inertia_dict</span> <span class="o">=</span> <span class="n">_run_kmeans</span><span class="p">(</span><span class="n">n_cluster</span><span class="o">=</span><span class="n">n_cluster</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="n">random_state</span><span class="p">,</span> <span class="n">init</span><span class="o">=</span><span class="n">init</span><span class="p">,</span> <span class="n">n_init</span><span class="o">=</span><span class="n">n_init</span><span class="p">,</span> <span class="n">max_iter</span><span class="o">=</span><span class="n">max_iter</span><span class="p">,</span> 
                                               <span class="n">tol</span><span class="o">=</span><span class="n">tol</span><span class="p">,</span> <span class="n">algorithm</span><span class="o">=</span><span class="n">algorithm</span><span class="p">,</span> <span class="n">concatenated_timeseries</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_concatenated_timeseries</span><span class="p">[</span><span class="n">group</span><span class="p">],</span> <span class="n">method</span><span class="o">=</span><span class="s2">&quot;elbow&quot;</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_inertia</span><span class="p">[</span><span class="n">group</span><span class="p">]</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">inertia_dict</span><span class="p">)</span> 
            <span class="k">else</span><span class="p">:</span>
                <span class="k">with</span> <span class="n">Parallel</span><span class="p">(</span><span class="n">n_jobs</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_n_cores</span><span class="p">)</span> <span class="k">as</span> <span class="n">parallel</span><span class="p">:</span>
                    <span class="n">outputs</span> <span class="o">=</span> <span class="n">parallel</span><span class="p">(</span><span class="n">delayed</span><span class="p">(</span><span class="n">_run_kmeans</span><span class="p">)(</span><span class="n">n_cluster</span><span class="p">,</span> <span class="n">random_state</span><span class="p">,</span> <span class="n">init</span><span class="p">,</span> <span class="n">n_init</span><span class="p">,</span> <span class="n">max_iter</span><span class="p">,</span> 
                                                                                <span class="n">tol</span><span class="p">,</span> <span class="n">algorithm</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_concatenated_timeseries</span><span class="p">[</span><span class="n">group</span><span class="p">],</span> <span class="s2">&quot;elbow&quot;</span><span class="p">)</span> <span class="k">for</span> <span class="n">n_cluster</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_n_clusters</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">output</span> <span class="ow">in</span> <span class="n">outputs</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_inertia</span><span class="p">[</span><span class="n">group</span><span class="p">]</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">output</span><span class="p">)</span>
            
            <span class="c1"># Get optimal cluster size</span>
            <span class="n">kneedle</span> <span class="o">=</span> <span class="n">KneeLocator</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_inertia</span><span class="p">[</span><span class="n">group</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">()),</span> 
                                                        <span class="n">y</span><span class="o">=</span><span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_inertia</span><span class="p">[</span><span class="n">group</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">()),</span>
                                                        <span class="n">curve</span><span class="o">=</span><span class="s1">&#39;convex&#39;</span><span class="p">,</span>
                                                        <span class="n">direction</span><span class="o">=</span><span class="s1">&#39;decreasing&#39;</span><span class="p">,</span> <span class="n">S</span><span class="o">=</span><span class="n">knee_dict</span><span class="p">[</span><span class="s2">&quot;S&quot;</span><span class="p">])</span>
                
            <span class="bp">self</span><span class="o">.</span><span class="n">_optimal_n_clusters</span><span class="p">[</span><span class="n">group</span><span class="p">]</span> <span class="o">=</span> <span class="n">kneedle</span><span class="o">.</span><span class="n">elbow</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_optimal_n_clusters</span><span class="p">[</span><span class="n">group</span><span class="p">]:</span>
                 <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s2">&quot;No elbow detected so optimal cluster size is None. Try adjusting the sensitivity parameter, `S`, to increase or decrease sensitivity (higher values are less sensitive), expanding the list of clusters to test, or setting `cluster_selection_method` to &#39;sillhouette&#39;.&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_kmeans</span><span class="p">[</span><span class="n">group</span><span class="p">]</span> <span class="o">=</span> <span class="n">KMeans</span><span class="p">(</span><span class="n">n_clusters</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_optimal_n_clusters</span><span class="p">[</span><span class="n">group</span><span class="p">],</span> <span class="n">random_state</span><span class="o">=</span><span class="n">random_state</span><span class="p">,</span> <span class="n">init</span><span class="o">=</span><span class="n">init</span><span class="p">,</span> <span class="n">n_init</span><span class="o">=</span><span class="n">n_init</span><span class="p">,</span> <span class="n">max_iter</span><span class="o">=</span><span class="n">max_iter</span><span class="p">,</span> <span class="n">tol</span><span class="o">=</span><span class="n">tol</span><span class="p">,</span> <span class="n">algorithm</span><span class="o">=</span><span class="n">algorithm</span><span class="p">)</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_concatenated_timeseries</span><span class="p">[</span><span class="n">group</span><span class="p">])</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Optimal cluster size for </span><span class="si">{</span><span class="n">group</span><span class="si">}</span><span class="s2"> is </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_optimal_n_clusters</span><span class="p">[</span><span class="n">group</span><span class="p">]</span><span class="si">}</span><span class="s2">.</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

                <span class="k">if</span> <span class="n">show_figs</span> <span class="ow">or</span> <span class="n">output_dir</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span><span class="o">,</span> <span class="nn">os</span>

                    <span class="c1"># Defaults</span>
                    <span class="n">defaults</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;dpi&quot;</span><span class="p">:</span> <span class="mi">300</span><span class="p">,</span><span class="s2">&quot;figsize&quot;</span><span class="p">:</span> <span class="p">(</span><span class="mi">8</span><span class="p">,</span><span class="mi">6</span><span class="p">)}</span>

                    <span class="n">plot_dict</span> <span class="o">=</span> <span class="n">_check_kwargs</span><span class="p">(</span><span class="n">defaults</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
                    
                    <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="n">plot_dict</span><span class="p">[</span><span class="s2">&quot;figsize&quot;</span><span class="p">])</span>
                    <span class="n">inertia_values</span> <span class="o">=</span> <span class="p">[</span><span class="n">y</span> <span class="k">for</span> <span class="n">x</span><span class="p">,</span><span class="n">y</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_inertia</span><span class="p">[</span><span class="n">group</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">()]</span>
                    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_n_clusters</span><span class="p">,</span> <span class="n">inertia_values</span><span class="p">)</span>
                    <span class="n">plt</span><span class="o">.</span><span class="n">vlines</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_optimal_n_clusters</span><span class="p">[</span><span class="n">group</span><span class="p">],</span> <span class="n">plt</span><span class="o">.</span><span class="n">ylim</span><span class="p">()[</span><span class="mi">0</span><span class="p">],</span> <span class="n">plt</span><span class="o">.</span><span class="n">ylim</span><span class="p">()[</span><span class="mi">1</span><span class="p">],</span> 
                               <span class="n">linestyles</span><span class="o">=</span><span class="s2">&quot;--&quot;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;elbow&quot;</span><span class="p">)</span>
                    <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s2">&quot;best&quot;</span><span class="p">)</span>
                    <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;K&quot;</span><span class="p">)</span>
                    <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;Inertia&quot;</span><span class="p">)</span>
                    <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="n">group</span><span class="p">)</span>

                    <span class="k">if</span> <span class="n">output_dir</span><span class="p">:</span>
                        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">output_dir</span><span class="p">):</span> <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">output_dir</span><span class="p">)</span>
                        <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_dir</span><span class="p">,</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">group</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="s1">&#39;_&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">_elbow.png&quot;</span><span class="p">),</span> <span class="n">dpi</span><span class="o">=</span><span class="n">plot_dict</span><span class="p">[</span><span class="s2">&quot;dpi&quot;</span><span class="p">])</span>
                    
                    <span class="k">if</span> <span class="n">show_figs</span> <span class="o">==</span> <span class="kc">False</span><span class="p">:</span> <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
                    <span class="k">else</span><span class="p">:</span> <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_create_caps_dict</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="c1"># Initialize dictionary</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_caps</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">group</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_groups</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_caps</span><span class="p">[</span><span class="n">group</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_caps</span><span class="p">[</span><span class="n">group</span><span class="p">]</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="sa">f</span><span class="s2">&quot;CAP-</span><span class="si">{</span><span class="n">state_number</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">:</span> <span class="n">state_vector</span> <span class="k">for</span> <span class="n">state_number</span><span class="p">,</span> <span class="n">state_vector</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">([</span><span class="n">num</span> <span class="k">for</span> <span class="n">num</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_kmeans</span><span class="p">[</span><span class="n">group</span><span class="p">]</span><span class="o">.</span><span class="n">cluster_centers_</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span><span class="p">)],</span><span class="bp">self</span><span class="o">.</span><span class="n">_kmeans</span><span class="p">[</span><span class="n">group</span><span class="p">]</span><span class="o">.</span><span class="n">cluster_centers_</span><span class="p">)})</span>
    
    <span class="k">def</span> <span class="nf">_get_concatenated_timeseries</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">subject_timeseries</span><span class="p">,</span> <span class="n">runs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="c1"># Create dictionary for &quot;All Subjects&quot; if no groups are specified to reuse the same loop instead of having to create logic for grouped and non-grouped version of the same code</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_groups</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_groups</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;All Subjects&quot;</span><span class="p">:</span> <span class="p">[</span><span class="n">subject</span> <span class="k">for</span> <span class="n">subject</span> <span class="ow">in</span> <span class="n">subject_timeseries</span><span class="o">.</span><span class="n">keys</span><span class="p">()]}</span>

        <span class="n">concatenated_timeseries</span> <span class="o">=</span> <span class="p">{</span><span class="n">group</span><span class="p">:</span> <span class="p">{}</span> <span class="k">for</span> <span class="n">group</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_groups</span><span class="o">.</span><span class="n">keys</span><span class="p">()}</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_generate_lookup_table</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_mean_vec</span> <span class="o">=</span> <span class="p">{</span><span class="n">group</span><span class="p">:</span> <span class="p">{}</span> <span class="k">for</span> <span class="n">group</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_groups</span><span class="o">.</span><span class="n">keys</span><span class="p">()}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_stdev_vec</span> <span class="o">=</span> <span class="p">{</span><span class="n">group</span><span class="p">:</span> <span class="p">{}</span> <span class="k">for</span> <span class="n">group</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_groups</span><span class="o">.</span><span class="n">keys</span><span class="p">()}</span>

        <span class="k">for</span> <span class="n">subj_id</span><span class="p">,</span> <span class="n">group</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_subject_table</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">requested_runs</span> <span class="o">=</span> <span class="p">[</span><span class="sa">f</span><span class="s2">&quot;run-</span><span class="si">{</span><span class="n">run</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">for</span> <span class="n">run</span> <span class="ow">in</span> <span class="n">runs</span><span class="p">]</span> <span class="k">if</span> <span class="n">runs</span> <span class="k">else</span> <span class="n">subject_timeseries</span><span class="p">[</span><span class="n">subj_id</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
            <span class="n">subject_runs</span> <span class="o">=</span> <span class="p">[</span><span class="n">subject_run</span> <span class="k">for</span> <span class="n">subject_run</span> <span class="ow">in</span> <span class="n">subject_timeseries</span><span class="p">[</span><span class="n">subj_id</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="k">if</span> <span class="n">subject_run</span> <span class="ow">in</span> <span class="n">requested_runs</span><span class="p">]</span> 
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">subject_runs</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Skipping subject </span><span class="si">{</span><span class="n">subj_id</span><span class="si">}</span><span class="s2"> since they do not have the requested run numbers </span><span class="si">{</span><span class="s1">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">requested_runs</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">continue</span>
            <span class="k">for</span> <span class="n">curr_run</span> <span class="ow">in</span> <span class="n">subject_runs</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">concatenated_timeseries</span><span class="p">[</span><span class="n">group</span><span class="p">])</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">concatenated_timeseries</span><span class="p">[</span><span class="n">group</span><span class="p">]</span> <span class="o">=</span> <span class="n">subject_timeseries</span><span class="p">[</span><span class="n">subj_id</span><span class="p">][</span><span class="n">curr_run</span><span class="p">]</span> <span class="k">if</span> <span class="n">subj_id</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_groups</span><span class="p">[</span><span class="n">group</span><span class="p">]))</span> <span class="k">else</span> <span class="n">concatenated_timeseries</span><span class="p">[</span><span class="n">group</span><span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">concatenated_timeseries</span><span class="p">[</span><span class="n">group</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">([</span><span class="n">concatenated_timeseries</span><span class="p">[</span><span class="n">group</span><span class="p">],</span> <span class="n">subject_timeseries</span><span class="p">[</span><span class="n">subj_id</span><span class="p">][</span><span class="n">curr_run</span><span class="p">]])</span> <span class="k">if</span> <span class="n">subj_id</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_groups</span><span class="p">[</span><span class="n">group</span><span class="p">]))</span> <span class="k">else</span> <span class="n">concatenated_timeseries</span><span class="p">[</span><span class="n">group</span><span class="p">]</span>
        <span class="c1"># Standardize</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_standardize</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">group</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_groups</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_mean_vec</span><span class="p">[</span><span class="n">group</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">_stdev_vec</span><span class="p">[</span><span class="n">group</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">concatenated_timeseries</span><span class="p">[</span><span class="n">group</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">concatenated_timeseries</span><span class="p">[</span><span class="n">group</span><span class="p">],</span> <span class="n">ddof</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
                <span class="n">concatenated_timeseries</span><span class="p">[</span><span class="n">group</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">concatenated_timeseries</span><span class="p">[</span><span class="n">group</span><span class="p">]</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">_mean_vec</span><span class="p">[</span><span class="n">group</span><span class="p">])</span><span class="o">/</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_stdev_vec</span><span class="p">[</span><span class="n">group</span><span class="p">]</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">_epsilon</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">concatenated_timeseries</span>
    
    <span class="k">def</span> <span class="nf">_generate_lookup_table</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_subject_table</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">group</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_groups</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">subj_id</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_groups</span><span class="p">[</span><span class="n">group</span><span class="p">]:</span>
                <span class="k">if</span> <span class="n">subj_id</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_subject_table</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                    <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Subject: </span><span class="si">{</span><span class="n">subj_id</span><span class="si">}</span><span class="s2"> appears more than once, only including the first instance of this subject in the analysis.&quot;</span><span class="p">)</span> 
                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_subject_table</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="n">subj_id</span> <span class="p">:</span> <span class="n">group</span><span class="p">})</span>

<div class="viewcode-block" id="CAP.calculate_metrics">
<a class="viewcode-back" href="../../../generated/neurocaps.analysis.CAP.html#neurocaps.analysis.CAP.calculate_metrics">[docs]</a>
    <span class="k">def</span> <span class="nf">calculate_metrics</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">subject_timeseries</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]],</span> <span class="nb">str</span><span class="p">],</span> <span class="n">tr</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">runs</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="nb">int</span><span class="p">]]</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">continuous_runs</span><span class="p">:</span> <span class="nb">bool</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> 
                          <span class="n">metrics</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;temporal fraction&quot;</span><span class="p">,</span> <span class="s2">&quot;persistence&quot;</span><span class="p">,</span> <span class="s2">&quot;counts&quot;</span><span class="p">,</span> <span class="s2">&quot;transition frequency&quot;</span><span class="p">],</span> <span class="n">return_df</span><span class="p">:</span> <span class="nb">bool</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> 
                          <span class="n">output_dir</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Path</span><span class="p">]</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">file_name</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get CAPs metrics</span>

<span class="sd">        Creates a single pandas DataFrame containing CAP metrics for all participants, as described in Liu et al., 2018 and Yang et al., 2021. </span>
<span class="sd">        The metrics include:</span>

<span class="sd">        - &#39;temporal fraction&#39;: The proportion of total volumes spent in a single CAP over all volumes in a run.</span>
<span class="sd">        - &#39;persistence;: The average time spent in a single CAP before transitioning to another CAP (average consecutive/uninterrupted time).</span>
<span class="sd">        - &#39;counts&#39;: The frequency of each CAP observed in a run.</span>
<span class="sd">        - &#39;transition frequency&#39;: The number of switches between different CAPs across the entire run.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        subject_timeseries: Dict[str, Dict[str, np.ndarray]] or str</span>
<span class="sd">            Path of the pickle file containing the nested subject timeseries dictionary saved by the TimeSeriesExtractor class or</span>
<span class="sd">            the nested subject timeseries dictionary produced by the TimeseriesExtractor class. The first level of the nested dictionary must consist of the subject ID as a string, </span>
<span class="sd">            the second level must consist of the run numbers in the form of &#39;run-#&#39; (where # is the corresponding number of the run), and the last level must consist of the timeseries </span>
<span class="sd">            (as a numpy array) associated with that run.</span>
<span class="sd">        tr: float or None, default=None</span>
<span class="sd">            The repetition time (TR). If provided, persistence will be calculated as the average uninterrupted time spent in each CAP. </span>
<span class="sd">            If not provided, persistence will be calculated as the average uninterrupted volumes (TRs) spent in each state.</span>
<span class="sd">        runs: int or List[int], default=None</span>
<span class="sd">            The run numbers to calculate CAP metrics for. If None, CAP metrics will be calculated for each run.</span>
<span class="sd">        continuous_runs: bool, default=False</span>
<span class="sd">            If True, all runs will be treated as a single, uninterrupted run.</span>
<span class="sd">        metrics: str or List[str], default=[&quot;temporal fraction&quot;, &quot;persistence&quot;, &quot;counts&quot;, &quot;transition frequency&quot;]</span>
<span class="sd">            The metrics to calculate. Available options include &quot;temporal fraction&quot;, &quot;persistence&quot;, &quot;counts&quot;, and &quot;transition frequency&quot;.</span>
<span class="sd">        return_df: str, default=True</span>
<span class="sd">            If True, returns the dataframe</span>
<span class="sd">        output_dir: Path or None, default=None</span>
<span class="sd">            Directory to save dataframe to. The directory will be created if it does not exist. If None, dataframe will not be saved.</span>
<span class="sd">        file_name: str or None, default=None</span>
<span class="sd">            Will serve as a prefix to append to the saved file names for the dataframes, if ``output_dir`` is provided.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        Dict[str, pd.DataFrame]</span>
<span class="sd">            Dictionary containing pandas DataFrames - one for each requested metric.</span>

<span class="sd">        Note</span>
<span class="sd">        ----</span>
<span class="sd">        The presence of 0 for specific CAPs in the &quot;temporal fraction&quot;, &quot;persistence&quot;, or &quot;counts&quot; dataframes indicates that the participant had zero instances of a specific CAP.</span>

<span class="sd">        References</span>
<span class="sd">        ----------</span>
<span class="sd">        Liu, X., Zhang, N., Chang, C., &amp; Duyn, J. H. (2018). Co-activation patterns in resting-state fMRI signals. NeuroImage, 180, 485–494. https://doi.org/10.1016/j.neuroimage.2018.01.041</span>

<span class="sd">        Yang, H., Zhang, H., Di, X., Wang, S., Meng, C., Tian, L., &amp; Biswal, B. (2021). Reproducible coactivation patterns of functional brain networks reveal the aberrant dynamic state transition in schizophrenia. </span>
<span class="sd">        NeuroImage, 237, 118193. https://doi.org/10.1016/j.neuroimage.2021.118193</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">import</span> <span class="nn">collections</span><span class="o">,</span> <span class="nn">os</span><span class="o">,</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="s2">&quot;_kmeans&quot;</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">AttributeError</span><span class="p">(</span><span class="s2">&quot;Cannot calculate metrics since `self._kmeans` attribute does not exist. Run `self.get_caps()` first.&quot;</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="n">file_name</span> <span class="o">!=</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">output_dir</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span> <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s2">&quot;`file_name` supplied but no `output_dir` specified. Files will not be saved.&quot;</span><span class="p">)</span>

        <span class="n">metrics</span> <span class="o">=</span> <span class="p">[</span><span class="n">metrics</span><span class="p">]</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">metrics</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="k">else</span> <span class="n">metrics</span>

        <span class="n">valid_metrics</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;temporal fraction&quot;</span><span class="p">,</span> <span class="s2">&quot;persistence&quot;</span><span class="p">,</span> <span class="s2">&quot;counts&quot;</span><span class="p">,</span> <span class="s2">&quot;transition frequency&quot;</span><span class="p">]</span>

        <span class="n">boolean_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">element</span> <span class="ow">in</span> <span class="n">valid_metrics</span> <span class="k">for</span> <span class="n">element</span> <span class="ow">in</span> <span class="n">metrics</span><span class="p">]</span>

        <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">boolean_list</span><span class="p">):</span>
            <span class="n">invalid_metrics</span> <span class="o">=</span> <span class="p">[</span><span class="n">metrics</span><span class="p">[</span><span class="n">indx</span><span class="p">]</span> <span class="k">for</span> <span class="n">indx</span><span class="p">,</span><span class="n">boolean</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">boolean_list</span><span class="p">)</span> <span class="k">if</span> <span class="n">boolean</span> <span class="o">==</span> <span class="kc">False</span><span class="p">]</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">invalid_metrics</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;invalid metrics will be ignored: </span><span class="si">{</span><span class="s1">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">invalid_metrics</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;No valid metrics in `metrics` list. Valid metrics are </span><span class="si">{</span><span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">valid_metrics</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">subject_timeseries</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="ow">and</span> <span class="s2">&quot;pkl&quot;</span> <span class="ow">in</span> <span class="n">subject_timeseries</span><span class="p">:</span> <span class="n">subject_timeseries</span> <span class="o">=</span> <span class="n">_convert_pickle_to_dict</span><span class="p">(</span><span class="n">pickle_file</span><span class="o">=</span><span class="n">subject_timeseries</span><span class="p">)</span>

        <span class="n">group_cap_dict</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="c1"># Get group with most CAPs</span>
        <span class="k">for</span> <span class="n">group</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_groups</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="n">group_cap_dict</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="n">group</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_caps</span><span class="p">[</span><span class="n">group</span><span class="p">])})</span>
        
        <span class="n">cap_names</span> <span class="o">=</span>  <span class="bp">self</span><span class="o">.</span><span class="n">_caps</span><span class="p">[</span><span class="nb">max</span><span class="p">(</span><span class="n">group_cap_dict</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="n">group_cap_dict</span><span class="o">.</span><span class="n">get</span><span class="p">)]</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
        <span class="n">cap_numbers</span> <span class="o">=</span> <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">name</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;-&quot;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span> <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">cap_names</span><span class="p">]</span>

        <span class="c1"># Assign each subject TRs to CAP</span>
        <span class="n">predicted_subject_timeseries</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="k">for</span> <span class="n">subj_id</span><span class="p">,</span> <span class="n">group</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_subject_table</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">predicted_subject_timeseries</span><span class="p">[</span><span class="n">subj_id</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="n">requested_runs</span> <span class="o">=</span> <span class="p">[</span><span class="sa">f</span><span class="s2">&quot;run-</span><span class="si">{</span><span class="n">run</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">for</span> <span class="n">run</span> <span class="ow">in</span> <span class="n">runs</span><span class="p">]</span> <span class="k">if</span> <span class="n">runs</span> <span class="k">else</span> <span class="n">subject_timeseries</span><span class="p">[</span><span class="n">subj_id</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
            <span class="n">subject_runs</span> <span class="o">=</span> <span class="p">[</span><span class="n">subject_run</span> <span class="k">for</span> <span class="n">subject_run</span> <span class="ow">in</span> <span class="n">subject_timeseries</span><span class="p">[</span><span class="n">subj_id</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="k">if</span> <span class="n">subject_run</span> <span class="ow">in</span> <span class="n">requested_runs</span><span class="p">]</span> 
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">subject_runs</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Skipping subject </span><span class="si">{</span><span class="n">subj_id</span><span class="si">}</span><span class="s2"> since they do not have the requested run numbers </span><span class="si">{</span><span class="s1">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">requested_runs</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">continue</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">continuous_runs</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">requested_runs</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">curr_run</span> <span class="ow">in</span> <span class="n">subject_runs</span><span class="p">:</span>
                        <span class="n">timeseries</span> <span class="o">=</span> <span class="p">(</span><span class="n">subject_timeseries</span><span class="p">[</span><span class="n">subj_id</span><span class="p">][</span><span class="n">curr_run</span><span class="p">]</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">_mean_vec</span><span class="p">[</span><span class="n">group</span><span class="p">])</span><span class="o">/</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_stdev_vec</span><span class="p">[</span><span class="n">group</span><span class="p">]</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">_epsilon</span><span class="p">)</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_standardize</span> <span class="k">else</span> <span class="n">subject_timeseries</span><span class="p">[</span><span class="n">subj_id</span><span class="p">][</span><span class="n">curr_run</span><span class="p">]</span> 
                        <span class="n">predicted_subject_timeseries</span><span class="p">[</span><span class="n">subj_id</span><span class="p">]</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="n">curr_run</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_kmeans</span><span class="p">[</span><span class="n">group</span><span class="p">]</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">timeseries</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">})</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">subject_runs</span> <span class="o">=</span> <span class="s2">&quot;Continuous Runs&quot;</span>
                <span class="n">timeseries</span> <span class="o">=</span> <span class="p">{</span><span class="n">subject_runs</span><span class="p">:</span> <span class="p">{}}</span>
                <span class="k">for</span> <span class="n">curr_run</span> <span class="ow">in</span> <span class="n">subject_timeseries</span><span class="p">[</span><span class="n">subj_id</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                    <span class="n">timeseries</span><span class="p">[</span><span class="n">subject_runs</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">([</span><span class="n">timeseries</span><span class="p">[</span><span class="n">subject_runs</span><span class="p">],</span> <span class="n">subject_timeseries</span><span class="p">[</span><span class="n">subj_id</span><span class="p">][</span><span class="n">curr_run</span><span class="p">]])</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">timeseries</span><span class="p">[</span><span class="n">subject_runs</span><span class="p">])</span> <span class="o">!=</span> <span class="mi">0</span> <span class="k">else</span> <span class="n">subject_timeseries</span><span class="p">[</span><span class="n">subj_id</span><span class="p">][</span><span class="n">curr_run</span><span class="p">]</span>
                <span class="n">timeseries</span> <span class="o">=</span> <span class="p">(</span><span class="n">timeseries</span><span class="p">[</span><span class="n">subject_runs</span><span class="p">]</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">_mean_vec</span><span class="p">[</span><span class="n">group</span><span class="p">])</span><span class="o">/</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_stdev_vec</span><span class="p">[</span><span class="n">group</span><span class="p">]</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">_epsilon</span><span class="p">)</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_standardize</span> <span class="k">else</span> <span class="n">timeseries</span><span class="p">[</span><span class="n">subject_runs</span><span class="p">]</span>
                <span class="n">predicted_subject_timeseries</span><span class="p">[</span><span class="n">subj_id</span><span class="p">]</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="n">subject_runs</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_kmeans</span><span class="p">[</span><span class="n">group</span><span class="p">]</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">timeseries</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">})</span>

        <span class="n">df_dict</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="k">for</span> <span class="n">metric</span> <span class="ow">in</span> <span class="n">metrics</span><span class="p">:</span> 
            <span class="k">if</span> <span class="n">metric</span> <span class="ow">in</span> <span class="n">valid_metrics</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">metric</span> <span class="o">!=</span> <span class="s2">&quot;transition frequency&quot;</span><span class="p">:</span>
                    <span class="n">df_dict</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="n">metric</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;Subject_ID&quot;</span><span class="p">,</span> <span class="s2">&quot;Group&quot;</span><span class="p">,</span><span class="s2">&quot;Run&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="nb">list</span><span class="p">(</span><span class="n">cap_names</span><span class="p">))})</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">df_dict</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="n">metric</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;Subject_ID&quot;</span><span class="p">,</span> <span class="s2">&quot;Group&quot;</span><span class="p">,</span><span class="s2">&quot;Run&quot;</span><span class="p">,</span><span class="s2">&quot;Transition_Frequency&quot;</span><span class="p">])})</span>

        <span class="n">distributed_list</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">subj_id</span><span class="p">,</span> <span class="n">group</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_subject_table</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">for</span> <span class="n">curr_run</span> <span class="ow">in</span> <span class="n">predicted_subject_timeseries</span><span class="p">[</span><span class="n">subj_id</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="n">distributed_list</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">subj_id</span><span class="p">,</span><span class="n">group</span><span class="p">,</span><span class="n">curr_run</span><span class="p">])</span>

        <span class="k">for</span> <span class="n">subj_id</span><span class="p">,</span> <span class="n">group</span><span class="p">,</span> <span class="n">curr_run</span> <span class="ow">in</span> <span class="n">distributed_list</span><span class="p">:</span>
            <span class="k">if</span> <span class="s2">&quot;temporal fraction&quot;</span> <span class="ow">in</span> <span class="n">metrics</span> <span class="ow">or</span> <span class="s2">&quot;counts&quot;</span> <span class="ow">in</span> <span class="n">metrics</span><span class="p">:</span>
                <span class="n">frequency_dict</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">collections</span><span class="o">.</span><span class="n">Counter</span><span class="p">(</span><span class="n">predicted_subject_timeseries</span><span class="p">[</span><span class="n">subj_id</span><span class="p">][</span><span class="n">curr_run</span><span class="p">]))</span>
                <span class="n">sorted_frequency_dict</span> <span class="o">=</span> <span class="p">{</span><span class="n">key</span><span class="p">:</span> <span class="n">frequency_dict</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">frequency_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">()))}</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">sorted_frequency_dict</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">cap_numbers</span><span class="p">):</span>
                    <span class="n">sorted_frequency_dict</span> <span class="o">=</span> <span class="p">{</span><span class="n">cap_number</span><span class="p">:</span> <span class="n">sorted_frequency_dict</span><span class="p">[</span><span class="n">cap_number</span><span class="p">]</span> <span class="k">if</span> <span class="n">cap_number</span> <span class="ow">in</span> <span class="n">sorted_frequency_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="k">else</span> <span class="mi">0</span> <span class="k">for</span> <span class="n">cap_number</span> <span class="ow">in</span> <span class="n">cap_numbers</span><span class="p">}</span>
                <span class="k">if</span> <span class="s2">&quot;temporal fraction&quot;</span> <span class="ow">in</span> <span class="n">metrics</span><span class="p">:</span> 
                    <span class="n">proportion_dict</span> <span class="o">=</span> <span class="p">{</span><span class="n">key</span><span class="p">:</span> <span class="n">item</span><span class="o">/</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">predicted_subject_timeseries</span><span class="p">[</span><span class="n">subj_id</span><span class="p">][</span><span class="n">curr_run</span><span class="p">]))</span> <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">sorted_frequency_dict</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>
                    <span class="c1"># Populate Dataframe</span>
                    <span class="n">df_dict</span><span class="p">[</span><span class="s2">&quot;temporal fraction&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">df_dict</span><span class="p">[</span><span class="s2">&quot;temporal fraction&quot;</span><span class="p">])]</span> <span class="o">=</span> <span class="p">[</span><span class="n">subj_id</span><span class="p">,</span> <span class="n">group</span><span class="p">,</span> <span class="n">curr_run</span><span class="p">]</span> <span class="o">+</span> <span class="p">[</span><span class="n">items</span> <span class="k">for</span> <span class="n">_</span> <span class="p">,</span> <span class="n">items</span> <span class="ow">in</span> <span class="n">proportion_dict</span><span class="o">.</span><span class="n">items</span><span class="p">()]</span>
                <span class="k">if</span> <span class="s2">&quot;counts&quot;</span> <span class="ow">in</span> <span class="n">metrics</span><span class="p">:</span>
                    <span class="c1"># Populate Dataframe</span>
                    <span class="n">df_dict</span><span class="p">[</span><span class="s2">&quot;counts&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">df_dict</span><span class="p">[</span><span class="s2">&quot;counts&quot;</span><span class="p">])]</span> <span class="o">=</span> <span class="p">[</span><span class="n">subj_id</span><span class="p">,</span> <span class="n">group</span><span class="p">,</span> <span class="n">curr_run</span><span class="p">]</span> <span class="o">+</span> <span class="p">[</span><span class="n">items</span> <span class="k">for</span> <span class="n">_</span> <span class="p">,</span> <span class="n">items</span> <span class="ow">in</span> <span class="n">sorted_frequency_dict</span><span class="o">.</span><span class="n">items</span><span class="p">()]</span>
            <span class="k">if</span> <span class="s2">&quot;persistence&quot;</span> <span class="ow">in</span> <span class="n">metrics</span><span class="p">:</span>
                <span class="c1"># Initialize variable</span>
                <span class="n">persistence_dict</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="n">uninterrupted_volumes</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="n">count</span> <span class="o">=</span> <span class="mi">0</span>

                <span class="c1"># Iterate through caps</span>
                <span class="k">for</span> <span class="n">target</span> <span class="ow">in</span> <span class="n">cap_numbers</span><span class="p">:</span>
                    <span class="c1"># Iterate through each element and count uninterrupted volumes that equal target</span>
                    <span class="k">for</span> <span class="n">index</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">predicted_subject_timeseries</span><span class="p">[</span><span class="n">subj_id</span><span class="p">][</span><span class="n">curr_run</span><span class="p">])):</span>
                        <span class="k">if</span> <span class="n">predicted_subject_timeseries</span><span class="p">[</span><span class="n">subj_id</span><span class="p">][</span><span class="n">curr_run</span><span class="p">][</span><span class="n">index</span><span class="p">]</span> <span class="o">==</span> <span class="n">target</span><span class="p">:</span>
                            <span class="n">count</span> <span class="o">+=</span><span class="mi">1</span>
                        <span class="c1"># Store count in list if interrupted and not zero </span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="k">if</span> <span class="n">count</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                                <span class="n">uninterrupted_volumes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">count</span><span class="p">)</span>
                            <span class="c1"># Reset counter </span>
                            <span class="n">count</span> <span class="o">=</span> <span class="mi">0</span>
                    <span class="c1"># In the event, a participant only occupies one CAP and to ensure final counts are added</span>
                    <span class="k">if</span> <span class="n">count</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="n">uninterrupted_volumes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">count</span><span class="p">)</span>
                    <span class="c1"># If uninterrupted_volumes not zero, multiply elements in the list by repetition time, sum and divide</span>
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">uninterrupted_volumes</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">tr</span><span class="p">:</span>
                            <span class="n">persistence_dict</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="n">target</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">uninterrupted_volumes</span><span class="p">)</span><span class="o">*</span><span class="n">tr</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">uninterrupted_volumes</span><span class="p">))})</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">persistence_dict</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="n">target</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">uninterrupted_volumes</span><span class="p">))</span><span class="o">/</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">uninterrupted_volumes</span><span class="p">))})</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">persistence_dict</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="n">target</span><span class="p">:</span> <span class="mi">0</span><span class="p">})</span>
                    <span class="c1"># Reset variables</span>
                    <span class="n">count</span> <span class="o">=</span> <span class="mi">0</span>
                    <span class="n">uninterrupted_volumes</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="c1"># Populate Dataframe</span>
                <span class="n">df_dict</span><span class="p">[</span><span class="s2">&quot;persistence&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">df_dict</span><span class="p">[</span><span class="s2">&quot;persistence&quot;</span><span class="p">])]</span> <span class="o">=</span> <span class="p">[</span><span class="n">subj_id</span><span class="p">,</span> <span class="n">group</span><span class="p">,</span> <span class="n">curr_run</span><span class="p">]</span> <span class="o">+</span> <span class="p">[</span><span class="n">items</span> <span class="k">for</span> <span class="n">_</span> <span class="p">,</span> <span class="n">items</span> <span class="ow">in</span> <span class="n">persistence_dict</span><span class="o">.</span><span class="n">items</span><span class="p">()]</span>
            <span class="k">if</span> <span class="s2">&quot;transition frequency&quot;</span> <span class="ow">in</span> <span class="n">metrics</span><span class="p">:</span>
                <span class="n">count</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="c1"># Iterate through predicted values </span>
                <span class="k">for</span> <span class="n">index</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">predicted_subject_timeseries</span><span class="p">[</span><span class="n">subj_id</span><span class="p">][</span><span class="n">curr_run</span><span class="p">])):</span>
                    <span class="k">if</span> <span class="n">index</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="c1"># If the subsequent element does not equal the previous element, this is considered a transition</span>
                        <span class="k">if</span> <span class="n">predicted_subject_timeseries</span><span class="p">[</span><span class="n">subj_id</span><span class="p">][</span><span class="n">curr_run</span><span class="p">][</span><span class="n">index</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="n">predicted_subject_timeseries</span><span class="p">[</span><span class="n">subj_id</span><span class="p">][</span><span class="n">curr_run</span><span class="p">][</span><span class="n">index</span><span class="p">]:</span>
                            <span class="n">count</span> <span class="o">+=</span><span class="mi">1</span>
                <span class="n">df_dict</span><span class="p">[</span><span class="s2">&quot;transition frequency&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">df_dict</span><span class="p">[</span><span class="s2">&quot;transition frequency&quot;</span><span class="p">])]</span> <span class="o">=</span> <span class="p">[</span><span class="n">subj_id</span><span class="p">,</span> <span class="n">group</span><span class="p">,</span> <span class="n">curr_run</span><span class="p">,</span> <span class="n">count</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">output_dir</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">output_dir</span><span class="p">):</span> <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">output_dir</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">metric</span> <span class="ow">in</span> <span class="n">df_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="n">filename</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">file_name</span><span class="o">.</span><span class="n">rstrip</span><span class="p">())[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">rstrip</span><span class="p">()</span> <span class="o">+</span> <span class="sa">f</span><span class="s2">&quot;-</span><span class="si">{</span><span class="n">metric</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="s1">&#39;_&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">if</span> <span class="n">file_name</span> <span class="k">else</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">metric</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="s1">&#39;_&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="n">df_dict</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">metric</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">path_or_buf</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_dir</span><span class="p">,</span><span class="n">filename</span> <span class="o">+</span> <span class="s2">&quot;.csv&quot;</span><span class="p">),</span> <span class="n">sep</span><span class="o">=</span><span class="s2">&quot;,&quot;</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">return_df</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">df_dict</span></div>

        
<div class="viewcode-block" id="CAP.caps2plot">
<a class="viewcode-back" href="../../../generated/neurocaps.analysis.CAP.html#neurocaps.analysis.CAP.caps2plot">[docs]</a>
    <span class="k">def</span> <span class="nf">caps2plot</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">output_dir</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Path</span><span class="p">]</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">suffix_title</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">plot_options</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span><span class="o">=</span><span class="s2">&quot;outer product&quot;</span><span class="p">,</span> <span class="n">visual_scope</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span><span class="o">=</span><span class="s2">&quot;regions&quot;</span><span class="p">,</span> 
                        <span class="n">show_figs</span><span class="p">:</span> <span class="nb">bool</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">subplots</span><span class="p">:</span> <span class="nb">bool</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Generate heatmaps and outer product plots of CAPs</span>

<span class="sd">        This function produces seaborn heatmaps for each CAP. If groups were given when the CAP class was initialized, plotting will be done for all CAPs for all groups.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        output_dir: Path or None, default=None</span>
<span class="sd">            Directory to save plots to. The directory will be created if it does not exist. If None, plots will not be saved.</span>
<span class="sd">        suffix_title: str or None, default=None</span>
<span class="sd">            Appended to the title of each plot as well as the name of the saved file if ``output_dir`` is provided.</span>
<span class="sd">        plot_options: str or List[str], default=&quot;outer product&quot;</span>
<span class="sd">            Type of plots to create. Options are &quot;outer product&quot; or &quot;heatmap&quot;.</span>
<span class="sd">        visual_scope: str or List[str], default=&quot;regions&quot;</span>
<span class="sd">            Determines whether plotting is done at the region level or node level. </span>
<span class="sd">            For region level, the value of each nodes in the same regions are averaged together then plotted.</span>
<span class="sd">            Options are &quot;regions&quot; or &quot;nodes&quot;.</span>
<span class="sd">        show_figs: bool, default=True</span>
<span class="sd">            Whether to display figures.</span>
<span class="sd">        subplots: bool, default=True</span>
<span class="sd">            Whether to produce subplots for outer product plots.</span>
<span class="sd">        **kwargs: dict</span>
<span class="sd">            Keyword arguments used when saving figures. Valid keywords include:</span>

<span class="sd">            - &quot;dpi&quot;: int, default=300</span>
<span class="sd">                Dots per inch for the figure. Default is 300 if ``output_dir`` is provided and ``dpi`` is not specified.</span>
<span class="sd">            - &quot;figsize&quot;: Tuple, default=(8, 6)</span>
<span class="sd">                Size of the figure in inches.</span>
<span class="sd">            - &quot;fontsize&quot;: int, default=14</span>
<span class="sd">                Font size for the title of individual plots or subplots.</span>
<span class="sd">            - &quot;hspace&quot;: float, default=0.4</span>
<span class="sd">                Height space between subplots.</span>
<span class="sd">            - &quot;wspace&quot;: float, default=0.4</span>
<span class="sd">                Width space between subplots.</span>
<span class="sd">            - &quot;xticklabels_size&quot;: int, default=8</span>
<span class="sd">                Font size for x-axis tick labels.</span>
<span class="sd">            - &quot;yticklabels_size&quot;: int, default=8</span>
<span class="sd">                Font size for y-axis tick labels.</span>
<span class="sd">            - &quot;shrink&quot;: float, default=0.8</span>
<span class="sd">                Fraction by which to shrink the colorbar.</span>
<span class="sd">            - &quot;nrow&quot;: int, varies;</span>
<span class="sd">                Number of rows for subplots. Default varies.</span>
<span class="sd">            - &quot;ncol&quot;: int, default varies (max 5)</span>
<span class="sd">                Number of columns for subplots. Default varies but the maximum is 5.</span>
<span class="sd">            - &quot;suptitle_fontsize&quot;: float, default=0.7</span>
<span class="sd">                Font size for the main title when subplot is True.</span>
<span class="sd">            - &quot;tight_layout&quot;: bool, default=True</span>
<span class="sd">                Use tight layout for subplots.</span>
<span class="sd">            - &quot;rect&quot;: List[int], default=[0, 0.03, 1, 0.95]</span>
<span class="sd">                Rectangle parameter for tight layout when subplots are True to fix whitespace issues.</span>
<span class="sd">            - &quot;sharey&quot;: bool, default=True</span>
<span class="sd">                Share y-axis labels for subplots.</span>
<span class="sd">            - &quot;xlabel_rotation&quot;: int, default=0</span>
<span class="sd">                Rotation angle for x-axis labels.</span>
<span class="sd">            - &quot;ylabel_rotation&quot;: int, default=0</span>
<span class="sd">                Rotation angle for y-axis labels.</span>
<span class="sd">            - &quot;annot&quot;: bool, default=False</span>
<span class="sd">                Add values to cells.</span>
<span class="sd">            - &quot;fmt&quot;: str, default=&quot;.2g&quot;</span>
<span class="sd">                Modify how the annotated vales are presented.</span>
<span class="sd">            - &quot;linewidths&quot;: float, default=0</span>
<span class="sd">                Padding between each cell in the plot.</span>
<span class="sd">            - &quot;borderwidths&quot;: float, default=0</span>
<span class="sd">                Width of the border around the plot.</span>
<span class="sd">            - &quot;linecolor&quot;: str, default=&quot;black&quot;</span>
<span class="sd">                Color of the line that seperates each cell.</span>
<span class="sd">            - &quot;edgecolors&quot;: str or None, default=None</span>
<span class="sd">                Color of the edges.</span>
<span class="sd">            - &quot;alpha&quot;: float or None, default=None</span>
<span class="sd">                Controls transparancy and ranges from 0 (transparant) to 1 (opaque).</span>
<span class="sd">            - &quot;hemisphere_labels&quot;: bool, default=False</span>
<span class="sd">                This option is only available when visual_scope=&quot;nodes&quot;. Instead of listing all individual labels, this parameter </span>
<span class="sd">                simplifies the labels to indicate only the left and right hemispheres, with a division line separating the cells </span>
<span class="sd">                belonging to each hemisphere. If set to True, &quot;edgecolors&quot; will not be used, and both &quot;linewidths&quot; and &quot;linecolor&quot; </span>
<span class="sd">                will be applied only to the division line. This option is available exclusively for &quot;Custom&quot; and &quot;Schaefer&quot; parcellations. </span>
<span class="sd">                WARNING, for the &quot;Custom&quot; option, the parcellation should be organized such that the first half of the labels/nodes belong to the left </span>
<span class="sd">                hemisphere and the latter half to the right hemisphere.</span>
<span class="sd">            - &quot;cmap&quot;: str, Class, or Function, default=&quot;coolwarm&quot;</span>
<span class="sd">                Color map for the cells in the plot. For this parameter, you can use premade color palettes or create custom ones.</span>
<span class="sd">                Below is a list of valid options:</span>

<span class="sd">                - Strings to call seaborn&#39;s premade palettes. Refer to seaborn&#39;s documentation for valid options.</span>
<span class="sd">                - Seaborn&#39;s diverging_palette function to generate custom palettes.</span>
<span class="sd">                - Matplotlib&#39;s LinearSegmentedColormap to generate custom palettes.</span>
<span class="sd">                - Other classes or functions compatible with seaborn.</span>
<span class="sd">            - &quot;vmin&quot;: float, default=None</span>
<span class="sd">                The minimum value to display in plots. </span>
<span class="sd">            - &quot;vmax&quot;: float, default=None</span>
<span class="sd">                The maximum value to display in plots. </span>
<span class="sd">        </span>
<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        seaborn.heatmap</span>
<span class="sd">            An instance of a seaborn heatmap.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">import</span> <span class="nn">itertools</span><span class="o">,</span> <span class="nn">os</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="s2">&quot;_caps&quot;</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">AttributeError</span><span class="p">(</span><span class="s2">&quot;Cannot plot caps since `self._caps` attribute does not exist. Run `self.get_caps()` first.&quot;</span><span class="p">)</span>
        
        <span class="c1"># Check if parcellation_approach is custom</span>
        <span class="k">if</span> <span class="s2">&quot;Custom&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parcel_approach</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="ow">and</span> <span class="p">(</span><span class="s2">&quot;nodes&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parcel_approach</span><span class="p">[</span><span class="s2">&quot;Custom&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="ow">or</span> <span class="s2">&quot;regions&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parcel_approach</span><span class="p">[</span><span class="s2">&quot;Custom&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
            <span class="n">_check_parcel_approach</span><span class="p">(</span><span class="n">parcel_approach</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_parcel_approach</span><span class="p">,</span> <span class="n">call</span><span class="o">=</span><span class="s2">&quot;caps2plot&quot;</span><span class="p">)</span>

        <span class="c1"># Check labels</span>
        <span class="n">check_caps</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_caps</span><span class="p">[</span><span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_caps</span><span class="o">.</span><span class="n">keys</span><span class="p">())[</span><span class="mi">0</span><span class="p">]]</span>
        <span class="n">check_caps</span> <span class="o">=</span> <span class="n">check_caps</span><span class="p">[</span><span class="nb">list</span><span class="p">(</span><span class="n">check_caps</span><span class="o">.</span><span class="n">keys</span><span class="p">())[</span><span class="mi">0</span><span class="p">]]</span>
        <span class="k">if</span> <span class="n">check_caps</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_parcel_approach</span><span class="p">[</span><span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_parcel_approach</span><span class="o">.</span><span class="n">keys</span><span class="p">())[</span><span class="mi">0</span><span class="p">]][</span><span class="s2">&quot;nodes&quot;</span><span class="p">]):</span> 
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Number of rois/nodes used for CAPs does not equal the number of rois/nodes specified in `parcel_approach`.&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">output_dir</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">output_dir</span><span class="p">):</span> <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">output_dir</span><span class="p">)</span>

        <span class="c1"># Convert to list</span>
        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">plot_options</span><span class="p">)</span> <span class="o">==</span> <span class="nb">str</span><span class="p">:</span> <span class="n">plot_options</span> <span class="o">=</span> <span class="p">[</span><span class="n">plot_options</span><span class="p">]</span>
        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">visual_scope</span><span class="p">)</span> <span class="o">==</span> <span class="nb">str</span><span class="p">:</span> <span class="n">visual_scope</span> <span class="o">=</span> <span class="p">[</span><span class="n">visual_scope</span><span class="p">]</span>

        <span class="c1"># Check inputs for plot_options and visual_scope</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">any</span><span class="p">([</span><span class="s2">&quot;heatmap&quot;</span> <span class="ow">in</span> <span class="n">plot_options</span><span class="p">,</span> <span class="s2">&quot;outer product&quot;</span> <span class="ow">in</span> <span class="n">plot_options</span><span class="p">]):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Valid inputs for `plot_options` are &#39;heatmap&#39; and &#39;outer product&#39;.&quot;</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">any</span><span class="p">([</span><span class="s2">&quot;regions&quot;</span> <span class="ow">in</span> <span class="n">visual_scope</span><span class="p">,</span> <span class="s2">&quot;nodes&quot;</span> <span class="ow">in</span> <span class="n">visual_scope</span><span class="p">]):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Valid inputs for `visual_scope` are &#39;regions&#39; and &#39;nodes&#39;.&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="s2">&quot;regions&quot;</span> <span class="ow">in</span> <span class="n">visual_scope</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_create_regions</span><span class="p">()</span>

        <span class="c1"># Create plot dictionary</span>
        <span class="n">defaults</span><span class="o">=</span> <span class="p">{</span><span class="s2">&quot;dpi&quot;</span><span class="p">:</span> <span class="mi">300</span><span class="p">,</span> <span class="s2">&quot;figsize&quot;</span><span class="p">:</span> <span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mi">6</span><span class="p">),</span> <span class="s2">&quot;fontsize&quot;</span><span class="p">:</span> <span class="mi">14</span><span class="p">,</span> <span class="s2">&quot;hspace&quot;</span><span class="p">:</span> <span class="mf">0.2</span><span class="p">,</span> <span class="s2">&quot;wspace&quot;</span><span class="p">:</span> <span class="mf">0.2</span><span class="p">,</span> <span class="s2">&quot;xticklabels_size&quot;</span><span class="p">:</span> <span class="mi">8</span><span class="p">,</span>
                    <span class="s2">&quot;yticklabels_size&quot;</span><span class="p">:</span> <span class="mi">8</span><span class="p">,</span> <span class="s2">&quot;shrink&quot;</span><span class="p">:</span> <span class="mf">0.8</span><span class="p">,</span> <span class="s2">&quot;nrow&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;ncol&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;suptitle_fontsize&quot;</span><span class="p">:</span> <span class="mi">20</span><span class="p">,</span>
                    <span class="s2">&quot;tight_layout&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span> <span class="s2">&quot;rect&quot;</span><span class="p">:</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mf">0.03</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mf">0.95</span><span class="p">],</span> <span class="s2">&quot;sharey&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span> <span class="s2">&quot;xlabel_rotation&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
                    <span class="s2">&quot;ylabel_rotation&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;annot&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span> <span class="s2">&quot;fmt&quot;</span><span class="p">:</span> <span class="s2">&quot;.2g&quot;</span><span class="p">,</span> <span class="s2">&quot;linewidths&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;linecolor&quot;</span><span class="p">:</span> <span class="s2">&quot;black&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;cmap&quot;</span><span class="p">:</span> <span class="s2">&quot;coolwarm&quot;</span><span class="p">,</span> <span class="s2">&quot;edgecolors&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;alpha&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;hemisphere_labels&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span> <span class="s2">&quot;borderwidths&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
                    <span class="s2">&quot;vmin&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;vmax&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">}</span>
        
        <span class="n">plot_dict</span> <span class="o">=</span> <span class="n">_check_kwargs</span><span class="p">(</span><span class="n">defaults</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">plot_dict</span><span class="p">[</span><span class="s2">&quot;hemisphere_labels&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="kc">True</span><span class="p">:</span>
            <span class="k">if</span> <span class="s2">&quot;nodes&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">visual_scope</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;`hemisphere_labels` is only available when `visual_scope == &#39;nodes&#39;`.&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="s2">&quot;AAL&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parcel_approach</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;`hemisphere_labels` is only available for &#39;Custom&#39; and &#39;Schaefer&#39;.&quot;</span><span class="p">)</span>
        
        <span class="c1"># Ensure plot_options and visual_scope are lists</span>
        <span class="n">plot_options</span> <span class="o">=</span> <span class="n">plot_options</span> <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">plot_options</span><span class="p">)</span> <span class="o">==</span> <span class="nb">list</span> <span class="k">else</span> <span class="nb">list</span><span class="p">(</span><span class="n">plot_options</span><span class="p">)</span>
        <span class="n">visual_scope</span> <span class="o">=</span> <span class="n">visual_scope</span> <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">visual_scope</span><span class="p">)</span> <span class="o">==</span> <span class="nb">list</span> <span class="k">else</span> <span class="nb">list</span><span class="p">(</span><span class="n">visual_scope</span><span class="p">)</span>
        <span class="c1"># Initialize outer product attribute</span>
        <span class="k">if</span> <span class="s2">&quot;outer product&quot;</span> <span class="ow">in</span> <span class="n">plot_options</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_outer_product</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="n">distributed_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">itertools</span><span class="o">.</span><span class="n">product</span><span class="p">(</span><span class="n">plot_options</span><span class="p">,</span><span class="n">visual_scope</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">_groups</span><span class="o">.</span><span class="n">keys</span><span class="p">()))</span>

        <span class="k">for</span> <span class="n">plot_option</span><span class="p">,</span> <span class="n">scope</span><span class="p">,</span> <span class="n">group</span> <span class="ow">in</span> <span class="n">distributed_list</span><span class="p">:</span>
                <span class="c1"># Get correct labels depending on scope</span>
                <span class="k">if</span> <span class="n">scope</span> <span class="o">==</span> <span class="s2">&quot;regions&quot;</span><span class="p">:</span> 
                    <span class="k">if</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_parcel_approach</span><span class="o">.</span><span class="n">keys</span><span class="p">())[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;Schaefer&quot;</span><span class="p">,</span> <span class="s2">&quot;AAL&quot;</span><span class="p">]:</span>
                        <span class="n">cap_dict</span><span class="p">,</span> <span class="n">columns</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_region_caps</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parcel_approach</span><span class="p">[</span><span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_parcel_approach</span><span class="o">.</span><span class="n">keys</span><span class="p">())[</span><span class="mi">0</span><span class="p">]][</span><span class="s2">&quot;regions&quot;</span><span class="p">]</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">cap_dict</span><span class="p">,</span> <span class="n">columns</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_region_caps</span><span class="p">,</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_parcel_approach</span><span class="p">[</span><span class="s2">&quot;Custom&quot;</span><span class="p">][</span><span class="s2">&quot;regions&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
                <span class="k">elif</span> <span class="n">scope</span> <span class="o">==</span> <span class="s2">&quot;nodes&quot;</span><span class="p">:</span> 
                    <span class="k">if</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_parcel_approach</span><span class="o">.</span><span class="n">keys</span><span class="p">())[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;Schaefer&quot;</span><span class="p">,</span> <span class="s2">&quot;AAL&quot;</span><span class="p">]:</span>
                        <span class="n">cap_dict</span><span class="p">,</span> <span class="n">columns</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_caps</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parcel_approach</span><span class="p">[</span><span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_parcel_approach</span><span class="o">.</span><span class="n">keys</span><span class="p">())[</span><span class="mi">0</span><span class="p">]][</span><span class="s2">&quot;nodes&quot;</span><span class="p">]</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">cap_dict</span><span class="p">,</span> <span class="n">columns</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_caps</span> <span class="p">,</span> <span class="p">[</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot; &quot;</span> <span class="o">+</span> <span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">itertools</span><span class="o">.</span><span class="n">product</span><span class="p">([</span><span class="s2">&quot;LH&quot;</span><span class="p">,</span> <span class="s2">&quot;RH&quot;</span><span class="p">],</span><span class="bp">self</span><span class="o">.</span><span class="n">_parcel_approach</span><span class="p">[</span><span class="s2">&quot;Custom&quot;</span><span class="p">][</span><span class="s2">&quot;regions&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">()))]</span>

                <span class="c1">#  Generate plot for each group</span>
                <span class="k">if</span> <span class="n">plot_option</span> <span class="o">==</span> <span class="s2">&quot;outer product&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_generate_outer_product_plots</span><span class="p">(</span><span class="n">group</span><span class="o">=</span><span class="n">group</span><span class="p">,</span> <span class="n">plot_dict</span><span class="o">=</span><span class="n">plot_dict</span><span class="p">,</span> <span class="n">cap_dict</span><span class="o">=</span><span class="n">cap_dict</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="n">columns</span><span class="p">,</span> <span class="n">subplots</span><span class="o">=</span><span class="n">subplots</span><span class="p">,</span>
                                                                                    <span class="n">output_dir</span><span class="o">=</span><span class="n">output_dir</span><span class="p">,</span> <span class="n">suffix_title</span><span class="o">=</span><span class="n">suffix_title</span><span class="p">,</span> <span class="n">show_figs</span><span class="o">=</span><span class="n">show_figs</span><span class="p">,</span> <span class="n">scope</span><span class="o">=</span><span class="n">scope</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">plot_option</span> <span class="o">==</span> <span class="s2">&quot;heatmap&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_generate_heatmap_plots</span><span class="p">(</span><span class="n">group</span><span class="o">=</span><span class="n">group</span><span class="p">,</span> <span class="n">plot_dict</span><span class="o">=</span><span class="n">plot_dict</span><span class="p">,</span> <span class="n">cap_dict</span><span class="o">=</span><span class="n">cap_dict</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="n">columns</span><span class="p">,</span>
                                                                            <span class="n">output_dir</span><span class="o">=</span><span class="n">output_dir</span><span class="p">,</span> <span class="n">suffix_title</span><span class="o">=</span><span class="n">suffix_title</span><span class="p">,</span> <span class="n">show_figs</span><span class="o">=</span><span class="n">show_figs</span><span class="p">,</span> <span class="n">scope</span><span class="o">=</span><span class="n">scope</span><span class="p">)</span></div>

            
    <span class="k">def</span> <span class="nf">_create_regions</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># Internal function to create an attribute called `region_caps`. Purpose is to average the values of all nodes in a corresponding region to create region heatmaps or outer product plots</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_region_caps</span> <span class="o">=</span> <span class="p">{</span><span class="n">group</span><span class="p">:</span> <span class="p">{}</span> <span class="k">for</span> <span class="n">group</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_groups</span><span class="o">.</span><span class="n">keys</span><span class="p">()}</span>
        <span class="k">for</span> <span class="n">group</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_groups</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="k">for</span> <span class="n">cap</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_caps</span><span class="p">[</span><span class="n">group</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="n">region_caps</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="k">if</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_parcel_approach</span><span class="o">.</span><span class="n">keys</span><span class="p">())[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="s2">&quot;Custom&quot;</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">region</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parcel_approach</span><span class="p">[</span><span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_parcel_approach</span><span class="o">.</span><span class="n">keys</span><span class="p">())[</span><span class="mi">0</span><span class="p">]][</span><span class="s2">&quot;regions&quot;</span><span class="p">]:</span>
                        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">region_caps</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                            <span class="n">region_caps</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">average</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_caps</span><span class="p">[</span><span class="n">group</span><span class="p">][</span><span class="n">cap</span><span class="p">][</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">index</span> <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">node</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_parcel_approach</span><span class="p">[</span><span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_parcel_approach</span><span class="o">.</span><span class="n">keys</span><span class="p">())[</span><span class="mi">0</span><span class="p">]][</span><span class="s2">&quot;nodes&quot;</span><span class="p">])</span> <span class="k">if</span> <span class="n">region</span> <span class="ow">in</span> <span class="n">node</span><span class="p">])])])</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">region_caps</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">([</span><span class="n">region_caps</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">average</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_caps</span><span class="p">[</span><span class="n">group</span><span class="p">][</span><span class="n">cap</span><span class="p">][</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">index</span> <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">node</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_parcel_approach</span><span class="p">[</span><span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_parcel_approach</span><span class="o">.</span><span class="n">keys</span><span class="p">())[</span><span class="mi">0</span><span class="p">]][</span><span class="s2">&quot;nodes&quot;</span><span class="p">])</span> <span class="k">if</span> <span class="n">region</span> <span class="ow">in</span> <span class="n">node</span><span class="p">])])])</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">region_dict</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parcel_approach</span><span class="p">[</span><span class="s2">&quot;Custom&quot;</span><span class="p">][</span><span class="s2">&quot;regions&quot;</span><span class="p">]</span>
                    <span class="n">region_keys</span> <span class="o">=</span> <span class="n">region_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
                    <span class="k">for</span> <span class="n">region</span> <span class="ow">in</span> <span class="n">region_keys</span><span class="p">:</span>
                        <span class="n">roi_indxs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">region_dict</span><span class="p">[</span><span class="n">region</span><span class="p">][</span><span class="s2">&quot;lh&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="n">region_dict</span><span class="p">[</span><span class="n">region</span><span class="p">][</span><span class="s2">&quot;rh&quot;</span><span class="p">])</span>
                        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">region_caps</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                            <span class="n">region_caps</span><span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">average</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_caps</span><span class="p">[</span><span class="n">group</span><span class="p">][</span><span class="n">cap</span><span class="p">][</span><span class="n">roi_indxs</span><span class="p">])])</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">region_caps</span><span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">([</span><span class="n">region_caps</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">average</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_caps</span><span class="p">[</span><span class="n">group</span><span class="p">][</span><span class="n">cap</span><span class="p">][</span><span class="n">roi_indxs</span><span class="p">])])</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">_region_caps</span><span class="p">[</span><span class="n">group</span><span class="p">]</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="n">cap</span><span class="p">:</span> <span class="n">region_caps</span><span class="p">})</span>
    
    <span class="k">def</span> <span class="nf">_generate_outer_product_plots</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">group</span><span class="p">,</span> <span class="n">plot_dict</span><span class="p">,</span> <span class="n">cap_dict</span><span class="p">,</span> <span class="n">columns</span><span class="p">,</span> <span class="n">subplots</span><span class="p">,</span> <span class="n">output_dir</span><span class="p">,</span> <span class="n">suffix_title</span><span class="p">,</span> <span class="n">show_figs</span><span class="p">,</span> <span class="n">scope</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span><span class="o">,</span> <span class="nn">os</span>
        <span class="kn">from</span> <span class="nn">seaborn</span> <span class="kn">import</span> <span class="n">heatmap</span>

        <span class="c1"># Nested dictionary for group</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_outer_product</span><span class="p">[</span><span class="n">group</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="c1"># Create base grid for subplots</span>
        <span class="k">if</span> <span class="n">subplots</span><span class="p">:</span>
            <span class="c1"># Max five subplots per row for default</span>
            <span class="n">default_col</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">cap_dict</span><span class="p">[</span><span class="n">group</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">cap_dict</span><span class="p">[</span><span class="n">group</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span> <span class="o">&lt;=</span> <span class="mi">5</span> <span class="k">else</span> <span class="mi">5</span>
            <span class="n">ncol</span> <span class="o">=</span> <span class="n">plot_dict</span><span class="p">[</span><span class="s2">&quot;ncol&quot;</span><span class="p">]</span> <span class="k">if</span> <span class="n">plot_dict</span><span class="p">[</span><span class="s2">&quot;ncol&quot;</span><span class="p">]</span> <span class="o">!=</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">default_col</span>
            <span class="k">if</span> <span class="n">ncol</span> <span class="o">&gt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">cap_dict</span><span class="p">[</span><span class="n">group</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span> <span class="n">ncol</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">cap_dict</span><span class="p">[</span><span class="n">group</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
            <span class="c1"># Pad nrow, since int will round down, padding is needed for cases where len(cap_dict[group].keys())/ncol is a float. This will add the extra row needed</span>
            <span class="n">x_pad</span> <span class="o">=</span> <span class="mi">0</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">cap_dict</span><span class="p">[</span><span class="n">group</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span><span class="o">/</span><span class="n">ncol</span> <span class="o">&lt;=</span> <span class="mi">1</span> <span class="k">else</span> <span class="mi">1</span>
            <span class="n">nrow</span> <span class="o">=</span> <span class="n">plot_dict</span><span class="p">[</span><span class="s2">&quot;nrow&quot;</span><span class="p">]</span> <span class="k">if</span> <span class="n">plot_dict</span><span class="p">[</span><span class="s2">&quot;nrow&quot;</span><span class="p">]</span> <span class="o">!=</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">x_pad</span> <span class="o">+</span> <span class="nb">int</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">cap_dict</span><span class="p">[</span><span class="n">group</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span><span class="o">/</span><span class="n">ncol</span><span class="p">)</span>
            
            <span class="n">subplot_figsize</span> <span class="o">=</span> <span class="p">(</span><span class="mi">8</span> <span class="o">*</span> <span class="n">ncol</span><span class="p">,</span> <span class="mi">6</span> <span class="o">*</span> <span class="n">nrow</span><span class="p">)</span> <span class="k">if</span> <span class="n">plot_dict</span><span class="p">[</span><span class="s2">&quot;figsize&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="p">(</span><span class="mi">8</span><span class="p">,</span><span class="mi">6</span><span class="p">)</span> <span class="k">else</span> <span class="n">plot_dict</span><span class="p">[</span><span class="s2">&quot;figsize&quot;</span><span class="p">]</span> 

            <span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">nrow</span><span class="p">,</span> <span class="n">ncol</span><span class="p">,</span> <span class="n">sharex</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">sharey</span><span class="o">=</span><span class="n">plot_dict</span><span class="p">[</span><span class="s2">&quot;sharey&quot;</span><span class="p">],</span> <span class="n">figsize</span><span class="o">=</span><span class="n">subplot_figsize</span><span class="p">)</span>
            <span class="n">suptitle</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">group</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">suffix_title</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">if</span> <span class="n">suffix_title</span> <span class="k">else</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">group</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="n">fig</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="n">suptitle</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="n">plot_dict</span><span class="p">[</span><span class="s2">&quot;suptitle_fontsize&quot;</span><span class="p">])</span>
            <span class="n">fig</span><span class="o">.</span><span class="n">subplots_adjust</span><span class="p">(</span><span class="n">hspace</span><span class="o">=</span><span class="n">plot_dict</span><span class="p">[</span><span class="s2">&quot;hspace&quot;</span><span class="p">],</span> <span class="n">wspace</span><span class="o">=</span><span class="n">plot_dict</span><span class="p">[</span><span class="s2">&quot;wspace&quot;</span><span class="p">])</span>  
            <span class="k">if</span> <span class="n">plot_dict</span><span class="p">[</span><span class="s2">&quot;tight_layout&quot;</span><span class="p">]:</span> <span class="n">fig</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">(</span><span class="n">rect</span><span class="o">=</span><span class="n">plot_dict</span><span class="p">[</span><span class="s2">&quot;rect&quot;</span><span class="p">])</span>  

            <span class="c1"># Current subplot</span>
            <span class="n">axes_x</span><span class="p">,</span> <span class="n">axes_y</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span> 

        <span class="c1"># Iterate over CAPs</span>
        <span class="k">for</span> <span class="n">cap</span> <span class="ow">in</span> <span class="n">cap_dict</span><span class="p">[</span><span class="n">group</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="c1"># Calculate outer product</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_outer_product</span><span class="p">[</span><span class="n">group</span><span class="p">]</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="n">cap</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">outer</span><span class="p">(</span><span class="n">cap_dict</span><span class="p">[</span><span class="n">group</span><span class="p">][</span><span class="n">cap</span><span class="p">],</span><span class="n">cap_dict</span><span class="p">[</span><span class="n">group</span><span class="p">][</span><span class="n">cap</span><span class="p">])})</span>
            <span class="c1"># Create labels if nodes requested for scope</span>
            <span class="k">if</span> <span class="n">scope</span> <span class="o">==</span> <span class="s2">&quot;nodes&quot;</span> <span class="ow">and</span> <span class="n">plot_dict</span><span class="p">[</span><span class="s2">&quot;hemisphere_labels&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="kc">False</span><span class="p">:</span>
                <span class="kn">import</span> <span class="nn">collections</span>
                
                <span class="c1"># Get frequency of each major hemisphere and region in Schaefer, AAL, or Custom atlas</span>
                <span class="k">if</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_parcel_approach</span><span class="o">.</span><span class="n">keys</span><span class="p">())[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;Schaefer&quot;</span><span class="p">:</span>
                    <span class="n">frequency_dict</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">collections</span><span class="o">.</span><span class="n">Counter</span><span class="p">([</span><span class="n">names</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot; &quot;</span> <span class="o">+</span> <span class="n">names</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">names</span> <span class="ow">in</span> <span class="p">[</span><span class="n">name</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;_&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">:</span><span class="mi">2</span><span class="p">]</span> <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parcel_approach</span><span class="p">[</span><span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_parcel_approach</span><span class="o">.</span><span class="n">keys</span><span class="p">())[</span><span class="mi">0</span><span class="p">]][</span><span class="s2">&quot;nodes&quot;</span><span class="p">]]]))</span>
                <span class="k">elif</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_parcel_approach</span><span class="o">.</span><span class="n">keys</span><span class="p">())[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;AAL&quot;</span><span class="p">:</span>
                    <span class="n">frequency_dict</span> <span class="o">=</span> <span class="n">collections</span><span class="o">.</span><span class="n">Counter</span><span class="p">([</span><span class="n">name</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;_&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parcel_approach</span><span class="p">[</span><span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_parcel_approach</span><span class="o">.</span><span class="n">keys</span><span class="p">())[</span><span class="mi">0</span><span class="p">]][</span><span class="s2">&quot;nodes&quot;</span><span class="p">]])</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">frequency_dict</span> <span class="o">=</span> <span class="p">{}</span>
                    <span class="k">for</span> <span class="nb">id</span> <span class="ow">in</span> <span class="n">columns</span><span class="p">:</span>
                        <span class="n">hemisphere_id</span> <span class="o">=</span> <span class="s2">&quot;LH&quot;</span> <span class="k">if</span> <span class="nb">id</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;LH &quot;</span><span class="p">)</span> <span class="k">else</span> <span class="s2">&quot;RH&quot;</span>
                        <span class="n">region_id</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;LH |RH &quot;</span><span class="p">,</span> <span class="nb">id</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                        <span class="n">frequency_dict</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="nb">id</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_parcel_approach</span><span class="p">[</span><span class="s2">&quot;Custom&quot;</span><span class="p">][</span><span class="s2">&quot;regions&quot;</span><span class="p">][</span><span class="n">region_id</span><span class="p">][</span><span class="n">hemisphere_id</span><span class="o">.</span><span class="n">lower</span><span class="p">()])})</span>
                <span class="c1"># Get the names, which indicate the hemisphere and region</span>
                <span class="n">names_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">frequency_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
                <span class="c1"># Create label list the same length as the labels dictionary and substitute each element with an empty string</span>
                <span class="n">labels</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;&quot;</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_parcel_approach</span><span class="p">[</span><span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_parcel_approach</span><span class="o">.</span><span class="n">keys</span><span class="p">())[</span><span class="mi">0</span><span class="p">]][</span><span class="s2">&quot;nodes&quot;</span><span class="p">]))]</span>

                <span class="n">starting_value</span> <span class="o">=</span> <span class="mi">0</span>

                <span class="c1"># Iterate through names_list and assign the starting indices corresponding to unique region and hemisphere key</span>
                <span class="k">for</span> <span class="n">num</span><span class="p">,</span> <span class="n">name</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">names_list</span><span class="p">):</span> 
                    <span class="k">if</span> <span class="n">num</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="n">labels</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">name</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="c1"># Shifting to previous frequency of the preceding netwerk to obtain the new starting value of the subsequent region and hemosphere pair</span>
                        <span class="n">starting_value</span> <span class="o">+=</span> <span class="n">frequency_dict</span><span class="p">[</span><span class="n">names_list</span><span class="p">[</span><span class="n">num</span><span class="o">-</span><span class="mi">1</span><span class="p">]]</span> 
                        <span class="n">labels</span><span class="p">[</span><span class="n">starting_value</span><span class="p">]</span> <span class="o">=</span> <span class="n">name</span>

            <span class="k">if</span> <span class="n">subplots</span><span class="p">:</span> 
                <span class="n">ax</span> <span class="o">=</span> <span class="n">axes</span><span class="p">[</span><span class="n">axes_y</span><span class="p">]</span> <span class="k">if</span> <span class="n">nrow</span> <span class="o">==</span> <span class="mi">1</span> <span class="k">else</span> <span class="n">axes</span><span class="p">[</span><span class="n">axes_x</span><span class="p">,</span><span class="n">axes_y</span><span class="p">]</span>
                <span class="c1"># Modify tick labels based on scope</span>
                <span class="k">if</span> <span class="n">scope</span> <span class="o">==</span> <span class="s2">&quot;regions&quot;</span><span class="p">:</span>
                    <span class="n">display</span> <span class="o">=</span> <span class="n">heatmap</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_outer_product</span><span class="p">[</span><span class="n">group</span><span class="p">][</span><span class="n">cap</span><span class="p">],</span> <span class="n">cmap</span><span class="o">=</span><span class="n">plot_dict</span><span class="p">[</span><span class="s2">&quot;cmap&quot;</span><span class="p">],</span> <span class="n">linewidths</span><span class="o">=</span><span class="n">plot_dict</span><span class="p">[</span><span class="s2">&quot;linewidths&quot;</span><span class="p">],</span> <span class="n">linecolor</span><span class="o">=</span><span class="n">plot_dict</span><span class="p">[</span><span class="s2">&quot;linecolor&quot;</span><span class="p">],</span> 
                                      <span class="n">xticklabels</span><span class="o">=</span><span class="n">columns</span><span class="p">,</span> <span class="n">yticklabels</span><span class="o">=</span><span class="n">columns</span><span class="p">,</span> <span class="n">cbar_kws</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;shrink&quot;</span><span class="p">:</span> <span class="n">plot_dict</span><span class="p">[</span><span class="s2">&quot;shrink&quot;</span><span class="p">]},</span> <span class="n">annot</span><span class="o">=</span><span class="n">plot_dict</span><span class="p">[</span><span class="s2">&quot;annot&quot;</span><span class="p">],</span> <span class="n">fmt</span><span class="o">=</span><span class="n">plot_dict</span><span class="p">[</span><span class="s2">&quot;fmt&quot;</span><span class="p">],</span>
                                      <span class="n">edgecolors</span><span class="o">=</span><span class="n">plot_dict</span><span class="p">[</span><span class="s2">&quot;edgecolors&quot;</span><span class="p">],</span> <span class="n">alpha</span><span class="o">=</span><span class="n">plot_dict</span><span class="p">[</span><span class="s2">&quot;alpha&quot;</span><span class="p">],</span> <span class="n">vmin</span><span class="o">=</span><span class="n">plot_dict</span><span class="p">[</span><span class="s2">&quot;vmin&quot;</span><span class="p">],</span> <span class="n">vmax</span><span class="o">=</span><span class="n">plot_dict</span><span class="p">[</span><span class="s2">&quot;vmax&quot;</span><span class="p">])</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">plot_dict</span><span class="p">[</span><span class="s2">&quot;hemisphere_labels&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="kc">False</span><span class="p">:</span>
                        <span class="n">display</span> <span class="o">=</span> <span class="n">heatmap</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_outer_product</span><span class="p">[</span><span class="n">group</span><span class="p">][</span><span class="n">cap</span><span class="p">],</span> <span class="n">cmap</span><span class="o">=</span><span class="n">plot_dict</span><span class="p">[</span><span class="s2">&quot;cmap&quot;</span><span class="p">],</span> <span class="n">linewidths</span><span class="o">=</span><span class="n">plot_dict</span><span class="p">[</span><span class="s2">&quot;linewidths&quot;</span><span class="p">],</span> 
                                        <span class="n">linecolor</span><span class="o">=</span><span class="n">plot_dict</span><span class="p">[</span><span class="s2">&quot;linecolor&quot;</span><span class="p">],</span> <span class="n">cbar_kws</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;shrink&quot;</span><span class="p">:</span> <span class="n">plot_dict</span><span class="p">[</span><span class="s2">&quot;shrink&quot;</span><span class="p">]},</span> <span class="n">annot</span><span class="o">=</span><span class="n">plot_dict</span><span class="p">[</span><span class="s2">&quot;annot&quot;</span><span class="p">],</span> <span class="n">fmt</span><span class="o">=</span><span class="n">plot_dict</span><span class="p">[</span><span class="s2">&quot;fmt&quot;</span><span class="p">],</span>
                                        <span class="n">edgecolors</span><span class="o">=</span><span class="n">plot_dict</span><span class="p">[</span><span class="s2">&quot;edgecolors&quot;</span><span class="p">],</span> <span class="n">alpha</span><span class="o">=</span><span class="n">plot_dict</span><span class="p">[</span><span class="s2">&quot;alpha&quot;</span><span class="p">],</span> <span class="n">vmin</span><span class="o">=</span><span class="n">plot_dict</span><span class="p">[</span><span class="s2">&quot;vmin&quot;</span><span class="p">],</span> <span class="n">vmax</span><span class="o">=</span><span class="n">plot_dict</span><span class="p">[</span><span class="s2">&quot;vmax&quot;</span><span class="p">])</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">display</span> <span class="o">=</span> <span class="n">heatmap</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_outer_product</span><span class="p">[</span><span class="n">group</span><span class="p">][</span><span class="n">cap</span><span class="p">],</span> <span class="n">cmap</span><span class="o">=</span><span class="n">plot_dict</span><span class="p">[</span><span class="s2">&quot;cmap&quot;</span><span class="p">],</span> <span class="n">cbar_kws</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;shrink&quot;</span><span class="p">:</span> <span class="n">plot_dict</span><span class="p">[</span><span class="s2">&quot;shrink&quot;</span><span class="p">]},</span> 
                                          <span class="n">annot</span><span class="o">=</span><span class="n">plot_dict</span><span class="p">[</span><span class="s2">&quot;annot&quot;</span><span class="p">],</span> <span class="n">fmt</span><span class="o">=</span><span class="n">plot_dict</span><span class="p">[</span><span class="s2">&quot;fmt&quot;</span><span class="p">],</span> <span class="n">alpha</span><span class="o">=</span><span class="n">plot_dict</span><span class="p">[</span><span class="s2">&quot;alpha&quot;</span><span class="p">],</span> <span class="n">vmin</span><span class="o">=</span><span class="n">plot_dict</span><span class="p">[</span><span class="s2">&quot;vmin&quot;</span><span class="p">],</span> <span class="n">vmax</span><span class="o">=</span><span class="n">plot_dict</span><span class="p">[</span><span class="s2">&quot;vmax&quot;</span><span class="p">])</span>
                        
                    <span class="k">if</span> <span class="n">plot_dict</span><span class="p">[</span><span class="s2">&quot;hemisphere_labels&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="kc">False</span><span class="p">:</span>
                        <span class="n">ticks</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">label</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">labels</span><span class="p">)</span> <span class="k">if</span> <span class="n">label</span><span class="p">]</span>  

                        <span class="n">ax</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">(</span><span class="n">ticks</span><span class="p">)</span>  
                        <span class="n">ax</span><span class="o">.</span><span class="n">set_xticklabels</span><span class="p">([</span><span class="n">label</span> <span class="k">for</span> <span class="n">label</span> <span class="ow">in</span> <span class="n">labels</span> <span class="k">if</span> <span class="n">label</span><span class="p">])</span> 
                        <span class="n">ax</span><span class="o">.</span><span class="n">set_yticks</span><span class="p">(</span><span class="n">ticks</span><span class="p">)</span>  
                        <span class="n">ax</span><span class="o">.</span><span class="n">set_yticklabels</span><span class="p">([</span><span class="n">label</span> <span class="k">for</span> <span class="n">label</span> <span class="ow">in</span> <span class="n">labels</span> <span class="k">if</span> <span class="n">label</span><span class="p">])</span> 
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">n_labels</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_parcel_approach</span><span class="p">[</span><span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_parcel_approach</span><span class="o">.</span><span class="n">keys</span><span class="p">())[</span><span class="mi">0</span><span class="p">]][</span><span class="s2">&quot;nodes&quot;</span><span class="p">])</span>
                        <span class="n">division_line</span> <span class="o">=</span> <span class="n">n_labels</span><span class="o">//</span><span class="mi">2</span>
                        <span class="n">left_hemisphere_tick</span> <span class="o">=</span> <span class="p">(</span><span class="mi">0</span> <span class="o">+</span> <span class="n">division_line</span><span class="p">)</span><span class="o">//</span><span class="mi">2</span>
                        <span class="n">right_hemisphere_tick</span> <span class="o">=</span> <span class="p">(</span><span class="n">division_line</span> <span class="o">+</span> <span class="n">n_labels</span><span class="p">)</span><span class="o">//</span><span class="mi">2</span>

                        <span class="n">ax</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">([</span><span class="n">left_hemisphere_tick</span><span class="p">,</span><span class="n">right_hemisphere_tick</span><span class="p">])</span>
                        <span class="n">ax</span><span class="o">.</span><span class="n">set_xticklabels</span><span class="p">([</span><span class="s2">&quot;LH&quot;</span><span class="p">,</span> <span class="s2">&quot;RH&quot;</span><span class="p">])</span>
                        <span class="n">ax</span><span class="o">.</span><span class="n">set_yticks</span><span class="p">([</span><span class="n">left_hemisphere_tick</span><span class="p">,</span><span class="n">right_hemisphere_tick</span><span class="p">])</span>
                        <span class="n">ax</span><span class="o">.</span><span class="n">set_yticklabels</span><span class="p">([</span><span class="s2">&quot;LH&quot;</span><span class="p">,</span> <span class="s2">&quot;RH&quot;</span><span class="p">])</span>
                        
                        <span class="n">plot_dict</span><span class="p">[</span><span class="s2">&quot;linewidths&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">plot_dict</span><span class="p">[</span><span class="s2">&quot;linewidths&quot;</span><span class="p">]</span> <span class="k">if</span> <span class="n">plot_dict</span><span class="p">[</span><span class="s2">&quot;linewidths&quot;</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span> <span class="k">else</span> <span class="mi">1</span>

                        <span class="n">ax</span><span class="o">.</span><span class="n">axhline</span><span class="p">(</span><span class="n">division_line</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">plot_dict</span><span class="p">[</span><span class="s2">&quot;linecolor&quot;</span><span class="p">],</span> <span class="n">linewidth</span><span class="o">=</span><span class="n">plot_dict</span><span class="p">[</span><span class="s2">&quot;linewidths&quot;</span><span class="p">])</span>
                        <span class="n">ax</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="n">division_line</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">plot_dict</span><span class="p">[</span><span class="s2">&quot;linecolor&quot;</span><span class="p">],</span> <span class="n">linewidth</span><span class="o">=</span><span class="n">plot_dict</span><span class="p">[</span><span class="s2">&quot;linewidths&quot;</span><span class="p">])</span>
                
                <span class="c1"># Add border </span>
                <span class="k">if</span> <span class="n">plot_dict</span><span class="p">[</span><span class="s1">&#39;borderwidths&#39;</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">border_length</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_outer_product</span><span class="p">[</span><span class="n">group</span><span class="p">][</span><span class="n">cap</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">if</span> <span class="n">scope</span> <span class="o">==</span> <span class="s2">&quot;regions&quot;</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">_outer_product</span><span class="p">[</span><span class="n">group</span><span class="p">][</span><span class="n">cap</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

                    <span class="n">display</span><span class="o">.</span><span class="n">axhline</span><span class="p">(</span><span class="n">y</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">plot_dict</span><span class="p">[</span><span class="s2">&quot;linecolor&quot;</span><span class="p">],</span><span class="n">linewidth</span><span class="o">=</span><span class="n">plot_dict</span><span class="p">[</span><span class="s2">&quot;borderwidths&quot;</span><span class="p">])</span>
                    <span class="n">display</span><span class="o">.</span><span class="n">axhline</span><span class="p">(</span><span class="n">y</span><span class="o">=</span><span class="n">border_length</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">plot_dict</span><span class="p">[</span><span class="s2">&quot;linecolor&quot;</span><span class="p">],</span><span class="n">linewidth</span><span class="o">=</span><span class="n">plot_dict</span><span class="p">[</span><span class="s2">&quot;borderwidths&quot;</span><span class="p">])</span>
                    <span class="n">display</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">plot_dict</span><span class="p">[</span><span class="s2">&quot;linecolor&quot;</span><span class="p">],</span><span class="n">linewidth</span><span class="o">=</span><span class="n">plot_dict</span><span class="p">[</span><span class="s2">&quot;borderwidths&quot;</span><span class="p">])</span>
                    <span class="n">display</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">border_length</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">plot_dict</span><span class="p">[</span><span class="s2">&quot;linecolor&quot;</span><span class="p">],</span><span class="n">linewidth</span><span class="o">=</span><span class="n">plot_dict</span><span class="p">[</span><span class="s2">&quot;borderwidths&quot;</span><span class="p">])</span>

                <span class="c1"># Modify label sizes</span>
                <span class="n">display</span><span class="o">.</span><span class="n">set_xticklabels</span><span class="p">(</span><span class="n">display</span><span class="o">.</span><span class="n">get_xticklabels</span><span class="p">(),</span> <span class="n">size</span> <span class="o">=</span> <span class="n">plot_dict</span><span class="p">[</span><span class="s2">&quot;xticklabels_size&quot;</span><span class="p">],</span> <span class="n">rotation</span><span class="o">=</span><span class="n">plot_dict</span><span class="p">[</span><span class="s2">&quot;xlabel_rotation&quot;</span><span class="p">])</span>

                <span class="k">if</span> <span class="n">plot_dict</span><span class="p">[</span><span class="s2">&quot;sharey&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="kc">True</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">axes_y</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span> <span class="n">display</span><span class="o">.</span><span class="n">set_yticklabels</span><span class="p">(</span><span class="n">display</span><span class="o">.</span><span class="n">get_yticklabels</span><span class="p">(),</span> <span class="n">size</span> <span class="o">=</span> <span class="n">plot_dict</span><span class="p">[</span><span class="s2">&quot;yticklabels_size&quot;</span><span class="p">],</span> <span class="n">rotation</span><span class="o">=</span><span class="n">plot_dict</span><span class="p">[</span><span class="s2">&quot;ylabel_rotation&quot;</span><span class="p">])</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">display</span><span class="o">.</span><span class="n">set_yticklabels</span><span class="p">(</span><span class="n">display</span><span class="o">.</span><span class="n">get_yticklabels</span><span class="p">(),</span> <span class="n">size</span> <span class="o">=</span> <span class="n">plot_dict</span><span class="p">[</span><span class="s2">&quot;yticklabels_size&quot;</span><span class="p">],</span> <span class="n">rotation</span><span class="o">=</span><span class="n">plot_dict</span><span class="p">[</span><span class="s2">&quot;ylabel_rotation&quot;</span><span class="p">])</span>

                <span class="c1"># Set title of subplot</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="n">cap</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="n">plot_dict</span><span class="p">[</span><span class="s2">&quot;fontsize&quot;</span><span class="p">])</span>

                <span class="c1"># If modulus is zero, move onto the new column back to zero</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">axes_y</span> <span class="o">%</span> <span class="n">ncol</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">axes_y</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="ow">or</span> <span class="n">axes_y</span> <span class="o">==</span> <span class="n">ncol</span> <span class="o">-</span> <span class="mi">1</span><span class="p">:</span> 
                    <span class="n">axes_x</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="n">axes_y</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">axes_y</span> <span class="o">+=</span> <span class="mi">1</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># Create new plot for each iteration when not subplot</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="n">plot_dict</span><span class="p">[</span><span class="s2">&quot;figsize&quot;</span><span class="p">])</span>

                <span class="n">plot_title</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">group</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">cap</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">suffix_title</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">if</span> <span class="n">suffix_title</span> <span class="k">else</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">group</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">cap</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="k">if</span> <span class="n">scope</span> <span class="o">==</span> <span class="s2">&quot;regions&quot;</span><span class="p">:</span> <span class="n">display</span> <span class="o">=</span> <span class="n">heatmap</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_outer_product</span><span class="p">[</span><span class="n">group</span><span class="p">][</span><span class="n">cap</span><span class="p">],</span> <span class="n">cmap</span><span class="o">=</span><span class="n">plot_dict</span><span class="p">[</span><span class="s2">&quot;cmap&quot;</span><span class="p">],</span> <span class="n">linewidths</span><span class="o">=</span><span class="n">plot_dict</span><span class="p">[</span><span class="s2">&quot;linewidths&quot;</span><span class="p">],</span> <span class="n">linecolor</span><span class="o">=</span><span class="n">plot_dict</span><span class="p">[</span><span class="s2">&quot;linecolor&quot;</span><span class="p">],</span> 
                                                         <span class="n">xticklabels</span><span class="o">=</span><span class="n">columns</span><span class="p">,</span> <span class="n">yticklabels</span><span class="o">=</span><span class="n">columns</span><span class="p">,</span> <span class="n">cbar_kws</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;shrink&#39;</span><span class="p">:</span> <span class="n">plot_dict</span><span class="p">[</span><span class="s2">&quot;shrink&quot;</span><span class="p">]},</span> <span class="n">annot</span><span class="o">=</span><span class="n">plot_dict</span><span class="p">[</span><span class="s2">&quot;annot&quot;</span><span class="p">],</span> <span class="n">fmt</span><span class="o">=</span><span class="n">plot_dict</span><span class="p">[</span><span class="s2">&quot;fmt&quot;</span><span class="p">],</span>
                                                         <span class="n">edgecolors</span><span class="o">=</span><span class="n">plot_dict</span><span class="p">[</span><span class="s2">&quot;edgecolors&quot;</span><span class="p">],</span> <span class="n">alpha</span><span class="o">=</span><span class="n">plot_dict</span><span class="p">[</span><span class="s2">&quot;alpha&quot;</span><span class="p">],</span> <span class="n">vmin</span><span class="o">=</span><span class="n">plot_dict</span><span class="p">[</span><span class="s2">&quot;vmin&quot;</span><span class="p">],</span> <span class="n">vmax</span><span class="o">=</span><span class="n">plot_dict</span><span class="p">[</span><span class="s2">&quot;vmax&quot;</span><span class="p">])</span>
                <span class="k">else</span><span class="p">:</span> 
                    <span class="k">if</span> <span class="n">plot_dict</span><span class="p">[</span><span class="s2">&quot;hemisphere_labels&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="kc">False</span><span class="p">:</span>
                        <span class="n">display</span> <span class="o">=</span> <span class="n">heatmap</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_outer_product</span><span class="p">[</span><span class="n">group</span><span class="p">][</span><span class="n">cap</span><span class="p">],</span> <span class="n">cmap</span><span class="o">=</span><span class="n">plot_dict</span><span class="p">[</span><span class="s2">&quot;cmap&quot;</span><span class="p">],</span> <span class="n">linewidths</span><span class="o">=</span><span class="n">plot_dict</span><span class="p">[</span><span class="s2">&quot;linewidths&quot;</span><span class="p">],</span> <span class="n">linecolor</span><span class="o">=</span><span class="n">plot_dict</span><span class="p">[</span><span class="s2">&quot;linecolor&quot;</span><span class="p">],</span> 
                                        <span class="n">xticklabels</span><span class="o">=</span><span class="p">[],</span> <span class="n">yticklabels</span><span class="o">=</span><span class="p">[],</span> <span class="n">cbar_kws</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;shrink&#39;</span><span class="p">:</span> <span class="n">plot_dict</span><span class="p">[</span><span class="s2">&quot;shrink&quot;</span><span class="p">]},</span> <span class="n">annot</span><span class="o">=</span><span class="n">plot_dict</span><span class="p">[</span><span class="s2">&quot;annot&quot;</span><span class="p">],</span> <span class="n">fmt</span><span class="o">=</span><span class="n">plot_dict</span><span class="p">[</span><span class="s2">&quot;fmt&quot;</span><span class="p">],</span>
                                        <span class="n">edgecolors</span><span class="o">=</span><span class="n">plot_dict</span><span class="p">[</span><span class="s2">&quot;edgecolors&quot;</span><span class="p">],</span> <span class="n">alpha</span><span class="o">=</span><span class="n">plot_dict</span><span class="p">[</span><span class="s2">&quot;alpha&quot;</span><span class="p">],</span> <span class="n">vmin</span><span class="o">=</span><span class="n">plot_dict</span><span class="p">[</span><span class="s2">&quot;vmin&quot;</span><span class="p">],</span> <span class="n">vmax</span><span class="o">=</span><span class="n">plot_dict</span><span class="p">[</span><span class="s2">&quot;vmax&quot;</span><span class="p">])</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">display</span> <span class="o">=</span> <span class="n">heatmap</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_outer_product</span><span class="p">[</span><span class="n">group</span><span class="p">][</span><span class="n">cap</span><span class="p">],</span> <span class="n">cmap</span><span class="o">=</span><span class="n">plot_dict</span><span class="p">[</span><span class="s2">&quot;cmap&quot;</span><span class="p">],</span> <span class="n">xticklabels</span><span class="o">=</span><span class="p">[],</span> <span class="n">yticklabels</span><span class="o">=</span><span class="p">[],</span> <span class="n">cbar_kws</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;shrink&#39;</span><span class="p">:</span> <span class="n">plot_dict</span><span class="p">[</span><span class="s2">&quot;shrink&quot;</span><span class="p">]},</span> 
                                          <span class="n">annot</span><span class="o">=</span><span class="n">plot_dict</span><span class="p">[</span><span class="s2">&quot;annot&quot;</span><span class="p">],</span> <span class="n">fmt</span><span class="o">=</span><span class="n">plot_dict</span><span class="p">[</span><span class="s2">&quot;fmt&quot;</span><span class="p">],</span> <span class="n">alpha</span><span class="o">=</span><span class="n">plot_dict</span><span class="p">[</span><span class="s2">&quot;alpha&quot;</span><span class="p">],</span> <span class="n">vmin</span><span class="o">=</span><span class="n">plot_dict</span><span class="p">[</span><span class="s2">&quot;vmin&quot;</span><span class="p">],</span> <span class="n">vmax</span><span class="o">=</span><span class="n">plot_dict</span><span class="p">[</span><span class="s2">&quot;vmax&quot;</span><span class="p">])</span>
                    
                    <span class="k">if</span> <span class="n">plot_dict</span><span class="p">[</span><span class="s2">&quot;hemisphere_labels&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="kc">False</span><span class="p">:</span>
                        <span class="n">ticks</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">label</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">labels</span><span class="p">)</span> <span class="k">if</span> <span class="n">label</span><span class="p">]</span>  

                        <span class="n">display</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">(</span><span class="n">ticks</span><span class="p">)</span>  
                        <span class="n">display</span><span class="o">.</span><span class="n">set_xticklabels</span><span class="p">([</span><span class="n">label</span> <span class="k">for</span> <span class="n">label</span> <span class="ow">in</span> <span class="n">labels</span> <span class="k">if</span> <span class="n">label</span><span class="p">])</span> 
                        <span class="n">display</span><span class="o">.</span><span class="n">set_yticks</span><span class="p">(</span><span class="n">ticks</span><span class="p">)</span>  
                        <span class="n">display</span><span class="o">.</span><span class="n">set_yticklabels</span><span class="p">([</span><span class="n">label</span> <span class="k">for</span> <span class="n">label</span> <span class="ow">in</span> <span class="n">labels</span> <span class="k">if</span> <span class="n">label</span><span class="p">])</span> 

                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">n_labels</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_parcel_approach</span><span class="p">[</span><span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_parcel_approach</span><span class="o">.</span><span class="n">keys</span><span class="p">())[</span><span class="mi">0</span><span class="p">]][</span><span class="s2">&quot;nodes&quot;</span><span class="p">])</span>
                        <span class="n">division_line</span> <span class="o">=</span> <span class="n">n_labels</span><span class="o">//</span><span class="mi">2</span>
                        <span class="n">left_hemisphere_tick</span> <span class="o">=</span> <span class="p">(</span><span class="mi">0</span> <span class="o">+</span> <span class="n">division_line</span><span class="p">)</span><span class="o">//</span><span class="mi">2</span>
                        <span class="n">right_hemisphere_tick</span> <span class="o">=</span> <span class="p">(</span><span class="n">division_line</span> <span class="o">+</span> <span class="n">n_labels</span><span class="p">)</span><span class="o">//</span><span class="mi">2</span>

                        <span class="n">display</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">([</span><span class="n">left_hemisphere_tick</span><span class="p">,</span><span class="n">right_hemisphere_tick</span><span class="p">])</span>
                        <span class="n">display</span><span class="o">.</span><span class="n">set_xticklabels</span><span class="p">([</span><span class="s2">&quot;LH&quot;</span><span class="p">,</span> <span class="s2">&quot;RH&quot;</span><span class="p">])</span>
                        <span class="n">display</span><span class="o">.</span><span class="n">set_yticks</span><span class="p">([</span><span class="n">left_hemisphere_tick</span><span class="p">,</span><span class="n">right_hemisphere_tick</span><span class="p">])</span>
                        <span class="n">display</span><span class="o">.</span><span class="n">set_yticklabels</span><span class="p">([</span><span class="s2">&quot;LH&quot;</span><span class="p">,</span> <span class="s2">&quot;RH&quot;</span><span class="p">])</span>
                        
                        <span class="n">plot_dict</span><span class="p">[</span><span class="s2">&quot;linewidths&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">plot_dict</span><span class="p">[</span><span class="s2">&quot;linewidths&quot;</span><span class="p">]</span> <span class="k">if</span> <span class="n">plot_dict</span><span class="p">[</span><span class="s2">&quot;linewidths&quot;</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span> <span class="k">else</span> <span class="mi">1</span>

                        <span class="n">plt</span><span class="o">.</span><span class="n">axhline</span><span class="p">(</span><span class="n">division_line</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">plot_dict</span><span class="p">[</span><span class="s2">&quot;linecolor&quot;</span><span class="p">],</span> <span class="n">linewidth</span><span class="o">=</span><span class="n">plot_dict</span><span class="p">[</span><span class="s2">&quot;linewidths&quot;</span><span class="p">])</span>
                        <span class="n">plt</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="n">division_line</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">plot_dict</span><span class="p">[</span><span class="s2">&quot;linecolor&quot;</span><span class="p">],</span> <span class="n">linewidth</span><span class="o">=</span><span class="n">plot_dict</span><span class="p">[</span><span class="s2">&quot;linewidths&quot;</span><span class="p">])</span>
                
                <span class="c1"># Add border</span>
                <span class="k">if</span> <span class="n">plot_dict</span><span class="p">[</span><span class="s1">&#39;borderwidths&#39;</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">border_length</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_outer_product</span><span class="p">[</span><span class="n">group</span><span class="p">][</span><span class="n">cap</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">if</span> <span class="n">scope</span> <span class="o">==</span> <span class="s2">&quot;regions&quot;</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">_outer_product</span><span class="p">[</span><span class="n">group</span><span class="p">][</span><span class="n">cap</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

                    <span class="n">display</span><span class="o">.</span><span class="n">axhline</span><span class="p">(</span><span class="n">y</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">plot_dict</span><span class="p">[</span><span class="s2">&quot;linecolor&quot;</span><span class="p">],</span><span class="n">linewidth</span><span class="o">=</span><span class="n">plot_dict</span><span class="p">[</span><span class="s2">&quot;borderwidths&quot;</span><span class="p">])</span>
                    <span class="n">display</span><span class="o">.</span><span class="n">axhline</span><span class="p">(</span><span class="n">y</span><span class="o">=</span><span class="n">border_length</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">plot_dict</span><span class="p">[</span><span class="s2">&quot;linecolor&quot;</span><span class="p">],</span><span class="n">linewidth</span><span class="o">=</span><span class="n">plot_dict</span><span class="p">[</span><span class="s2">&quot;borderwidths&quot;</span><span class="p">])</span>
                    <span class="n">display</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">plot_dict</span><span class="p">[</span><span class="s2">&quot;linecolor&quot;</span><span class="p">],</span><span class="n">linewidth</span><span class="o">=</span><span class="n">plot_dict</span><span class="p">[</span><span class="s2">&quot;borderwidths&quot;</span><span class="p">])</span>
                    <span class="n">display</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">border_length</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">plot_dict</span><span class="p">[</span><span class="s2">&quot;linecolor&quot;</span><span class="p">],</span><span class="n">linewidth</span><span class="o">=</span><span class="n">plot_dict</span><span class="p">[</span><span class="s2">&quot;borderwidths&quot;</span><span class="p">])</span>

                <span class="n">display</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="n">plot_title</span><span class="p">,</span> <span class="n">fontdict</span><span class="o">=</span> <span class="p">{</span><span class="s1">&#39;fontsize&#39;</span><span class="p">:</span> <span class="n">plot_dict</span><span class="p">[</span><span class="s2">&quot;fontsize&quot;</span><span class="p">]})</span>

                <span class="n">display</span><span class="o">.</span><span class="n">set_xticklabels</span><span class="p">(</span><span class="n">display</span><span class="o">.</span><span class="n">get_xticklabels</span><span class="p">(),</span> <span class="n">size</span> <span class="o">=</span> <span class="n">plot_dict</span><span class="p">[</span><span class="s2">&quot;xticklabels_size&quot;</span><span class="p">],</span> <span class="n">rotation</span><span class="o">=</span><span class="n">plot_dict</span><span class="p">[</span><span class="s2">&quot;xlabel_rotation&quot;</span><span class="p">])</span>
                <span class="n">display</span><span class="o">.</span><span class="n">set_yticklabels</span><span class="p">(</span><span class="n">display</span><span class="o">.</span><span class="n">get_yticklabels</span><span class="p">(),</span> <span class="n">size</span> <span class="o">=</span> <span class="n">plot_dict</span><span class="p">[</span><span class="s2">&quot;yticklabels_size&quot;</span><span class="p">],</span> <span class="n">rotation</span><span class="o">=</span><span class="n">plot_dict</span><span class="p">[</span><span class="s2">&quot;ylabel_rotation&quot;</span><span class="p">])</span>

                <span class="c1"># Save individual plots</span>
                <span class="k">if</span> <span class="n">output_dir</span><span class="p">:</span>
                    <span class="n">partial_filename</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">group</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">cap</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">suffix_title</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">if</span> <span class="n">suffix_title</span> <span class="k">else</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">group</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">cap</span><span class="si">}</span><span class="s2">&quot;</span>
                    <span class="n">full_filename</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">partial_filename</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="s1">&#39;_&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">_outer_product_heatmap-regions.png&quot;</span> <span class="k">if</span> <span class="n">scope</span> <span class="o">==</span> <span class="s2">&quot;regions&quot;</span> <span class="k">else</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">partial_filename</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="s1">&#39;_&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">_outer_product_heatmap-nodes.png&quot;</span>
                    <span class="n">display</span><span class="o">.</span><span class="n">get_figure</span><span class="p">()</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_dir</span><span class="p">,</span><span class="n">full_filename</span><span class="p">),</span> <span class="n">dpi</span><span class="o">=</span><span class="n">plot_dict</span><span class="p">[</span><span class="s2">&quot;dpi&quot;</span><span class="p">],</span> <span class="n">bbox_inches</span><span class="o">=</span><span class="s1">&#39;tight&#39;</span><span class="p">)</span>
        
        <span class="c1"># Remove subplots with no data</span>
        <span class="k">if</span> <span class="n">subplots</span><span class="p">:</span> <span class="p">[</span><span class="n">fig</span><span class="o">.</span><span class="n">delaxes</span><span class="p">(</span><span class="n">ax</span><span class="p">)</span> <span class="k">for</span> <span class="n">ax</span> <span class="ow">in</span> <span class="n">axes</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">ax</span><span class="o">.</span><span class="n">has_data</span><span class="p">()]</span>

        <span class="c1"># Save subplot</span>
        <span class="k">if</span> <span class="n">subplots</span> <span class="ow">and</span> <span class="n">output_dir</span><span class="p">:</span> 
            <span class="n">partial_filename</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">group</span><span class="si">}</span><span class="s2">_CAPs_</span><span class="si">{</span><span class="n">suffix_title</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">if</span> <span class="n">suffix_title</span> <span class="k">else</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">group</span><span class="si">}</span><span class="s2">_CAPs&quot;</span>
            <span class="n">full_filename</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">partial_filename</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="s1">&#39;_&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">_outer_product_heatmap-regions.png&quot;</span> <span class="k">if</span> <span class="n">scope</span> <span class="o">==</span> <span class="s2">&quot;regions&quot;</span> <span class="k">else</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">partial_filename</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="s1">&#39;_&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">_outer_product_heatmap-nodes.png&quot;</span>
            <span class="n">display</span><span class="o">.</span><span class="n">get_figure</span><span class="p">()</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_dir</span><span class="p">,</span><span class="n">full_filename</span><span class="p">),</span> <span class="n">dpi</span><span class="o">=</span><span class="n">plot_dict</span><span class="p">[</span><span class="s2">&quot;dpi&quot;</span><span class="p">],</span> <span class="n">bbox_inches</span><span class="o">=</span><span class="s1">&#39;tight&#39;</span><span class="p">)</span>    
        
        <span class="c1"># Display figures</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">show_figs</span><span class="p">:</span> <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_generate_heatmap_plots</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">group</span><span class="p">,</span> <span class="n">plot_dict</span><span class="p">,</span> <span class="n">cap_dict</span><span class="p">,</span> <span class="n">columns</span><span class="p">,</span> <span class="n">output_dir</span><span class="p">,</span> <span class="n">suffix_title</span><span class="p">,</span> <span class="n">show_figs</span><span class="p">,</span> <span class="n">scope</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span><span class="o">,</span> <span class="nn">os</span><span class="o">,</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
        <span class="kn">from</span> <span class="nn">seaborn</span> <span class="kn">import</span> <span class="n">heatmap</span>
        
        <span class="c1"># Initialize new grid</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="n">plot_dict</span><span class="p">[</span><span class="s2">&quot;figsize&quot;</span><span class="p">])</span>

        <span class="k">if</span> <span class="n">scope</span> <span class="o">==</span> <span class="s2">&quot;regions&quot;</span><span class="p">:</span> 
            <span class="n">display</span> <span class="o">=</span> <span class="n">heatmap</span><span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">cap_dict</span><span class="p">[</span><span class="n">group</span><span class="p">],</span> <span class="n">index</span><span class="o">=</span><span class="n">columns</span><span class="p">),</span> <span class="n">xticklabels</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">yticklabels</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="n">plot_dict</span><span class="p">[</span><span class="s2">&quot;cmap&quot;</span><span class="p">],</span>
                               <span class="n">linewidths</span><span class="o">=</span><span class="n">plot_dict</span><span class="p">[</span><span class="s2">&quot;linewidths&quot;</span><span class="p">],</span> <span class="n">linecolor</span><span class="o">=</span><span class="n">plot_dict</span><span class="p">[</span><span class="s2">&quot;linecolor&quot;</span><span class="p">],</span> <span class="n">cbar_kws</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;shrink&#39;</span><span class="p">:</span> <span class="n">plot_dict</span><span class="p">[</span><span class="s2">&quot;shrink&quot;</span><span class="p">]},</span> <span class="n">fmt</span><span class="o">=</span><span class="n">plot_dict</span><span class="p">[</span><span class="s2">&quot;fmt&quot;</span><span class="p">],</span>
                               <span class="n">edgecolors</span><span class="o">=</span><span class="n">plot_dict</span><span class="p">[</span><span class="s2">&quot;edgecolors&quot;</span><span class="p">],</span> <span class="n">alpha</span><span class="o">=</span><span class="n">plot_dict</span><span class="p">[</span><span class="s2">&quot;alpha&quot;</span><span class="p">],</span> <span class="n">vmin</span><span class="o">=</span><span class="n">plot_dict</span><span class="p">[</span><span class="s2">&quot;vmin&quot;</span><span class="p">],</span> <span class="n">vmax</span><span class="o">=</span><span class="n">plot_dict</span><span class="p">[</span><span class="s2">&quot;vmax&quot;</span><span class="p">])</span> 
        <span class="k">else</span><span class="p">:</span> 
            <span class="c1"># Create Labels</span>
            <span class="k">if</span> <span class="n">plot_dict</span><span class="p">[</span><span class="s2">&quot;hemisphere_labels&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="kc">False</span><span class="p">:</span>
                <span class="kn">import</span> <span class="nn">collections</span>
                <span class="k">if</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_parcel_approach</span><span class="o">.</span><span class="n">keys</span><span class="p">())[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;Schaefer&quot;</span><span class="p">:</span>
                    <span class="n">frequency_dict</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">collections</span><span class="o">.</span><span class="n">Counter</span><span class="p">([</span><span class="n">names</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot; &quot;</span> <span class="o">+</span> <span class="n">names</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">names</span> <span class="ow">in</span> <span class="p">[</span><span class="n">name</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;_&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">:</span><span class="mi">2</span><span class="p">]</span> <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parcel_approach</span><span class="p">[</span><span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_parcel_approach</span><span class="o">.</span><span class="n">keys</span><span class="p">())[</span><span class="mi">0</span><span class="p">]][</span><span class="s2">&quot;nodes&quot;</span><span class="p">]]]))</span>
                <span class="k">elif</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_parcel_approach</span><span class="o">.</span><span class="n">keys</span><span class="p">())[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;AAL&quot;</span><span class="p">:</span>
                    <span class="n">frequency_dict</span> <span class="o">=</span> <span class="n">collections</span><span class="o">.</span><span class="n">Counter</span><span class="p">([</span><span class="n">name</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;_&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parcel_approach</span><span class="p">[</span><span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_parcel_approach</span><span class="o">.</span><span class="n">keys</span><span class="p">())[</span><span class="mi">0</span><span class="p">]][</span><span class="s2">&quot;nodes&quot;</span><span class="p">]])</span>
                <span class="k">else</span><span class="p">:</span>
                        <span class="n">frequency_dict</span> <span class="o">=</span> <span class="p">{}</span>
                        <span class="k">for</span> <span class="nb">id</span> <span class="ow">in</span> <span class="n">columns</span><span class="p">:</span>
                            <span class="n">hemisphere_id</span> <span class="o">=</span> <span class="s2">&quot;LH&quot;</span> <span class="k">if</span> <span class="nb">id</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;LH &quot;</span><span class="p">)</span> <span class="k">else</span> <span class="s2">&quot;RH&quot;</span>
                            <span class="n">region_id</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;LH |RH &quot;</span><span class="p">,</span> <span class="nb">id</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                            <span class="n">frequency_dict</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="nb">id</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_parcel_approach</span><span class="p">[</span><span class="s2">&quot;Custom&quot;</span><span class="p">][</span><span class="s2">&quot;regions&quot;</span><span class="p">][</span><span class="n">region_id</span><span class="p">][</span><span class="n">hemisphere_id</span><span class="o">.</span><span class="n">lower</span><span class="p">()])})</span>
                <span class="n">names_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">frequency_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
                <span class="n">labels</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;&quot;</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_parcel_approach</span><span class="p">[</span><span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_parcel_approach</span><span class="o">.</span><span class="n">keys</span><span class="p">())[</span><span class="mi">0</span><span class="p">]][</span><span class="s2">&quot;nodes&quot;</span><span class="p">]))]</span>

                <span class="n">starting_value</span> <span class="o">=</span> <span class="mi">0</span>

                <span class="c1"># Iterate through names_list and assign the starting indices corresponding to unique region and hemisphere key</span>
                <span class="k">for</span> <span class="n">num</span><span class="p">,</span> <span class="n">name</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">names_list</span><span class="p">):</span> 
                    <span class="k">if</span> <span class="n">num</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="n">labels</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">name</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="c1"># Shifting to previous frequency of the preceding netwerk to obtain the new starting value of the subsequent region and hemosphere pair</span>
                        <span class="n">starting_value</span> <span class="o">+=</span> <span class="n">frequency_dict</span><span class="p">[</span><span class="n">names_list</span><span class="p">[</span><span class="n">num</span><span class="o">-</span><span class="mi">1</span><span class="p">]]</span> 
                        <span class="n">labels</span><span class="p">[</span><span class="n">starting_value</span><span class="p">]</span> <span class="o">=</span> <span class="n">name</span>

                <span class="n">display</span> <span class="o">=</span> <span class="n">heatmap</span><span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">cap_dict</span><span class="p">[</span><span class="n">group</span><span class="p">],</span> <span class="n">columns</span><span class="o">=</span><span class="n">cap_dict</span><span class="p">[</span><span class="n">group</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">()),</span> <span class="n">xticklabels</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">yticklabels</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="n">plot_dict</span><span class="p">[</span><span class="s2">&quot;cmap&quot;</span><span class="p">],</span> 
                                <span class="n">linewidths</span><span class="o">=</span><span class="n">plot_dict</span><span class="p">[</span><span class="s2">&quot;linewidths&quot;</span><span class="p">],</span> <span class="n">linecolor</span><span class="o">=</span><span class="n">plot_dict</span><span class="p">[</span><span class="s2">&quot;linecolor&quot;</span><span class="p">],</span> <span class="n">cbar_kws</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;shrink&#39;</span><span class="p">:</span> <span class="n">plot_dict</span><span class="p">[</span><span class="s2">&quot;shrink&quot;</span><span class="p">]},</span> <span class="n">annot</span><span class="o">=</span><span class="n">plot_dict</span><span class="p">[</span><span class="s2">&quot;annot&quot;</span><span class="p">],</span> <span class="n">fmt</span><span class="o">=</span><span class="n">plot_dict</span><span class="p">[</span><span class="s2">&quot;fmt&quot;</span><span class="p">],</span>
                                <span class="n">edgecolors</span><span class="o">=</span><span class="n">plot_dict</span><span class="p">[</span><span class="s2">&quot;edgecolors&quot;</span><span class="p">],</span> <span class="n">alpha</span><span class="o">=</span><span class="n">plot_dict</span><span class="p">[</span><span class="s2">&quot;alpha&quot;</span><span class="p">],</span> <span class="n">vmin</span><span class="o">=</span><span class="n">plot_dict</span><span class="p">[</span><span class="s2">&quot;vmin&quot;</span><span class="p">],</span> <span class="n">vmax</span><span class="o">=</span><span class="n">plot_dict</span><span class="p">[</span><span class="s2">&quot;vmax&quot;</span><span class="p">])</span>

                <span class="n">plt</span><span class="o">.</span><span class="n">yticks</span><span class="p">(</span><span class="n">ticks</span><span class="o">=</span><span class="p">[</span><span class="n">pos</span> <span class="k">for</span> <span class="n">pos</span><span class="p">,</span> <span class="n">label</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">labels</span><span class="p">)</span> <span class="k">if</span> <span class="n">label</span><span class="p">],</span> <span class="n">labels</span><span class="o">=</span><span class="n">names_list</span><span class="p">)</span> 

            <span class="k">else</span><span class="p">:</span>
                <span class="n">display</span> <span class="o">=</span> <span class="n">heatmap</span><span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">cap_dict</span><span class="p">[</span><span class="n">group</span><span class="p">],</span> <span class="n">columns</span><span class="o">=</span><span class="n">cap_dict</span><span class="p">[</span><span class="n">group</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">()),</span> <span class="n">xticklabels</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">yticklabels</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="n">plot_dict</span><span class="p">[</span><span class="s2">&quot;cmap&quot;</span><span class="p">],</span> 
                                  <span class="n">cbar_kws</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;shrink&#39;</span><span class="p">:</span> <span class="n">plot_dict</span><span class="p">[</span><span class="s2">&quot;shrink&quot;</span><span class="p">]},</span> <span class="n">annot</span><span class="o">=</span><span class="n">plot_dict</span><span class="p">[</span><span class="s2">&quot;annot&quot;</span><span class="p">],</span> <span class="n">fmt</span><span class="o">=</span><span class="n">plot_dict</span><span class="p">[</span><span class="s2">&quot;fmt&quot;</span><span class="p">],</span> <span class="n">alpha</span><span class="o">=</span><span class="n">plot_dict</span><span class="p">[</span><span class="s2">&quot;alpha&quot;</span><span class="p">],</span> 
                                  <span class="n">vmin</span><span class="o">=</span><span class="n">plot_dict</span><span class="p">[</span><span class="s2">&quot;vmin&quot;</span><span class="p">],</span> <span class="n">vmax</span><span class="o">=</span><span class="n">plot_dict</span><span class="p">[</span><span class="s2">&quot;vmax&quot;</span><span class="p">])</span>
                
                <span class="n">n_labels</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_parcel_approach</span><span class="p">[</span><span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_parcel_approach</span><span class="o">.</span><span class="n">keys</span><span class="p">())[</span><span class="mi">0</span><span class="p">]][</span><span class="s2">&quot;nodes&quot;</span><span class="p">])</span>
                <span class="n">division_line</span> <span class="o">=</span> <span class="n">n_labels</span><span class="o">//</span><span class="mi">2</span>
                <span class="n">left_hemisphere_tick</span> <span class="o">=</span> <span class="p">(</span><span class="mi">0</span> <span class="o">+</span> <span class="n">division_line</span><span class="p">)</span><span class="o">//</span><span class="mi">2</span>
                <span class="n">right_hemisphere_tick</span> <span class="o">=</span> <span class="p">(</span><span class="n">division_line</span> <span class="o">+</span> <span class="n">n_labels</span><span class="p">)</span><span class="o">//</span><span class="mi">2</span>

                <span class="n">display</span><span class="o">.</span><span class="n">set_yticks</span><span class="p">([</span><span class="n">left_hemisphere_tick</span><span class="p">,</span><span class="n">right_hemisphere_tick</span><span class="p">])</span>
                <span class="n">display</span><span class="o">.</span><span class="n">set_yticklabels</span><span class="p">([</span><span class="s2">&quot;LH&quot;</span><span class="p">,</span> <span class="s2">&quot;RH&quot;</span><span class="p">])</span>
                
                <span class="n">plot_dict</span><span class="p">[</span><span class="s2">&quot;linewidths&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">plot_dict</span><span class="p">[</span><span class="s2">&quot;linewidths&quot;</span><span class="p">]</span> <span class="k">if</span> <span class="n">plot_dict</span><span class="p">[</span><span class="s2">&quot;linewidths&quot;</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span> <span class="k">else</span> <span class="mi">1</span>

                <span class="n">plt</span><span class="o">.</span><span class="n">axhline</span><span class="p">(</span><span class="n">division_line</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">plot_dict</span><span class="p">[</span><span class="s2">&quot;linecolor&quot;</span><span class="p">],</span> <span class="n">linewidth</span><span class="o">=</span><span class="n">plot_dict</span><span class="p">[</span><span class="s2">&quot;linewidths&quot;</span><span class="p">])</span>

        <span class="k">if</span> <span class="n">plot_dict</span><span class="p">[</span><span class="s1">&#39;borderwidths&#39;</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">y_length</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">cap_dict</span><span class="p">[</span><span class="n">group</span><span class="p">][</span><span class="nb">list</span><span class="p">(</span><span class="n">cap_dict</span><span class="p">[</span><span class="n">group</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">())[</span><span class="mi">0</span><span class="p">]])</span>

                <span class="n">display</span><span class="o">.</span><span class="n">axhline</span><span class="p">(</span><span class="n">y</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">plot_dict</span><span class="p">[</span><span class="s2">&quot;linecolor&quot;</span><span class="p">],</span><span class="n">linewidth</span><span class="o">=</span><span class="n">plot_dict</span><span class="p">[</span><span class="s2">&quot;borderwidths&quot;</span><span class="p">])</span>
                <span class="n">display</span><span class="o">.</span><span class="n">axhline</span><span class="p">(</span><span class="n">y</span><span class="o">=</span><span class="n">y_length</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">plot_dict</span><span class="p">[</span><span class="s2">&quot;linecolor&quot;</span><span class="p">],</span><span class="n">linewidth</span><span class="o">=</span><span class="n">plot_dict</span><span class="p">[</span><span class="s2">&quot;borderwidths&quot;</span><span class="p">])</span>
                <span class="n">display</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">plot_dict</span><span class="p">[</span><span class="s2">&quot;linecolor&quot;</span><span class="p">],</span><span class="n">linewidth</span><span class="o">=</span><span class="n">plot_dict</span><span class="p">[</span><span class="s2">&quot;borderwidths&quot;</span><span class="p">])</span>
                <span class="n">display</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_caps</span><span class="p">[</span><span class="n">group</span><span class="p">]),</span> <span class="n">color</span><span class="o">=</span><span class="n">plot_dict</span><span class="p">[</span><span class="s2">&quot;linecolor&quot;</span><span class="p">],</span><span class="n">linewidth</span><span class="o">=</span><span class="n">plot_dict</span><span class="p">[</span><span class="s2">&quot;borderwidths&quot;</span><span class="p">])</span>
                
        <span class="n">display</span><span class="o">.</span><span class="n">set_xticklabels</span><span class="p">(</span><span class="n">display</span><span class="o">.</span><span class="n">get_xticklabels</span><span class="p">(),</span> <span class="n">size</span> <span class="o">=</span> <span class="n">plot_dict</span><span class="p">[</span><span class="s2">&quot;xticklabels_size&quot;</span><span class="p">],</span> <span class="n">rotation</span><span class="o">=</span><span class="n">plot_dict</span><span class="p">[</span><span class="s2">&quot;xlabel_rotation&quot;</span><span class="p">])</span>
        <span class="n">display</span><span class="o">.</span><span class="n">set_yticklabels</span><span class="p">(</span><span class="n">display</span><span class="o">.</span><span class="n">get_yticklabels</span><span class="p">(),</span> <span class="n">size</span> <span class="o">=</span> <span class="n">plot_dict</span><span class="p">[</span><span class="s2">&quot;yticklabels_size&quot;</span><span class="p">],</span> <span class="n">rotation</span><span class="o">=</span><span class="n">plot_dict</span><span class="p">[</span><span class="s2">&quot;ylabel_rotation&quot;</span><span class="p">])</span>

        <span class="n">plot_title</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">group</span><span class="si">}</span><span class="s2"> CAPs </span><span class="si">{</span><span class="n">suffix_title</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">if</span> <span class="n">suffix_title</span> <span class="k">else</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">group</span><span class="si">}</span><span class="s2"> CAPs&quot;</span> 
        <span class="n">display</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="n">plot_title</span><span class="p">,</span> <span class="n">fontdict</span><span class="o">=</span> <span class="p">{</span><span class="s1">&#39;fontsize&#39;</span><span class="p">:</span> <span class="n">plot_dict</span><span class="p">[</span><span class="s2">&quot;fontsize&quot;</span><span class="p">]})</span>

        <span class="c1"># Save plots</span>
        <span class="k">if</span> <span class="n">output_dir</span><span class="p">:</span>
            <span class="n">partial_filename</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">group</span><span class="si">}</span><span class="s2">_CAPs_</span><span class="si">{</span><span class="n">suffix_title</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">if</span> <span class="n">suffix_title</span> <span class="k">else</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">group</span><span class="si">}</span><span class="s2">_CAPs&quot;</span>
            <span class="n">full_filename</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">partial_filename</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="s1">&#39;_&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">_heatmap-regions.png&quot;</span> <span class="k">if</span> <span class="n">scope</span> <span class="o">==</span> <span class="s2">&quot;regions&quot;</span> <span class="k">else</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">partial_filename</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="s1">&#39;_&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">_heatmap-nodes.png&quot;</span>
            <span class="n">display</span><span class="o">.</span><span class="n">get_figure</span><span class="p">()</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_dir</span><span class="p">,</span><span class="n">full_filename</span><span class="p">),</span> <span class="n">dpi</span><span class="o">=</span><span class="n">plot_dict</span><span class="p">[</span><span class="s2">&quot;dpi&quot;</span><span class="p">],</span> <span class="n">bbox_inches</span><span class="o">=</span><span class="s1">&#39;tight&#39;</span><span class="p">)</span>    
   
        <span class="c1"># Display figures</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">show_figs</span><span class="p">:</span> <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

<div class="viewcode-block" id="CAP.caps2corr">
<a class="viewcode-back" href="../../../generated/neurocaps.analysis.CAP.html#neurocaps.analysis.CAP.caps2corr">[docs]</a>
    <span class="k">def</span> <span class="nf">caps2corr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">output_dir</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Path</span><span class="p">]</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">suffix_title</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">show_figs</span><span class="p">:</span> <span class="nb">bool</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Generate Correlation Matrix</span>

<span class="sd">        Produces the correlation matrix of all CAPs. If groups were given when the CAP class was initialized, a correlation matrix will be generated for each group. </span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        output_dir: Path or None, default=None</span>
<span class="sd">            Directory to save plots to. The directory will be created if it does not exist. If None, plots will not be saved.</span>
<span class="sd">        suffix_title: str or None, default=None</span>
<span class="sd">            Appended to the title of each plot as well as the name of the saved file if ``output_dir`` is provided.</span>
<span class="sd">        show_figs: bool, default=True</span>
<span class="sd">            Whether to display figures.</span>
<span class="sd">        **kwargs: Dict</span>
<span class="sd">            Keyword arguments used when saving figures. Valid keywords include:</span>

<span class="sd">            - &quot;dpi&quot;: int, default=300</span>
<span class="sd">                Dots per inch for the figure. Default is 300 if ``output_dir`` is provided and ``dpi`` is not specified.</span>
<span class="sd">            - &quot;figsize&quot;: Tuple, default=(8, 6)</span>
<span class="sd">                Size of the figure in inches.</span>
<span class="sd">            - &quot;fontsize&quot;: int, default=14</span>
<span class="sd">                Font size for the title of individual plots or subplots.</span>
<span class="sd">            - &quot;xticklabels_size&quot;: int, default=8</span>
<span class="sd">                Font size for x-axis tick labels.</span>
<span class="sd">            - &quot;yticklabels_size&quot;: int, default=8</span>
<span class="sd">                Font size for y-axis tick labels.</span>
<span class="sd">            - &quot;shrink&quot;: float, default=0.8</span>
<span class="sd">                Fraction by which to shrink the colorbar.</span>
<span class="sd">            - &quot;xlabel_rotation&quot;: int, default=0</span>
<span class="sd">                Rotation angle for x-axis labels.</span>
<span class="sd">            - &quot;ylabel_rotation&quot;: int, default=0</span>
<span class="sd">                Rotation angle for y-axis labels.</span>
<span class="sd">            - &quot;annot&quot;: bool, default=False</span>
<span class="sd">                Add values to each cell.</span>
<span class="sd">            - &quot;fmt&quot;: str, default=&quot;.2g&quot;,</span>
<span class="sd">                Modify how the annotated vales are presented.</span>
<span class="sd">            - &quot;linewidths&quot;: float, default=0</span>
<span class="sd">                Padding between each cell in the plot.</span>
<span class="sd">            - &quot;borderwidths&quot;: float, default=0</span>
<span class="sd">                Width of the border around the plot.</span>
<span class="sd">            - &quot;linecolor&quot;: str, default=&quot;black&quot;</span>
<span class="sd">                Color of the line that seperates each cell.</span>
<span class="sd">            - &quot;edgecolors&quot;: str, default=None</span>
<span class="sd">                Color of the edges.</span>
<span class="sd">            - &quot;alpha&quot;: float, default=None</span>
<span class="sd">                Controls transparancy and ranges from 0 (transparant) to 1 (opaque).</span>
<span class="sd">            - &quot;cmap&quot;: str, Class, or function, default=&quot;coolwarm&quot;</span>
<span class="sd">                Color map for the cells in the plot. For this parameter, you can use premade color palettes or create custom ones.</span>
<span class="sd">                Below is a list of valid options:</span>
<span class="sd">                - Strings to call seaborn&#39;s premade palettes. Refer to seaborn&#39;s documentation for valid options.</span>
<span class="sd">                - Seaborn&#39;s diverging_palette function to generate custom palettes.</span>
<span class="sd">                - Matplotlib&#39;s LinearSegmentedColormap to generate custom palettes.</span>
<span class="sd">                - Other classes or functions compatible with seaborn.</span>
<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        seaborn.heatmap</span>
<span class="sd">            An instance of a seaborn heatmap.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span><span class="o">,</span> <span class="nn">os</span><span class="o">,</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
        <span class="kn">from</span> <span class="nn">seaborn</span> <span class="kn">import</span> <span class="n">heatmap</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="s2">&quot;_caps&quot;</span><span class="p">):</span> <span class="k">raise</span> <span class="ne">AttributeError</span><span class="p">(</span><span class="s2">&quot;Cannot plot caps since `self._caps` attribute does not exist. Run `self.get_caps()` first.&quot;</span><span class="p">)</span>
        
        <span class="c1"># Create plot dictionary</span>
        <span class="n">defaults</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;dpi&quot;</span><span class="p">:</span> <span class="mi">300</span><span class="p">,</span> <span class="s2">&quot;figsize&quot;</span><span class="p">:</span> <span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mi">6</span><span class="p">),</span> <span class="s2">&quot;fontsize&quot;</span><span class="p">:</span> <span class="mi">14</span><span class="p">,</span> <span class="s2">&quot;xticklabels_size&quot;</span><span class="p">:</span> <span class="mi">8</span><span class="p">,</span> <span class="s2">&quot;yticklabels_size&quot;</span><span class="p">:</span> <span class="mi">8</span><span class="p">,</span>
                    <span class="s2">&quot;shrink&quot;</span><span class="p">:</span> <span class="mf">0.8</span><span class="p">,</span> <span class="s2">&quot;xlabel_rotation&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;ylabel_rotation&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;annot&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span> <span class="s2">&quot;linewidths&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> 
                    <span class="s2">&quot;linecolor&quot;</span><span class="p">:</span> <span class="s2">&quot;black&quot;</span><span class="p">,</span> <span class="s2">&quot;cmap&quot;</span><span class="p">:</span> <span class="s2">&quot;coolwarm&quot;</span><span class="p">,</span> <span class="s2">&quot;fmt&quot;</span><span class="p">:</span> <span class="s2">&quot;.2g&quot;</span><span class="p">,</span> <span class="s2">&quot;borderwidths&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;edgecolors&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span> 
                    <span class="s2">&quot;alpha&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">}</span>
        
        <span class="n">plot_dict</span> <span class="o">=</span> <span class="n">_check_kwargs</span><span class="p">(</span><span class="n">defaults</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">group</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_caps</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="c1"># Refresh grid for each iteration</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="n">plot_dict</span><span class="p">[</span><span class="s2">&quot;figsize&quot;</span><span class="p">])</span>

            <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_caps</span><span class="p">[</span><span class="n">group</span><span class="p">])</span>
            <span class="n">display</span> <span class="o">=</span> <span class="n">heatmap</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">corr</span><span class="p">(),</span> <span class="n">xticklabels</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">yticklabels</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="n">plot_dict</span><span class="p">[</span><span class="s2">&quot;cmap&quot;</span><span class="p">],</span> <span class="n">linewidths</span><span class="o">=</span><span class="n">plot_dict</span><span class="p">[</span><span class="s2">&quot;linewidths&quot;</span><span class="p">],</span> <span class="n">linecolor</span><span class="o">=</span><span class="n">plot_dict</span><span class="p">[</span><span class="s2">&quot;linecolor&quot;</span><span class="p">],</span>
                              <span class="n">cbar_kws</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;shrink&#39;</span><span class="p">:</span> <span class="n">plot_dict</span><span class="p">[</span><span class="s2">&quot;shrink&quot;</span><span class="p">]},</span> <span class="n">annot</span><span class="o">=</span><span class="n">plot_dict</span><span class="p">[</span><span class="s2">&quot;annot&quot;</span><span class="p">],</span> <span class="n">fmt</span><span class="o">=</span><span class="n">plot_dict</span><span class="p">[</span><span class="s2">&quot;fmt&quot;</span><span class="p">],</span> <span class="n">edgecolors</span><span class="o">=</span><span class="n">plot_dict</span><span class="p">[</span><span class="s2">&quot;edgecolors&quot;</span><span class="p">],</span> <span class="n">alpha</span><span class="o">=</span><span class="n">plot_dict</span><span class="p">[</span><span class="s2">&quot;alpha&quot;</span><span class="p">])</span> 
            <span class="c1"># Add Border</span>
            <span class="k">if</span> <span class="n">plot_dict</span><span class="p">[</span><span class="s2">&quot;borderwidths&quot;</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">display</span><span class="o">.</span><span class="n">axhline</span><span class="p">(</span><span class="n">y</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">plot_dict</span><span class="p">[</span><span class="s2">&quot;linecolor&quot;</span><span class="p">],</span><span class="n">linewidth</span><span class="o">=</span><span class="n">plot_dict</span><span class="p">[</span><span class="s2">&quot;borderwidths&quot;</span><span class="p">])</span>
                <span class="n">display</span><span class="o">.</span><span class="n">axhline</span><span class="p">(</span><span class="n">y</span><span class="o">=</span><span class="n">df</span><span class="o">.</span><span class="n">corr</span><span class="p">()</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="n">plot_dict</span><span class="p">[</span><span class="s2">&quot;linecolor&quot;</span><span class="p">],</span><span class="n">linewidth</span><span class="o">=</span><span class="n">plot_dict</span><span class="p">[</span><span class="s2">&quot;borderwidths&quot;</span><span class="p">])</span>
                <span class="n">display</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">plot_dict</span><span class="p">[</span><span class="s2">&quot;linecolor&quot;</span><span class="p">],</span><span class="n">linewidth</span><span class="o">=</span><span class="n">plot_dict</span><span class="p">[</span><span class="s2">&quot;borderwidths&quot;</span><span class="p">])</span>
                <span class="n">display</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">df</span><span class="o">.</span><span class="n">corr</span><span class="p">()</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="n">plot_dict</span><span class="p">[</span><span class="s2">&quot;linecolor&quot;</span><span class="p">],</span><span class="n">linewidth</span><span class="o">=</span><span class="n">plot_dict</span><span class="p">[</span><span class="s2">&quot;borderwidths&quot;</span><span class="p">])</span>
            
            <span class="c1"># Modify label sizes</span>
            <span class="n">display</span><span class="o">.</span><span class="n">set_xticklabels</span><span class="p">(</span><span class="n">display</span><span class="o">.</span><span class="n">get_xticklabels</span><span class="p">(),</span> <span class="n">size</span> <span class="o">=</span> <span class="n">plot_dict</span><span class="p">[</span><span class="s2">&quot;xticklabels_size&quot;</span><span class="p">],</span> <span class="n">rotation</span><span class="o">=</span><span class="n">plot_dict</span><span class="p">[</span><span class="s2">&quot;xlabel_rotation&quot;</span><span class="p">])</span>
            <span class="n">display</span><span class="o">.</span><span class="n">set_yticklabels</span><span class="p">(</span><span class="n">display</span><span class="o">.</span><span class="n">get_yticklabels</span><span class="p">(),</span> <span class="n">size</span> <span class="o">=</span> <span class="n">plot_dict</span><span class="p">[</span><span class="s2">&quot;yticklabels_size&quot;</span><span class="p">],</span> <span class="n">rotation</span><span class="o">=</span><span class="n">plot_dict</span><span class="p">[</span><span class="s2">&quot;ylabel_rotation&quot;</span><span class="p">])</span>
            <span class="c1"># Set plot name</span>
            <span class="n">plot_title</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">group</span><span class="si">}</span><span class="s2"> CAPs Correlation Matrix </span><span class="si">{</span><span class="n">suffix_title</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">if</span> <span class="n">suffix_title</span> <span class="k">else</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">group</span><span class="si">}</span><span class="s2"> CAPs Correlation Matrix&quot;</span> 
            <span class="n">display</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="n">plot_title</span><span class="p">,</span> <span class="n">fontdict</span><span class="o">=</span> <span class="p">{</span><span class="s1">&#39;fontsize&#39;</span><span class="p">:</span> <span class="n">plot_dict</span><span class="p">[</span><span class="s2">&quot;fontsize&quot;</span><span class="p">]})</span>

            <span class="c1"># Display figures</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">show_figs</span><span class="p">:</span> <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            <span class="c1"># Save figure</span>
            <span class="k">if</span> <span class="n">output_dir</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">output_dir</span><span class="p">):</span> <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">output_dir</span><span class="p">)</span>
                <span class="n">full_filename</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">group</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;_&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">_correlation_matrix_</span><span class="si">{</span><span class="n">suffix_title</span><span class="si">}</span><span class="s2">.png&quot;</span> <span class="k">if</span> <span class="n">suffix_title</span> <span class="k">else</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">group</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;_&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">_correlation_matrix.png&quot;</span>
                <span class="n">display</span><span class="o">.</span><span class="n">get_figure</span><span class="p">()</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_dir</span><span class="p">,</span><span class="n">full_filename</span><span class="p">),</span> <span class="n">dpi</span><span class="o">=</span><span class="n">plot_dict</span><span class="p">[</span><span class="s2">&quot;dpi&quot;</span><span class="p">],</span> <span class="n">bbox_inches</span><span class="o">=</span><span class="s1">&#39;tight&#39;</span><span class="p">)</span></div>


<div class="viewcode-block" id="CAP.caps2niftis">
<a class="viewcode-back" href="../../../generated/neurocaps.analysis.CAP.html#neurocaps.analysis.CAP.caps2niftis">[docs]</a>
    <span class="k">def</span> <span class="nf">caps2niftis</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">output_dir</span><span class="p">:</span> <span class="n">Path</span><span class="p">,</span> <span class="n">suffix_file_name</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">fwhm</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Standalone method to convert caps to statistical maps</span>

<span class="sd">        Converts atlas into a stat map by replacing labels with the corresponding from the cluster centroids then saves them as compressed nii files.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        output_dir: str, default=None</span>
<span class="sd">            Directory to save plots to. The directory will be created if it does not exist.</span>
<span class="sd">        suffix_title: str or None, default=None</span>
<span class="sd">            Appended to the name of the saved file.</span>
<span class="sd">        fwhm: float or None, default=None</span>
<span class="sd">            Strength of spatial smoothing to apply (in millimeters) to the statistical map prior to interpolating from MNI152 space to fslr surface space. </span>
<span class="sd">            Note, this can assist with coverage issues in the plot.</span>
<span class="sd">        </span>
<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        Nifti1Image</span>
<span class="sd">            Nifti statistical map.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">import</span> <span class="nn">os</span><span class="o">,</span> <span class="nn">nibabel</span> <span class="k">as</span> <span class="nn">nib</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="s2">&quot;_caps&quot;</span><span class="p">):</span>  <span class="k">raise</span> <span class="ne">AttributeError</span><span class="p">(</span><span class="s2">&quot;Cannot plot caps since `self._caps` attribute does not exist. Run `self.get_caps()` first.&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">output_dir</span><span class="p">):</span> <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">output_dir</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">group</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_caps</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="k">for</span> <span class="n">cap</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_caps</span><span class="p">[</span><span class="n">group</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="n">stat_map</span> <span class="o">=</span> <span class="n">_cap2statmap</span><span class="p">(</span><span class="n">atlas_file</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_parcel_approach</span><span class="p">[</span><span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_parcel_approach</span><span class="o">.</span><span class="n">keys</span><span class="p">())[</span><span class="mi">0</span><span class="p">]][</span><span class="s2">&quot;maps&quot;</span><span class="p">],</span>
                                        <span class="n">cap_vector</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_caps</span><span class="p">[</span><span class="n">group</span><span class="p">][</span><span class="n">cap</span><span class="p">],</span> <span class="n">fwhm</span><span class="o">=</span><span class="n">fwhm</span><span class="p">)</span>

                <span class="n">save_name</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">group</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;_&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">cap</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;-&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;_&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">suffix_file_name</span><span class="si">}</span><span class="s2">.nii.gz&quot;</span> <span class="k">if</span> <span class="n">suffix_file_name</span> <span class="k">else</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">group</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;_&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">cap</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;-&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;_&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">.nii.gz&quot;</span> 
                <span class="n">nib</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">stat_map</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_dir</span><span class="p">,</span><span class="n">save_name</span><span class="p">))</span></div>


<div class="viewcode-block" id="CAP.caps2surf">
<a class="viewcode-back" href="../../../generated/neurocaps.analysis.CAP.html#neurocaps.analysis.CAP.caps2surf">[docs]</a>
    <span class="k">def</span> <span class="nf">caps2surf</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">output_dir</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Path</span><span class="p">]</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">suffix_title</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">show_figs</span><span class="p">:</span> <span class="nb">bool</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">fwhm</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> 
                  <span class="n">fslr_density</span><span class="p">:</span> <span class="nb">str</span><span class="o">=</span><span class="s2">&quot;32k&quot;</span><span class="p">,</span> <span class="n">method</span><span class="p">:</span> <span class="nb">str</span><span class="o">=</span><span class="s2">&quot;linear&quot;</span><span class="p">,</span> <span class="n">save_stat_map</span><span class="p">:</span> <span class="nb">bool</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">fslr_giftis_dict</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">dict</span><span class="p">]</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Project CAPs onto surface plots</span>
<span class="sd">        </span>
<span class="sd">        Converts atlas into a stat map by replacing labels with the corresponding from the cluster centroids then plots on a surface plot.</span>
<span class="sd">        This function uses surfplot for surface plotting.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        output_dir: Path or None, default=None</span>
<span class="sd">            Directory to save plots to. The directory will be created if it does not exist. If None, plots will not be saved. </span>
<span class="sd">        suffix_title: str or None, default=None</span>
<span class="sd">            Appended to the title of each plot as well as the name of the saved file if ``output_dir`` is provided.</span>
<span class="sd">        show_figs: bool, default=True</span>
<span class="sd">            Whether to display figures.</span>
<span class="sd">        fwhm: float or None, defualt=None</span>
<span class="sd">            Strength of spatial smoothing to apply (in millimeters) to the statistical map prior to interpolating from MNI152 space to fslr surface space. </span>
<span class="sd">            Note, this can assist with coverage issues in the plot.</span>
<span class="sd">        fslr_density: str, default=&quot;32k&quot;</span>
<span class="sd">            Density of the fslr surface when converting from MNI152 space to fslr surface. Options are &quot;32k&quot; or &quot;164k&quot;.</span>
<span class="sd">            If using ``fslr_giftis_dict`` options are &quot;4k&quot;, &quot;8k&quot;, &quot;32k&quot;, and &quot;164k&quot;.</span>
<span class="sd">        method: str, default=&quot;linear&quot;</span>
<span class="sd">            Interpolation method to use when converting from MNI152 space to fslr surface. Options are &quot;linear&quot; or &quot;nearest&quot;.</span>
<span class="sd">        save_stat_map: bool, default=False</span>
<span class="sd">            If True, saves the statistical map for each CAP for all groups as a Nifti1Image if ``output_dir`` is provided.</span>
<span class="sd">        fslr_giftis_dict: dict or None, default=None</span>
<span class="sd">            Dictionary specifying precomputed gifti files in fslr space for plotting stat maps. This parameter should be used if the statistical CAP NIfTI files (can be obtained using `caps2niftis`) </span>
<span class="sd">            were converted to GIfTI files using a tool such as Connectome Workbench.The dictionary structure is:</span>

<span class="sd">            ::</span>

<span class="sd">                {</span>
<span class="sd">                    &quot;GroupName&quot;: {</span>
<span class="sd">                        &quot;CAP-Name&quot;: {</span>
<span class="sd">                            &quot;lh&quot;: &quot;path/to/left_hemisphere_gifti&quot;,</span>
<span class="sd">                            &quot;rh&quot;: &quot;path/to/right_hemisphere_gifti&quot;</span>
<span class="sd">                        }</span>
<span class="sd">                    }</span>
<span class="sd">                }</span>
<span class="sd">                </span>
<span class="sd">            GroupName can be &quot;All Subjects&quot; or any specific group name. CAP-Name is the name of the CAP.</span>
<span class="sd">            This parameter allows plotting without re-running the analysis. Initialize the CAP class and use this method if using this parameter.</span>
<span class="sd">        **kwargs : Dict</span>
<span class="sd">            Additional parameters to pass to modify certain plot parameters. Options include:</span>

<span class="sd">            - &quot;dpi&quot;: int, default=300</span>
<span class="sd">                Dots per inch for the plot.</span>
<span class="sd">            - &quot;title_pad&quot;: int, default=-3</span>
<span class="sd">                Padding for the plot title.</span>
<span class="sd">            - &quot;cmap&quot;: str or Class, default=&quot;cold_hot&quot;</span>
<span class="sd">                Colormap to be used for the plot. For this parameter, you can use premade color palettes or create custom ones.</span>
<span class="sd">                Below is a list of valid options:</span>
<span class="sd">                - Strings to call nilearn&#39;s _cmap_d fuction. Refer to documention for nilearn&#39;s _cmap_d for valid palettes.</span>
<span class="sd">                - Matplotlib&#39;s LinearSegmentedColormap to generate custom colormaps.</span>
<span class="sd">            - cbar_kws: Dict, default={&quot;location&quot;: &quot;bottom&quot;, &quot;n_ticks&quot;: 3}</span>
<span class="sd">                Customize colorbar. Refer to ``_add_colorbars`` at https://surfplot.readthedocs.io/en/latest/generated/surfplot.plotting.Plot.html#surfplot.plotting.Plot</span>
<span class="sd">                for valid kwargs. </span>
<span class="sd">            - &quot;alpha&quot;: float, default=1</span>
<span class="sd">                Transparency level of the colorbar.</span>
<span class="sd">            - &quot;zero_transparent&quot;: bool, default=True</span>
<span class="sd">                Turns vertices with a value of 0 transparent.</span>
<span class="sd">            - &quot;as_outline&quot;: bool, default=False</span>
<span class="sd">                Plots only an outline of contiguous vertices with the same value.</span>
<span class="sd">            - &quot;size&quot;: Tuple, default=(500, 400)</span>
<span class="sd">                Size of the plot in pixels.</span>
<span class="sd">            - &quot;layout&quot;: str, default=&quot;grid&quot;</span>
<span class="sd">                Layout of the plot.</span>
<span class="sd">            - &quot;zoom&quot;: float, default=1.5</span>
<span class="sd">                Zoom level for the plot.</span>
<span class="sd">            - &quot;views&quot;: List[str], default=[&quot;lateral&quot;, &quot;medial&quot;]</span>
<span class="sd">                Views to be displayed in the plot.</span>
<span class="sd">            - &quot;brightness&quot;: float, default=0.5</span>
<span class="sd">                Brightness level of the plot.</span>
<span class="sd">            - &quot;figsize&quot;: Tuple or None, default=None</span>
<span class="sd">                Size of the figure.</span>
<span class="sd">            - &quot;scale&quot;: Tuple, default=(2, 2)</span>
<span class="sd">                Scale factors for the plot.</span>
<span class="sd">            - &quot;surface&quot;: str, default=&quot;inflated&quot;</span>
<span class="sd">                The surface atlas that is used for plotting. Options are &quot;inflated&quot; or &quot;veryinflated&quot;</span>
<span class="sd">            - &quot;color_range&quot;: Tuple or None, default=None</span>
<span class="sd">                The minimum and maximum value to display in plots. For instance, (-1,1) where minimum</span>
<span class="sd">                value is first. If None, the minimum and maximum values from the image will be used.</span>
<span class="sd">            </span>
<span class="sd">            Please refer to surfplot&#39;s documentation for specifics: </span>
<span class="sd">            https://surfplot.readthedocs.io/en/latest/generated/surfplot.plotting.Plot.html#surfplot.plotting.Plot</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        Nifti1Image</span>
<span class="sd">            Nifti statistical map.</span>
<span class="sd">        surfplot.Plot</span>
<span class="sd">            An instance of a surfplot plot.</span>

<span class="sd">        Note</span>
<span class="sd">        ----</span>
<span class="sd">        Assumes that atlas background label is zero and atlas is in MNI space. Also assumes that the indices from the cluster centroids are related</span>
<span class="sd">        to the atlas by an offset of one. For instance, index 0 of the cluster centroid vector is the first nonzero label, which is assumed to be at the </span>
<span class="sd">        first index of the array in ``sorted(np.unique(atlas_fdata))``.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">import</span> <span class="nn">nibabel</span> <span class="k">as</span> <span class="nn">nib</span><span class="o">,</span> <span class="nn">os</span>
        <span class="kn">from</span> <span class="nn">nilearn.plotting.cm</span> <span class="kn">import</span> <span class="n">_cmap_d</span> 
        <span class="kn">from</span> <span class="nn">neuromaps.transforms</span> <span class="kn">import</span> <span class="n">mni152_to_fslr</span><span class="p">,</span> <span class="n">fslr_to_fslr</span>
        <span class="kn">from</span> <span class="nn">neuromaps.datasets</span> <span class="kn">import</span> <span class="n">fetch_fslr</span>
        <span class="kn">from</span> <span class="nn">surfplot</span> <span class="kn">import</span> <span class="n">Plot</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="s2">&quot;_caps&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">fslr_giftis_dict</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>  <span class="k">raise</span> <span class="ne">AttributeError</span><span class="p">(</span><span class="s2">&quot;Cannot plot caps since `self._caps` attribute does not exist. Run `self.get_caps()` first.&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">output_dir</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">output_dir</span><span class="p">):</span> <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">output_dir</span><span class="p">)</span>

        <span class="c1"># Create plot dictionary</span>
        <span class="n">defaults</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;dpi&quot;</span><span class="p">:</span> <span class="mi">300</span><span class="p">,</span> <span class="s2">&quot;title_pad&quot;</span><span class="p">:</span> <span class="o">-</span><span class="mi">3</span><span class="p">,</span> <span class="s2">&quot;cmap&quot;</span><span class="p">:</span> <span class="s2">&quot;cold_hot&quot;</span><span class="p">,</span> <span class="s2">&quot;cbar_kws&quot;</span><span class="p">:</span>  <span class="p">{</span><span class="s2">&quot;location&quot;</span><span class="p">:</span> <span class="s2">&quot;bottom&quot;</span><span class="p">,</span> <span class="s2">&quot;n_ticks&quot;</span><span class="p">:</span> <span class="mi">3</span><span class="p">},</span> <span class="s2">&quot;size&quot;</span><span class="p">:</span> <span class="p">(</span><span class="mi">500</span><span class="p">,</span> <span class="mi">400</span><span class="p">),</span> <span class="s2">&quot;layout&quot;</span><span class="p">:</span> <span class="s2">&quot;grid&quot;</span><span class="p">,</span> <span class="s2">&quot;zoom&quot;</span><span class="p">:</span> <span class="mf">1.5</span><span class="p">,</span> <span class="s2">&quot;views&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;lateral&quot;</span><span class="p">,</span> <span class="s2">&quot;medial&quot;</span><span class="p">],</span>
                    <span class="s2">&quot;alpha&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;zero_transparent&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span> <span class="s2">&quot;as_outline&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span><span class="s2">&quot;brightness&quot;</span><span class="p">:</span> <span class="mf">0.5</span><span class="p">,</span> <span class="s2">&quot;figsize&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;scale&quot;</span><span class="p">:</span> <span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span> <span class="s2">&quot;surface&quot;</span><span class="p">:</span> <span class="s2">&quot;inflated&quot;</span><span class="p">,</span> <span class="s2">&quot;color_range&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">}</span>

        <span class="n">plot_dict</span> <span class="o">=</span> <span class="n">_check_kwargs</span><span class="p">(</span><span class="n">defaults</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="n">groups</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_caps</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="s2">&quot;_caps&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">fslr_giftis_dict</span> <span class="o">==</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">fslr_giftis_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>

        <span class="k">for</span> <span class="n">group</span> <span class="ow">in</span> <span class="n">groups</span><span class="p">:</span>
            <span class="n">caps</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_caps</span><span class="p">[</span><span class="n">group</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="s2">&quot;_caps&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">fslr_giftis_dict</span> <span class="o">==</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">fslr_giftis_dict</span><span class="p">[</span><span class="n">group</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">cap</span> <span class="ow">in</span> <span class="n">caps</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">fslr_giftis_dict</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">stat_map</span> <span class="o">=</span> <span class="n">_cap2statmap</span><span class="p">(</span><span class="n">atlas_file</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_parcel_approach</span><span class="p">[</span><span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_parcel_approach</span><span class="o">.</span><span class="n">keys</span><span class="p">())[</span><span class="mi">0</span><span class="p">]][</span><span class="s2">&quot;maps&quot;</span><span class="p">],</span>
                                            <span class="n">cap_vector</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_caps</span><span class="p">[</span><span class="n">group</span><span class="p">][</span><span class="n">cap</span><span class="p">],</span> <span class="n">fwhm</span><span class="o">=</span><span class="n">fwhm</span><span class="p">)</span>
                    <span class="n">gii_lh</span><span class="p">,</span> <span class="n">gii_rh</span> <span class="o">=</span> <span class="n">mni152_to_fslr</span><span class="p">(</span><span class="n">stat_map</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="n">method</span><span class="p">,</span> <span class="n">fslr_density</span><span class="o">=</span><span class="n">fslr_density</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">gii_lh</span><span class="p">,</span> <span class="n">gii_rh</span> <span class="o">=</span> <span class="n">fslr_to_fslr</span><span class="p">([</span><span class="n">fslr_giftis_dict</span><span class="p">[</span><span class="n">group</span><span class="p">][</span><span class="n">cap</span><span class="p">][</span><span class="s1">&#39;lh&#39;</span><span class="p">],</span> <span class="n">fslr_giftis_dict</span><span class="p">[</span><span class="n">group</span><span class="p">][</span><span class="n">cap</span><span class="p">][</span><span class="s1">&#39;rh&#39;</span><span class="p">]],</span> <span class="n">target_density</span><span class="o">=</span><span class="n">fslr_density</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="n">method</span><span class="p">)</span>
                <span class="c1"># Code slightly adapted from surfplot example 2</span>
                <span class="n">surfaces</span> <span class="o">=</span> <span class="n">fetch_fslr</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">plot_dict</span><span class="p">[</span><span class="s2">&quot;surface&quot;</span><span class="p">]</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;inflated&quot;</span><span class="p">,</span> <span class="s2">&quot;veryinflated&quot;</span><span class="p">]:</span>
                    <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">plot_dict</span><span class="p">[</span><span class="s1">&#39;surface&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2"> is an invalid option for `surface`. Available options include &#39;inflated&#39; or &#39;verinflated&#39;. Defaulting to &#39;inflated&#39;&quot;</span><span class="p">)</span>
                    <span class="n">plot_dict</span><span class="p">[</span><span class="s2">&quot;surface&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;inflated&quot;</span>
                <span class="n">lh</span><span class="p">,</span> <span class="n">rh</span> <span class="o">=</span> <span class="n">surfaces</span><span class="p">[</span><span class="n">plot_dict</span><span class="p">[</span><span class="s2">&quot;surface&quot;</span><span class="p">]]</span>
                <span class="n">lh</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">lh</span><span class="p">)</span> <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">lh</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="k">else</span> <span class="n">lh</span>
                <span class="n">rh</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">rh</span><span class="p">)</span> <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">rh</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="k">else</span> <span class="n">rh</span>
                <span class="n">sulc_lh</span><span class="p">,</span> <span class="n">sulc_rh</span> <span class="o">=</span> <span class="n">surfaces</span><span class="p">[</span><span class="s1">&#39;sulc&#39;</span><span class="p">]</span>
                <span class="n">sulc_lh</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">sulc_lh</span><span class="p">)</span> <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">sulc_lh</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="k">else</span> <span class="n">sulc_lh</span>
                <span class="n">sulc_rh</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">sulc_rh</span><span class="p">)</span> <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">sulc_rh</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="k">else</span> <span class="n">sulc_rh</span>
                <span class="n">p</span> <span class="o">=</span> <span class="n">Plot</span><span class="p">(</span><span class="n">lh</span><span class="p">,</span> <span class="n">rh</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="n">plot_dict</span><span class="p">[</span><span class="s2">&quot;size&quot;</span><span class="p">],</span> <span class="n">layout</span><span class="o">=</span><span class="n">plot_dict</span><span class="p">[</span><span class="s2">&quot;layout&quot;</span><span class="p">],</span> <span class="n">zoom</span><span class="o">=</span><span class="n">plot_dict</span><span class="p">[</span><span class="s2">&quot;zoom&quot;</span><span class="p">],</span>
                         <span class="n">views</span><span class="o">=</span><span class="n">plot_dict</span><span class="p">[</span><span class="s2">&quot;views&quot;</span><span class="p">],</span> <span class="n">brightness</span><span class="o">=</span><span class="n">plot_dict</span><span class="p">[</span><span class="s2">&quot;brightness&quot;</span><span class="p">])</span>

                <span class="c1"># Add base layer</span>
                <span class="n">p</span><span class="o">.</span><span class="n">add_layer</span><span class="p">({</span><span class="s2">&quot;left&quot;</span><span class="p">:</span> <span class="n">sulc_lh</span><span class="p">,</span> <span class="s2">&quot;right&quot;</span><span class="p">:</span> <span class="n">sulc_rh</span><span class="p">},</span> <span class="n">cmap</span><span class="o">=</span><span class="s2">&quot;binary_r&quot;</span><span class="p">,</span> <span class="n">cbar</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
                
                <span class="c1"># Check cmap</span>
                <span class="n">cmap</span> <span class="o">=</span> <span class="n">_cmap_d</span><span class="p">[</span><span class="n">plot_dict</span><span class="p">[</span><span class="s2">&quot;cmap&quot;</span><span class="p">]]</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">plot_dict</span><span class="p">[</span><span class="s2">&quot;cmap&quot;</span><span class="p">],</span><span class="nb">str</span><span class="p">)</span> <span class="k">else</span> <span class="n">plot_dict</span><span class="p">[</span><span class="s2">&quot;cmap&quot;</span><span class="p">]</span>
                <span class="c1"># Add stat map layer</span>
                <span class="n">p</span><span class="o">.</span><span class="n">add_layer</span><span class="p">({</span><span class="s2">&quot;left&quot;</span><span class="p">:</span> <span class="n">gii_lh</span><span class="p">,</span> <span class="s2">&quot;right&quot;</span><span class="p">:</span> <span class="n">gii_rh</span><span class="p">},</span> <span class="n">cmap</span><span class="o">=</span><span class="n">cmap</span><span class="p">,</span> 
                            <span class="n">alpha</span><span class="o">=</span><span class="n">plot_dict</span><span class="p">[</span><span class="s2">&quot;alpha&quot;</span><span class="p">],</span> <span class="n">color_range</span><span class="o">=</span><span class="n">plot_dict</span><span class="p">[</span><span class="s2">&quot;color_range&quot;</span><span class="p">],</span> <span class="n">zero_transparent</span><span class="o">=</span><span class="n">plot_dict</span><span class="p">[</span><span class="s2">&quot;zero_transparent&quot;</span><span class="p">],</span> <span class="n">as_outline</span><span class="o">=</span><span class="n">plot_dict</span><span class="p">[</span><span class="s2">&quot;as_outline&quot;</span><span class="p">])</span>

                <span class="c1"># Color bar</span>
                <span class="n">fig</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">build</span><span class="p">(</span><span class="n">cbar_kws</span><span class="o">=</span><span class="n">plot_dict</span><span class="p">[</span><span class="s2">&quot;cbar_kws&quot;</span><span class="p">],</span> <span class="n">figsize</span><span class="o">=</span><span class="n">plot_dict</span><span class="p">[</span><span class="s2">&quot;figsize&quot;</span><span class="p">],</span> <span class="n">scale</span><span class="o">=</span><span class="n">plot_dict</span><span class="p">[</span><span class="s2">&quot;scale&quot;</span><span class="p">])</span>
                <span class="n">fig_name</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">group</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">cap</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">suffix_title</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">if</span> <span class="n">suffix_title</span> <span class="k">else</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">group</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">cap</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="n">fig</span><span class="o">.</span><span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="n">fig_name</span><span class="p">,</span> <span class="n">pad</span><span class="o">=</span><span class="n">plot_dict</span><span class="p">[</span><span class="s2">&quot;title_pad&quot;</span><span class="p">])</span>      
                
                <span class="k">if</span> <span class="n">show_figs</span><span class="p">:</span> <span class="n">fig</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
                
                <span class="k">if</span> <span class="n">output_dir</span><span class="p">:</span>
                    <span class="n">save_name</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">group</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;_&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">cap</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;-&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;_&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">suffix_title</span><span class="si">}</span><span class="s2">.png&quot;</span> <span class="k">if</span> <span class="n">suffix_title</span> <span class="k">else</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">group</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;_&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">cap</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;-&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;_&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">.png&quot;</span> 
                    <span class="n">fig</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_dir</span><span class="p">,</span> <span class="n">save_name</span><span class="p">),</span> <span class="n">dpi</span><span class="o">=</span><span class="n">plot_dict</span><span class="p">[</span><span class="s2">&quot;dpi&quot;</span><span class="p">])</span>
                    <span class="c1"># Save stat map</span>
                    <span class="k">if</span> <span class="n">save_stat_map</span><span class="p">:</span> 
                        <span class="n">stat_map_name</span> <span class="o">=</span> <span class="n">save_name</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;.png&quot;</span><span class="p">,</span> <span class="s2">&quot;.nii.gz&quot;</span><span class="p">)</span>
                        <span class="n">nib</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">stat_map</span><span class="p">,</span> <span class="n">stat_map_name</span><span class="p">)</span></div>


<div class="viewcode-block" id="CAP.caps2radar">
<a class="viewcode-back" href="../../../generated/neurocaps.analysis.CAP.html#neurocaps.analysis.CAP.caps2radar">[docs]</a>
    <span class="k">def</span> <span class="nf">caps2radar</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">output_dir</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Path</span><span class="p">]</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">suffix_title</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">show_figs</span><span class="p">:</span> <span class="nb">bool</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">use_scatterpolar</span><span class="p">:</span> <span class="nb">bool</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Generate Radar Plots</span>

<span class="sd">        This method identifies networks/regions (across both hemispheres) in each CAP that show high amplitude (high activation relative to the mean zero if z-scored) and low amplitude (high deactivation relative </span>
<span class="sd">        to the mean zero if z-scored) by using cosine similarity. This is accomplished by extracting the cluster centroids (CAPs), a 1 x ROI vector, and generating a binary vector </span>
<span class="sd">        (a vector 1 x ROI vector consisting of 0&#39;s and 1&#39;s) where 1&#39;s indicate the indices/ROIs (Regions of Interest) in a specific region. For instance, if elements at indices 0, </span>
<span class="sd">        5, and 10 in the cluster centroid are nodes in the Visual Network, then a binary vector is generated where those indices are 1, and all others are 0. This binary vector </span>
<span class="sd">        essentially operates like a 1-dimensional binary mask to capture relevant ROIs in a given region/network.</span>

<span class="sd">        Once, the dot product of the cluster centroid and binary vector is then calculated it is normalized by the product of the norms of the cluster centroid and the binary </span>
<span class="sd">        vector to restrict the range to -1 and 1, hence cosine similarity. For example, with the Schaefer 7-network parcellation, if your analysis has five CAPs, then each cluster </span>
<span class="sd">        centroid (CAP) will be multiplied by seven different binary vectors (where the 1&#39;s represent the nodes in that network).</span>

<span class="sd">        Cosine similarities notably above zero suggest that many nodes in that network/region are highly activating together, cosine similarities around zero suggest that nodes in that </span>
<span class="sd">        network/region are co-activating and deactivating together, and cosine similarities notably below zero suggest that many nodes in that network/region are deactivating together.</span>

<span class="sd">        This method is a useful quantitative method to characterize CAPs based on nodes in region/networks that display high co-activation or high co-deactivation. For instance, if </span>
<span class="sd">        the dorsal attention network (DAN) has the highest cosine similarity and the ventral attention network (VAN) has a lowest cosine similarity, then that cap can be described as </span>
<span class="sd">        (DAN +/VAN -).</span>

<span class="sd">        **Note, the radar plots only display positive values. The &quot;Low Amplitude&quot; group are negative cosine similarity (below zero); however, the absolute value was taken to </span>
<span class="sd">        make them positive so that the radar plot starts at 0 and direct magnitude comparisons between the &quot;High Amplitude&quot; (positive cosine similarity above zero) and &quot;Low Amplitude&quot; </span>
<span class="sd">        groups are easier.**</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        output_dir: Path or None, default=None</span>
<span class="sd">            Directory to save plots to. The directory will be created if it does not exist. </span>
<span class="sd">        suffix_title: str or None, default=None</span>
<span class="sd">            Appended to the title of each plot as well as the name of the saved file if ``output_dir`` is provided.</span>
<span class="sd">        show_figs: bool, default=True</span>
<span class="sd">            Whether to display figures. If this function detects that it is not being ran in an interactive Python environment,</span>
<span class="sd">            then it uses plotly.offline, creates an html file named &quot;temp-plot.html&quot;, and opens each plot in the default </span>
<span class="sd">            browser.</span>
<span class="sd">        use_scatterpolar: bool=True</span>
<span class="sd">            Uses plotly&#39;s Scatterpolar instead of plotly&#39;s line_polar. The difference is that Scatterpolar shows the scatter</span>
<span class="sd">            dots.</span>
<span class="sd">        **kwargs: Dict</span>
<span class="sd">            Additional parameters to pass to modify certain plot parameters. Options include:</span>

<span class="sd">            - &quot;scale&quot;: int, default=2</span>
<span class="sd">                Controls resolution of image when saving.</span>
<span class="sd">            - &quot;savefig_options&quot;: Dict[str], default={&quot;width&quot;: 3, &quot;height&quot;: 3, &quot;scale&quot;: 1}</span>
<span class="sd">                If ``output_dir`` provided, controls the width (in inches), height (in inches), and scale of the plot.</span>
<span class="sd">                The height and width are multiplied by the dpi.</span>
<span class="sd">            - &quot;height&quot;: int, default=800</span>
<span class="sd">                Height of the plot. Value is multiplied by the dpi when saving.</span>
<span class="sd">            - &quot;width&quot;: int, defualt=1200</span>
<span class="sd">                Width of the plot. Value is multiplied by the dpi when saving.</span>
<span class="sd">            - &quot;line_close&quot;: int, default=True</span>
<span class="sd">                Whether to close the lines</span>
<span class="sd">            - &quot;bgcolor&quot;: str, default=&quot;white&quot;</span>
<span class="sd">                Color of the background</span>
<span class="sd">            - &quot;scattersize&quot;: int, default=8</span>
<span class="sd">                If ``use_scatterpolar=True``, controls the size of the dots.</span>
<span class="sd">            - &quot;connectgaps&quot;: bool, default=True</span>
<span class="sd">                If ``use_scatterpolar=True``, controls if missing values are connected.</span>
<span class="sd">            - &quot;opacity&quot;: float, default=0.5,</span>
<span class="sd">                If ``use_scatterpolar=True``, sets the opacity of the trace.</span>
<span class="sd">            - &quot;fill&quot;: str, default=&quot;none&quot;.</span>
<span class="sd">                If &quot;toself&quot; the are of the dots and within the boundaries of the line will be filled.</span>
<span class="sd">            - &quot;radialaxis&quot;: dict, default={&quot;showline&quot;: False, &quot;linewidth&quot;: 2, &quot;linecolor&quot;: &quot;rgba(0, 0, 0, 0.25)&quot;, &quot;gridcolor&quot;: &quot;rgba(0, 0, 0, 0.25)&quot;, &quot;ticks&quot;: &quot;outside&quot;,&quot;tickfont&quot;: {&quot;size&quot;: 14, &quot;color&quot;: &quot;black&quot;}}</span>
<span class="sd">                Customizes the radial axis. Refer to https://plotly.com/python-api-reference/generated/plotly.graph_objects.layout.polar.radialaxis.html or</span>
<span class="sd">                https://plotly.com/python/reference/layout/polar/ for valid kwargs. Note if there is no &quot;tickvals&quot; key, the plot will only display </span>
<span class="sd">                four ticks - [max_value/4, max_value/2, 3*max_value/4, max_value].</span>
<span class="sd">            - &quot;angularaxis&quot;: Dict[str], default= {&quot;showline&quot;: True, &quot;linewidth&quot;: 2, &quot;linecolor&quot;: &quot;rgba(0, 0, 0, 0.25)&quot;, &quot;gridcolor&quot;: &quot;rgba(0, 0, 0, 0.25)&quot;, &quot;tickfont&quot;: {&quot;size&quot;: 16, &quot;color&quot;: &quot;black&quot;}}</span>
<span class="sd">                Customizes the angular axis. Refer to https://plotly.com/python-api-reference/generated/plotly.graph_objects.layout.polar.angularaxis.html</span>
<span class="sd">                or https://plotly.com/python/reference/layout/polar/ for valid kwargs.</span>
<span class="sd">            - &quot;color_discrete_map&quot;: dict, default={&quot;High Amplitude&quot;: &quot;red&quot;, &quot;Low Amplitude&quot;: &quot;blue&quot;},</span>
<span class="sd">                Change color of the &quot;High Amplitude&quot; and &quot;Low Amplitude&quot; groups. Must use the keys </span>
<span class="sd">                &quot;High Amplitude&quot; and &quot;Low Amplitude&quot; to work.</span>
<span class="sd">            - title_font: dict, default={&quot;family&quot;: &quot;Times New Roman&quot;, &quot;size&quot;: 30, &quot;color&quot;: &quot;black&quot;}</span>
<span class="sd">                Modifies the font of the title. Refer to https://plotly.com/python/reference/layout/ for valid kwargs.</span>
<span class="sd">            - title_x: float, default=0.5</span>
<span class="sd">                Modifies x position of title.</span>
<span class="sd">            - title_y: float, default=None</span>
<span class="sd">                Modifies y position of title.</span>
<span class="sd">            - legend: Dict[str], default={&quot;yanchor&quot;: &quot;top&quot;, &quot;xanchor&quot;: &quot;left&quot;, &quot;y&quot;: 0.99, &quot;x&quot;: 0.01, &quot;title_font_family&quot;: &quot;Times New Roman&quot;, &quot;font&quot;: {&quot;size&quot;: 12, &quot;color&quot;: &quot;black&quot;}} </span>
<span class="sd">                Customized legend. Refer to https://plotly.com/python/reference/layout/ for valid kwargs.</span>
<span class="sd">            </span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        plotly.express.line_polar</span>
<span class="sd">            An instance of a plotly radar plot.</span>
<span class="sd">            </span>
<span class="sd">        Note</span>
<span class="sd">        -----</span>
<span class="sd">        **To save, the kaleido package is needed, which is a dependency in this package. The kaleido package on Windows seems to only work with plotly if it is a specific version, such as version 0.1.0.post1***</span>

<span class="sd">        References</span>
<span class="sd">        ----------</span>
<span class="sd">        Zhang, R., Yan, W., Manza, P., Shokri-Kojori, E., Demiral, S. B., Schwandt, M., Vines, L., Sotelo, D., Tomasi, D., Giddens, N. T., Wang, G., Diazgranados, N., Momenan, R., &amp; Volkow, N. D. (2023). </span>
<span class="sd">        Disrupted brain state dynamics in opioid and alcohol use disorder: attenuation by nicotine use. Neuropsychopharmacology, 49(5), 876–884. https://doi.org/10.1038/s41386-023-01750-w      </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span><span class="o">,</span> <span class="nn">os</span><span class="o">,</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span><span class="o">,</span> <span class="nn">plotly.express</span> <span class="k">as</span> <span class="nn">px</span><span class="o">,</span> <span class="nn">plotly.graph_objects</span> <span class="k">as</span> <span class="nn">go</span><span class="o">,</span> <span class="nn">plotly.offline</span> <span class="k">as</span> <span class="nn">pyo</span><span class="o">,</span> <span class="nn">sys</span>

        <span class="n">defaults</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;scale&quot;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span> <span class="s2">&quot;height&quot;</span><span class="p">:</span> <span class="mi">800</span><span class="p">,</span> <span class="s2">&quot;width&quot;</span><span class="p">:</span> <span class="mi">1200</span><span class="p">,</span> <span class="s2">&quot;line_close&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span> <span class="s2">&quot;bgcolor&quot;</span><span class="p">:</span> <span class="s2">&quot;white&quot;</span><span class="p">,</span> <span class="s2">&quot;fill&quot;</span><span class="p">:</span> <span class="s2">&quot;none&quot;</span><span class="p">,</span> <span class="s2">&quot;scattersize&quot;</span><span class="p">:</span> <span class="mi">8</span><span class="p">,</span> <span class="s2">&quot;connectgaps&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span> <span class="s2">&quot;opacity&quot;</span><span class="p">:</span> <span class="mf">0.5</span><span class="p">,</span>
                    <span class="s2">&quot;radialaxis&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;showline&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span> <span class="s2">&quot;linewidth&quot;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span> <span class="s2">&quot;linecolor&quot;</span><span class="p">:</span> <span class="s2">&quot;rgba(0, 0, 0, 0.25)&quot;</span><span class="p">,</span> <span class="s2">&quot;gridcolor&quot;</span><span class="p">:</span> <span class="s2">&quot;rgba(0, 0, 0, 0.25)&quot;</span><span class="p">,</span> <span class="s2">&quot;ticks&quot;</span><span class="p">:</span> <span class="s2">&quot;outside&quot;</span><span class="p">,</span> <span class="s2">&quot;tickfont&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;size&quot;</span><span class="p">:</span> <span class="mi">14</span><span class="p">,</span> <span class="s2">&quot;color&quot;</span><span class="p">:</span> <span class="s2">&quot;black&quot;</span><span class="p">}},</span>
                    <span class="s2">&quot;angularaxis&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;showline&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span> <span class="s2">&quot;linewidth&quot;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span> <span class="s2">&quot;linecolor&quot;</span><span class="p">:</span> <span class="s2">&quot;rgba(0, 0, 0, 0.25)&quot;</span><span class="p">,</span> <span class="s2">&quot;gridcolor&quot;</span><span class="p">:</span> <span class="s2">&quot;rgba(0, 0, 0, 0.25)&quot;</span><span class="p">,</span> <span class="s2">&quot;tickfont&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;size&quot;</span><span class="p">:</span> <span class="mi">16</span><span class="p">,</span> <span class="s2">&quot;color&quot;</span><span class="p">:</span> <span class="s2">&quot;black&quot;</span><span class="p">}},</span>
                    <span class="s2">&quot;color_discrete_map&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;High Amplitude&quot;</span><span class="p">:</span> <span class="s2">&quot;rgba(255, 0, 0, 1)&quot;</span><span class="p">,</span> <span class="s2">&quot;Low Amplitude&quot;</span><span class="p">:</span> <span class="s2">&quot;rgba(0, 0, 255, 1)&quot;</span><span class="p">},</span> <span class="s2">&quot;title_font&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;family&quot;</span><span class="p">:</span> <span class="s2">&quot;Times New Roman&quot;</span><span class="p">,</span> <span class="s2">&quot;size&quot;</span><span class="p">:</span> <span class="mi">30</span><span class="p">,</span> <span class="s2">&quot;color&quot;</span><span class="p">:</span> <span class="s2">&quot;black&quot;</span><span class="p">},</span> <span class="s2">&quot;title_x&quot;</span><span class="p">:</span> <span class="mf">0.5</span><span class="p">,</span> <span class="s2">&quot;title_y&quot;</span><span class="p">:</span><span class="kc">None</span><span class="p">,</span>
                    <span class="s2">&quot;legend&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;yanchor&quot;</span><span class="p">:</span> <span class="s2">&quot;top&quot;</span><span class="p">,</span> <span class="s2">&quot;xanchor&quot;</span><span class="p">:</span> <span class="s2">&quot;left&quot;</span><span class="p">,</span> <span class="s2">&quot;y&quot;</span><span class="p">:</span> <span class="mf">0.99</span><span class="p">,</span> <span class="s2">&quot;x&quot;</span><span class="p">:</span> <span class="mf">0.01</span><span class="p">,</span> <span class="s2">&quot;title_font_family&quot;</span><span class="p">:</span> <span class="s2">&quot;Times New Roman&quot;</span><span class="p">,</span> <span class="s2">&quot;font&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;size&quot;</span><span class="p">:</span> <span class="mi">12</span><span class="p">,</span> <span class="s2">&quot;color&quot;</span><span class="p">:</span> <span class="s2">&quot;black&quot;</span><span class="p">}}}</span>              

        <span class="n">plot_dict</span> <span class="o">=</span> <span class="n">_check_kwargs</span><span class="p">(</span><span class="n">defaults</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="n">parcellation_name</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parcel_approach</span><span class="o">.</span><span class="n">keys</span><span class="p">())[</span><span class="mi">0</span><span class="p">]</span>

        <span class="c1"># Create radar dict</span>
        <span class="k">for</span> <span class="n">group</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_caps</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">parcellation_name</span> <span class="o">==</span> <span class="s2">&quot;Custom&quot;</span><span class="p">:</span> <span class="n">radar_dict</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;regions&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">parcel_approach</span><span class="p">[</span><span class="n">parcellation_name</span><span class="p">][</span><span class="s2">&quot;regions&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">()}</span>
            <span class="k">else</span><span class="p">:</span> <span class="n">radar_dict</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;regions&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">parcel_approach</span><span class="p">[</span><span class="n">parcellation_name</span><span class="p">][</span><span class="s2">&quot;regions&quot;</span><span class="p">]}</span>
            <span class="k">for</span> <span class="n">cap</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_caps</span><span class="p">[</span><span class="n">group</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="n">cap_vector</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_caps</span><span class="p">[</span><span class="n">group</span><span class="p">][</span><span class="n">cap</span><span class="p">]</span>
                <span class="n">radar_dict</span><span class="p">[</span><span class="n">cap</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">for</span> <span class="n">region</span> <span class="ow">in</span> <span class="n">radar_dict</span><span class="p">[</span><span class="s2">&quot;regions&quot;</span><span class="p">]:</span>
                    <span class="k">if</span> <span class="n">parcellation_name</span> <span class="o">==</span> <span class="s2">&quot;Custom&quot;</span><span class="p">:</span> 
                        <span class="n">indxs</span> <span class="o">=</span> <span class="n">indxs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parcel_approach</span><span class="p">[</span><span class="n">parcellation_name</span><span class="p">][</span><span class="s2">&quot;regions&quot;</span><span class="p">][</span><span class="n">region</span><span class="p">][</span><span class="s2">&quot;lh&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parcel_approach</span><span class="p">[</span><span class="n">parcellation_name</span><span class="p">][</span><span class="s2">&quot;regions&quot;</span><span class="p">][</span><span class="n">region</span><span class="p">][</span><span class="s2">&quot;rh&quot;</span><span class="p">]</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">indxs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">value</span> <span class="k">for</span> <span class="n">value</span><span class="p">,</span> <span class="n">node</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_parcel_approach</span><span class="p">[</span><span class="n">parcellation_name</span><span class="p">][</span><span class="s2">&quot;nodes&quot;</span><span class="p">])</span> <span class="k">if</span> <span class="n">region</span> <span class="ow">in</span> <span class="n">node</span><span class="p">])</span>
                    
                    <span class="c1"># Create mask to set ROIs not in regions to zero and ROIs in regions as 1</span>
                    <span class="n">binary_vector</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">cap_vector</span><span class="p">)</span>
                    <span class="n">binary_vector</span><span class="p">[</span><span class="n">indxs</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>

                    <span class="c1">#Calculate cosine similarity</span>
                    <span class="n">cosine_similarity</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">cap_vector</span><span class="p">,</span> <span class="n">binary_vector</span><span class="p">))</span><span class="o">/</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">cap_vector</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">binary_vector</span><span class="p">))</span>

                    <span class="c1"># Store value in dict</span>
                    <span class="n">radar_dict</span><span class="p">[</span><span class="n">cap</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cosine_similarity</span><span class="p">)</span>

            <span class="c1"># Create dataframe</span>
            <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">radar_dict</span><span class="p">)</span>

            <span class="k">for</span> <span class="n">cap</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="n">df</span><span class="o">.</span><span class="n">columns</span> <span class="o">!=</span> <span class="s2">&quot;regions&quot;</span><span class="p">]:</span>

                <span class="n">groups</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">cap</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="s1">&#39;High Amplitude&#39;</span> <span class="k">if</span> <span class="n">x</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="p">(</span><span class="s1">&#39;Low Amplitude&#39;</span> <span class="k">if</span> <span class="n">x</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">))</span>
                <span class="n">df</span><span class="p">[</span><span class="n">cap</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">cap</span><span class="p">]</span><span class="o">.</span><span class="n">abs</span><span class="p">()</span>

                <span class="k">if</span> <span class="n">use_scatterpolar</span><span class="p">:</span>
                    <span class="c1"># Get high amplitude and low amplitude data</span>
                    <span class="n">regions</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;regions&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
                    <span class="c1"># Set non high amplitude values as nan and low amplitude values as nan</span>
                    <span class="n">high_amplitude_values</span><span class="p">,</span> <span class="n">low_amplitude_values</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">]</span><span class="o">*</span><span class="nb">len</span><span class="p">(</span><span class="n">regions</span><span class="p">)),</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">]</span><span class="o">*</span><span class="nb">len</span><span class="p">(</span><span class="n">regions</span><span class="p">))</span>
                    <span class="n">high_amplitude_values</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">groups</span><span class="o">.</span><span class="n">values</span> <span class="o">==</span> <span class="s2">&quot;High Amplitude&quot;</span><span class="p">)]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">cap</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">groups</span><span class="o">.</span><span class="n">values</span> <span class="o">==</span> <span class="s2">&quot;High Amplitude&quot;</span><span class="p">)]</span>
                    <span class="n">low_amplitude_values</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">groups</span><span class="o">.</span><span class="n">values</span> <span class="o">==</span> <span class="s2">&quot;Low Amplitude&quot;</span><span class="p">)]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">cap</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">groups</span><span class="o">.</span><span class="n">values</span> <span class="o">==</span> <span class="s2">&quot;Low Amplitude&quot;</span><span class="p">)]</span>

                    <span class="c1"># Add high amplitude and low amplitude data as traces</span>
                    <span class="n">fig</span> <span class="o">=</span> <span class="n">go</span><span class="o">.</span><span class="n">Figure</span><span class="p">(</span><span class="n">layout</span><span class="o">=</span><span class="n">go</span><span class="o">.</span><span class="n">Layout</span><span class="p">(</span><span class="n">width</span><span class="o">=</span><span class="n">plot_dict</span><span class="p">[</span><span class="s2">&quot;width&quot;</span><span class="p">],</span> <span class="n">height</span><span class="o">=</span><span class="n">plot_dict</span><span class="p">[</span><span class="s2">&quot;height&quot;</span><span class="p">]))</span>
                    <span class="n">fig</span><span class="o">.</span><span class="n">add_trace</span><span class="p">(</span><span class="n">go</span><span class="o">.</span><span class="n">Scatterpolar</span><span class="p">(</span>
                    <span class="n">r</span><span class="o">=</span><span class="nb">list</span><span class="p">(</span><span class="n">high_amplitude_values</span><span class="p">),</span>
                    <span class="n">theta</span><span class="o">=</span><span class="n">regions</span><span class="p">,</span>
                    <span class="n">connectgaps</span><span class="o">=</span><span class="n">plot_dict</span><span class="p">[</span><span class="s2">&quot;connectgaps&quot;</span><span class="p">],</span>
                    <span class="n">name</span><span class="o">=</span><span class="s2">&quot;High Amplitude&quot;</span><span class="p">,</span>
                    <span class="n">opacity</span><span class="o">=</span><span class="n">plot_dict</span><span class="p">[</span><span class="s2">&quot;opacity&quot;</span><span class="p">],</span>
                    <span class="n">marker</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">color</span><span class="o">=</span><span class="n">plot_dict</span><span class="p">[</span><span class="s2">&quot;color_discrete_map&quot;</span><span class="p">][</span><span class="s2">&quot;High Amplitude&quot;</span><span class="p">],</span> <span class="n">size</span><span class="o">=</span><span class="n">plot_dict</span><span class="p">[</span><span class="s2">&quot;scattersize&quot;</span><span class="p">])))</span>
                    
                    <span class="n">fig</span><span class="o">.</span><span class="n">add_trace</span><span class="p">(</span><span class="n">go</span><span class="o">.</span><span class="n">Scatterpolar</span><span class="p">(</span>
                    <span class="n">r</span><span class="o">=</span><span class="nb">list</span><span class="p">(</span><span class="n">low_amplitude_values</span><span class="p">),</span>
                    <span class="n">theta</span><span class="o">=</span><span class="n">regions</span><span class="p">,</span>
                    <span class="n">name</span><span class="o">=</span><span class="s2">&quot;Low Amplitude&quot;</span><span class="p">,</span>
                    <span class="n">connectgaps</span><span class="o">=</span><span class="n">plot_dict</span><span class="p">[</span><span class="s2">&quot;connectgaps&quot;</span><span class="p">],</span>
                    <span class="n">opacity</span><span class="o">=</span><span class="n">plot_dict</span><span class="p">[</span><span class="s2">&quot;opacity&quot;</span><span class="p">],</span>
                    <span class="n">marker</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">color</span><span class="o">=</span><span class="n">plot_dict</span><span class="p">[</span><span class="s2">&quot;color_discrete_map&quot;</span><span class="p">][</span><span class="s2">&quot;Low Amplitude&quot;</span><span class="p">],</span> <span class="n">size</span><span class="o">=</span><span class="n">plot_dict</span><span class="p">[</span><span class="s2">&quot;scattersize&quot;</span><span class="p">])))</span>

                <span class="k">else</span><span class="p">:</span>
                    <span class="n">fig</span> <span class="o">=</span> <span class="n">px</span><span class="o">.</span><span class="n">line_polar</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">r</span><span class="o">=</span><span class="n">cap</span><span class="p">,</span> <span class="n">theta</span><span class="o">=</span><span class="s2">&quot;regions&quot;</span><span class="p">,</span> <span class="n">line_close</span><span class="o">=</span><span class="n">plot_dict</span><span class="p">[</span><span class="s2">&quot;line_close&quot;</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="n">groups</span><span class="p">,</span> 
                                        <span class="n">width</span><span class="o">=</span><span class="n">plot_dict</span><span class="p">[</span><span class="s2">&quot;width&quot;</span><span class="p">],</span> <span class="n">height</span><span class="o">=</span><span class="n">plot_dict</span><span class="p">[</span><span class="s2">&quot;height&quot;</span><span class="p">],</span>
                                        <span class="n">category_orders</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;regions&quot;</span><span class="p">:</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;regions&quot;</span><span class="p">]},</span> 
                                        <span class="n">color_discrete_map</span> <span class="o">=</span> <span class="n">plot_dict</span><span class="p">[</span><span class="s2">&quot;color_discrete_map&quot;</span><span class="p">])</span>
                
                <span class="n">fig</span><span class="o">.</span><span class="n">update_traces</span><span class="p">(</span><span class="n">fill</span><span class="o">=</span><span class="n">plot_dict</span><span class="p">[</span><span class="s2">&quot;fill&quot;</span><span class="p">])</span>
                
                <span class="c1"># Set max value</span>
                <span class="k">if</span> <span class="s2">&quot;tickvals&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">plot_dict</span><span class="p">[</span><span class="s2">&quot;radialaxis&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="ow">and</span> <span class="s2">&quot;range&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">plot_dict</span><span class="p">[</span><span class="s2">&quot;radialaxis&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                    <span class="n">max_value</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">cap</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
                    <span class="n">plot_dict</span><span class="p">[</span><span class="s2">&quot;radialaxis&quot;</span><span class="p">][</span><span class="s2">&quot;tickvals&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">max_value</span><span class="o">/</span><span class="mi">4</span><span class="p">,</span> <span class="n">max_value</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="o">*</span><span class="n">max_value</span><span class="o">/</span><span class="mi">4</span><span class="p">,</span> <span class="n">max_value</span><span class="p">]</span>

                <span class="n">title_text</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">group</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">cap</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">suffix_title</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">if</span> <span class="n">suffix_title</span> <span class="k">else</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">group</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">cap</span><span class="si">}</span><span class="s2">&quot;</span>

                <span class="c1"># Customize</span>
                <span class="n">fig</span><span class="o">.</span><span class="n">update_layout</span><span class="p">(</span>
                    <span class="n">title</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">text</span><span class="o">=</span><span class="n">title_text</span><span class="p">,</span> <span class="n">font</span><span class="o">=</span><span class="n">plot_dict</span><span class="p">[</span><span class="s2">&quot;title_font&quot;</span><span class="p">]),</span> 
                    <span class="n">title_x</span><span class="o">=</span><span class="n">plot_dict</span><span class="p">[</span><span class="s2">&quot;title_x&quot;</span><span class="p">],</span>
                    <span class="n">title_y</span><span class="o">=</span><span class="n">plot_dict</span><span class="p">[</span><span class="s2">&quot;title_y&quot;</span><span class="p">],</span>
                    <span class="n">legend</span><span class="o">=</span><span class="n">plot_dict</span><span class="p">[</span><span class="s2">&quot;legend&quot;</span><span class="p">],</span>
                    <span class="n">legend_title_text</span><span class="o">=</span><span class="s2">&quot;Cosine Similarity&quot;</span><span class="p">,</span>
                    <span class="n">polar</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span>
                        <span class="n">bgcolor</span><span class="o">=</span><span class="n">plot_dict</span><span class="p">[</span><span class="s2">&quot;bgcolor&quot;</span><span class="p">],</span>
                        <span class="n">radialaxis</span><span class="o">=</span><span class="n">plot_dict</span><span class="p">[</span><span class="s2">&quot;radialaxis&quot;</span><span class="p">],</span>
                        <span class="n">angularaxis</span><span class="o">=</span><span class="n">plot_dict</span><span class="p">[</span><span class="s2">&quot;angularaxis&quot;</span><span class="p">]</span>
                    <span class="p">)</span>
                <span class="p">)</span>

                <span class="k">if</span> <span class="n">show_figs</span><span class="p">:</span> 
                    <span class="k">if</span> <span class="nb">bool</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="n">sys</span><span class="p">,</span> <span class="s1">&#39;ps1&#39;</span><span class="p">,</span> <span class="n">sys</span><span class="o">.</span><span class="n">flags</span><span class="o">.</span><span class="n">interactive</span><span class="p">)):</span> <span class="n">fig</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
                    <span class="k">else</span><span class="p">:</span> <span class="n">pyo</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">fig</span><span class="p">,</span> <span class="n">auto_open</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

                <span class="k">if</span> <span class="n">output_dir</span><span class="p">:</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">output_dir</span><span class="p">):</span> <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">output_dir</span><span class="p">)</span>
                    <span class="n">file_name</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">group</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">cap</span><span class="si">}</span><span class="s2">_radar_</span><span class="si">{</span><span class="n">suffix_title</span><span class="si">}</span><span class="s2">.png&quot;</span> <span class="k">if</span> <span class="n">suffix_title</span> <span class="k">else</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">group</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">cap</span><span class="si">}</span><span class="s2">_radar.png&quot;</span>
                    <span class="n">fig</span><span class="o">.</span><span class="n">write_image</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_dir</span><span class="p">,</span><span class="n">file_name</span><span class="p">),</span> <span class="n">scale</span><span class="o">=</span><span class="n">plot_dict</span><span class="p">[</span><span class="s2">&quot;scale&quot;</span><span class="p">],</span> <span class="n">engine</span><span class="o">=</span><span class="s1">&#39;kaleido&#39;</span><span class="p">)</span></div>
</div>

</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2024, Donisha Smith.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>